{% extends "layouts/merchant_base.html" %}

{% block title %}菜品管理 - 商户后台{% endblock %}

{% block sidebar %}
    <a class="nav-link" href="/merchant/index">
        <i class="fas fa-tachometer-alt"></i> 控制台
    </a>
    <a class="nav-link" href="/merchant/orders">
        <i class="fas fa-shopping-bag"></i> 订单管理
    </a>
    <a class="nav-link active" href="/merchant/dishes">
        <i class="fas fa-utensils"></i> 菜品管理
    </a>
    <a class="nav-link" href="/merchant/statistics">
        <i class="fas fa-chart-bar"></i> 经营统计
    </a>
    <a class="nav-link" href="/merchant/settings">
        <i class="fas fa-cog"></i> 商铺设置
    </a>
{% endblock %}

{% block header %}菜品管理{% endblock %}

{% block username %}{{ merchant_info.merchant_name|default('商户用户') }}{% endblock %}

{% block avatar %}{{ merchant_info.logo|default('/static/uploads/merchant/default.svg') }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>菜品列表</h5>
        <a href="/merchant/dish/add_dish" class="btn btn-primary btn-sm">
            <i class="fas fa-plus mr-1"></i> 添加菜品
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>菜品图片</th>
                        <th>菜品名称</th>
                        <th>价格</th>
                        <th>销量</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="dishesTable">
                    <tr>
                        <td colspan="6" class="text-center text-muted">暂无菜品数据</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="mt-3 d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item disabled"><a class="page-link" href="#">下一页</a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
// 页面加载完成后，获取并显示菜品数据
window.onload = function() {
    loadDishes();
};

// 加载菜品数据
function loadDishes(page = 1, pageSize = 10) {
    fetch(`/api/merchant/dishes?page=${page}&page_size=${pageSize}`)
        .then(response => response.json())
        .then(data => {
            const dishesTable = document.getElementById('dishesTable');
            
            if (data.code === 200 && data.data && data.data.dishes) {
                const dishes = data.data.dishes;
                
                if (dishes.length === 0) {
                    dishesTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无菜品数据</td></tr>';
                    return;
                }
                
                // 填充菜品数据到表格
                let html = '';
                dishes.forEach(dish => {
                    const statusClass = dish.is_shelf ? 'badge-success' : 'badge-secondary';
                    const statusText = dish.is_shelf ? '已上架' : '已下架';
                    const statusAction = dish.is_shelf ? '下架' : '上架';
                    
                    html += `
                    <tr>
                        <td><img src="${'/static/' + dish.img_url || '/static/uploads/dish/default_dish.jpg'}" width="60" height="60" class="rounded"></td>
                        <td>${dish.dish_name}</td>
                        <td>¥${dish.price.toFixed(2)}</td>
                        <td>${dish.sales || 0}</td>
                        <td><span class="badge ${statusClass}" style="color: black;">${statusText}</span></td>
                        <td>
                            <a href="#" class="btn btn-sm btn-info mr-1" onclick="editDish(${dish.id})")>编辑</a>
                            <a href="#" class="btn btn-sm ${dish.is_shelf ? 'btn-warning' : 'btn-secondary'} mr-1" onclick="toggleShelf(${dish.id}, ${!dish.is_shelf})")>${statusAction}</a>
                            <a href="#" class="btn btn-sm btn-danger" onclick="deleteDish(${dish.id})")>删除</a>
                        </td>
                    </tr>
                    `;
                });
                
                dishesTable.innerHTML = html;
                
                // 更新分页
                updatePagination(data.data.total, page, pageSize);
            } else {
                dishesTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">获取菜品数据失败</td></tr>';
            }
        })
        .catch(error => {
            console.error('加载菜品失败:', error);
            document.getElementById('dishesTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败，请刷新页面重试</td></tr>';
        });
}

// 更新分页控件
function updatePagination(total, currentPage, pageSize) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.querySelector('.pagination');
    
    let html = '';
    
    // 上一页
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadDishes(${currentPage - 1}, ${pageSize})">上一页</a></li>`;
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="loadDishes(${i}, ${pageSize})")">${i}</a></li>`;
    }
    
    // 下一页
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadDishes(${currentPage + 1}, ${pageSize})">下一页</a></li>`;
    
    pagination.innerHTML = html;
}

// 编辑菜品
function editDish(dishId) {
    // 获取菜品详情
    fetch(`/api/merchant/dishes/${dishId}`)
        .then(response => response.json())
        .then(data => {
            if (data.code === 200 && data.data) {
                const dish = data.data;
                // 填充表单数据
                document.getElementById('editDishId').value = dish.id;
                document.getElementById('editDishName').value = dish.dish_name;
                document.getElementById('editPrice').value = dish.price;
                document.getElementById('editStock').value = dish.stock;
                document.getElementById('editCategory').value = dish.category;
                document.getElementById('editDescription').value = dish.description || '';
                document.getElementById('editIsShelf').checked = dish.is_shelf;
                
                // 显示模态框
                const editModal = new bootstrap.Modal(document.getElementById('editDishModal'));
                editModal.show();
            } else {
                alert('获取菜品详情失败：' + (data.msg || '未知错误'));
            }
        })
        .catch(error => {
            console.error('获取菜品详情失败:', error);
            alert('网络错误，请稍后重试');
        });
}

// 保存菜品编辑
function saveDishEdit() {
    const dishId = document.getElementById('editDishId').value;
    const dishName = document.getElementById('editDishName').value.trim();
    const price = document.getElementById('editPrice').value;
    const stock = document.getElementById('editStock').value;
    const category = document.getElementById('editCategory').value.trim();
    const description = document.getElementById('editDescription').value.trim();
    const isShelf = document.getElementById('editIsShelf').checked;
    
    // 验证必要字段
    if (!dishName) {
        alert('请输入菜品名称');
        document.getElementById('editDishName').focus();
        return;
    }
    
    if (!price) {
        alert('请输入价格');
        document.getElementById('editPrice').focus();
        return;
    }
    
    if (isNaN(parseFloat(price)) || parseFloat(price) < 0) {
        alert('请输入有效的价格');
        document.getElementById('editPrice').focus();
        return;
    }
    
    if (!category) {
        alert('请选择分类');
        document.getElementById('editCategory').focus();
        return;
    }
    
    // 准备更新数据
    const updateData = {
        dish_name: dishName,
        price: parseFloat(price),
        stock: parseInt(stock) || 0,
        category: category,
        description: description,
        is_shelf: isShelf
    };
    
    // 发送更新请求
    fetch(`/api/merchant/dishes/${dishId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            alert('菜品更新成功');
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('editDishModal')).hide();
            // 重新加载菜品列表
            loadDishes();
        } else {
            alert('更新失败：' + (data.msg || '未知错误'));
        }
    })
    .catch(error => {
        console.error('更新菜品失败:', error);
        alert('网络错误，请稍后重试');
    });
}

// 上下架菜品
function toggleShelf(dishId, isShelf) {
    if (confirm(`确定要${isShelf ? '上架' : '下架'}该菜品吗？`)) {
        fetch(`/api/merchant/dish/${dishId}/shelf`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ shelf: isShelf })
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                alert('操作成功');
                loadDishes(); // 重新加载菜品列表
            } else {
                alert('操作失败：' + (data.msg || '未知错误'));
            }
        })
        .catch(error => {
            console.error('操作失败:', error);
            alert('操作失败，请稍后重试');
        });
    }
}

// 删除菜品
function deleteDish(dishId) {
    if (confirm('确定要删除该菜品吗？此操作不可撤销！')) {
        fetch(`/api/merchant/dish/${dishId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                alert('删除成功');
                loadDishes(); // 重新加载菜品列表
            } else {
                alert('删除失败：' + (data.msg || '未知错误'));
            }
        })
        .catch(error => {
            console.error('删除失败:', error);
            alert('删除失败，请稍后重试');
        });
    }
}
</script>

<!-- 编辑菜品模态框 -->
<div class="modal fade" id="editDishModal" tabindex="-1" aria-labelledby="editDishModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDishModalLabel">编辑菜品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDishForm">
                    <input type="hidden" id="editDishId">
                    <div class="mb-3">
                        <label for="editDishName" class="form-label">菜品名称</label>
                        <input type="text" class="form-control" id="editDishName" placeholder="请输入菜品名称" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label">价格</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="editPrice" placeholder="请输入价格" required>
                    </div>
                    <div class="mb-3">
                        <label for="editStock" class="form-label">库存</label>
                        <input type="number" min="0" class="form-control" id="editStock" placeholder="请输入库存" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">分类</label>
                        <select class="form-select" id="editCategory" required>
                            <option value="">请选择分类</option>
                            <option value="川菜">川菜</option>
                            <option value="粤菜">粤菜</option>
                            <option value="湘菜">湘菜</option>
                            <option value="东北菜">东北菜</option>
                            <option value="西北菜">西北菜</option>
                            <option value="快餐">快餐</option>
                            <option value="火锅">火锅</option>
                            <option value="烧烤">烧烤</option>
                            <option value="面食">面食</option>
                            <option value="甜品">甜品</option>
                            <option value="饮品">饮品</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editDescription" rows="3" placeholder="请输入菜品描述"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editIsShelf">
                        <label class="form-check-label" for="editIsShelf">
                            立即上架
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveDishEdit()">保存修改</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}