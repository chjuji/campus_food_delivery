{% extends "layouts/merchant_base.html" %}

{% block title %}商户后台 - 控制台{% endblock %}

{% block sidebar %}
<a class="nav-link active" href="#">
    <i class="fas fa-tachometer-alt"></i> 控制台
</a>
<a class="nav-link" href="/merchant/orders">
    <i class="fas fa-shopping-bag"></i> 订单管理
</a>
<a class="nav-link" href="/merchant/dishes">
    <i class="fas fa-utensils"></i> 菜品管理
</a>
<a class="nav-link" href="/merchant/statistics">
    <i class="fas fa-chart-bar"></i> 经营统计
</a>
<a class="nav-link" href="/merchant/settings">
    <i class="fas fa-cog"></i> 商铺设置
</a>
{% endblock %}

{% block header %}商户控制台{% endblock %}

{% block username %}{{ merchant_info.merchant_name|default('商户用户') }}{% endblock %}

{% block avatar %}{{ '/static/uploads/merchant/default.svg'}}{% endblock %}

{% block content %}
<div class="row">
    <!-- 统计卡片 -->
    <div class="col-md-3">
        <div class="stat-card bg-primary">
            <i class="fas fa-clipboard-list float-end"></i>
            <div class="stat-label">今日订单</div>
            <h3 id="todayOrders">0</h3>
            <small>较昨日 <span class="text-white opacity-80">+0</span></small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-success">
            <i class="fas fa-yen-sign float-end"></i>
            <div class="stat-label">今日收入</div>
            <h3 id="todayIncome">¥0.00</h3>
            <small>较昨日 <span class="text-white opacity-80">+¥0.00</span></small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-warning">
            <i class="fas fa-clock float-end"></i>
            <div class="stat-label">待处理订单</div>
            <h3 id="pendingOrders">0</h3>
            <small>需要及时处理</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-info">
            <i class="fas fa-store float-end"></i>
            <div class="stat-label">在售菜品</div>
            <h3 id="activeDishes">0</h3>
            <small>共 {{ total_dishes|default(0) }} 个菜品</small>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- 最近订单 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>最近订单</h5>
                <a href="/merchant/orders" class="text-primary text-sm">查看全部</a>
            </div>
            <div class="card-body">
                <div id="recentOrders" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>金额</th>
                                <th>状态</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                            <tr>
                                <td colspan="4" class="text-center text-muted">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 今日销售趋势 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>今日销售趋势</h5>
            </div>
            <div class="card-body">
                <div id="salesChart" style="height: 250px;">
                    <canvas id="chartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- 热销菜品 -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>热销菜品</h5>
                <a href="/merchant/dishes" class="text-primary text-sm">管理菜品</a>
            </div>
            <div class="card-body">
                <div id="popularDishes" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>菜品名称</th>
                                <th>销量</th>
                                <th>销售额</th>
                            </tr>
                        </thead>
                        <tbody id="popularDishesTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let merchantId = 0;
    let ctx = null;
    let salesChart = null;

    $(document).ready(function () {
        const token = localStorage.getItem('merchant_token');
        const merchantInfo = JSON.parse(localStorage.getItem('merchantInfo'));
        if (!token) {
            window.location.href = '/merchant/login';
            return;
        }
        merchantId = merchantInfo.id;

        // 初始化图表
        initChart();

        // 加载数据
        loadStatistics();
        loadRecentOrders();
        loadPopularDishes();

        // 定时刷新数据
        setInterval(loadStatistics, 60000);
        setInterval(loadRecentOrders, 30000);
    });

    // 初始化销售趋势图
    function initChart() {
        const ctx = document.getElementById('chartCanvas');
        if (ctx) {
            // 创建小时标签
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);

            // 创建空的小时销售数据
            const emptyData = Array.from({ length: 24 }, () => 0);

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: '订单数',
                        data: emptyData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '订单数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }
    }

    // 加载统计数据
    function loadStatistics() {
        const token = localStorage.getItem('merchant_token');
        $.ajax({
            url: '/api/merchant/statistics_data',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success && res.data) {
                    const data = res.data;
                    $('#todayOrders').text(data.today_orders || 0);
                    $('#todayIncome').text('¥' + (data.today_income || 0).toFixed(2));
                    $('#pendingOrders').text(data.pending_orders || 0);
                    $('#activeDishes').text(data.active_dishes || 0);

                    // 更新销售趋势图
                    if (data.hourly_orders) {
                        salesChart.data.datasets[0].data = data.hourly_orders;
                        salesChart.update();
                    }
                }
            }
        });
    }

    // 加载最近订单
    function loadRecentOrders() {
        const token = localStorage.getItem('merchant_token');
        $.ajax({
            url: '/api/merchant/orders?limit=5&sort=latest',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success === true) {
                    let html = '';
                    if (res.data.length === 0) {
                        html = '<tr><td colspan="4" class="text-center text-muted">暂无订单</td></tr>';
                    } else {
                        res.data.forEach(order => {
                            const statusClass = {
                                '待支付': 'badge bg-warning text-white',
                                '待接单': 'badge bg-info text-white',
                                '制作中': 'badge bg-primary text-white',
                                '待配送': 'badge bg-info text-white',
                                '配送中': 'badge bg-secondary text-white',
                                '已完成': 'badge bg-success text-white',
                                '已取消': 'badge bg-danger text-white',
                                'pending': 'badge bg-warning text-white',
                                'preparing': 'badge bg-info text-white',
                                'delivering': 'badge bg-primary text-white',
                                'delivered': 'badge bg-success text-white',
                                'cancelled': 'badge bg-danger text-white'
                            }[order.status] || 'badge bg-secondary text-white';

                            html += `
                                <tr>
                                    <td>${order.order_no}</td>
                                    <td>¥${order.pay_amount}</td>
                                    <td><span class="${statusClass}">${order.status}</span></td>
                                    <td>${formatDate(order.create_time)}</td>
                                </tr>
                            `;
                        });
                    }
                    $('#recentOrdersTable').html(html);
                }
            }
        });
    }

    // 加载热销菜品
    function loadPopularDishes() {
        const token = localStorage.getItem('merchant_token');
        $.ajax({
            url: '/api/merchant/dishes/popular?limit=10',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success === true) {
                    let html = '';
                    if (res.data.length === 0) {
                        html = '<tr><td colspan="4" class="text-center text-muted">暂无销售数据</td></tr>';
                    } else {
                        res.data.forEach((dish, index) => {
                            html += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>
                                        <img src="/static/${dish.img_url}" class="rounded me-2" width="30" height="30">
                                        ${dish.dish_name}
                                    </td>
                                    <td>${dish.sales}</td>
                                    <td>¥${(dish.total_amount || 0).toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    }
                    $('#popularDishesTable').html(html);
                }
            }
        });
    }

</script>
{% endblock %}