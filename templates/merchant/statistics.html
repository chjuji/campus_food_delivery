{% extends "layouts/merchant_base.html" %}

{% block title %}经营统计 - 商户后台{% endblock %}

{% block sidebar %}
<a class="nav-link" href="/merchant/index">
    <i class="fas fa-tachometer-alt"></i> 控制台
</a>
<a class="nav-link" href="/merchant/orders">
    <i class="fas fa-shopping-bag"></i> 订单管理
</a>
<a class="nav-link" href="/merchant/dishes">
    <i class="fas fa-utensils"></i> 菜品管理
</a>
<a class="nav-link active" href="/merchant/statistics">
    <i class="fas fa-chart-bar"></i> 经营统计
</a>
<a class="nav-link" href="/merchant/settings">
    <i class="fas fa-cog"></i> 商铺设置
</a>
{% endblock %}

{% block header %}经营统计{% endblock %}

{% block username %}{{ merchant_info.name|default('商户用户') }}{% endblock %}

{% block avatar %}{{ merchant_info.logo|default('/static/uploads/merchant/default.svg') }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>销售趋势图</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" style="height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>热门菜品排行</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>菜品</th>
                                <th>销量</th>
                                <th>销售额</th>
                            </tr>
                        </thead>
                        <tbody id="popularDishesTable">
                            <tr>
                                <td colspan="4" class="text-center text-muted">暂无销售数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>销售数据统计</h5>
        <select id="statisticsRange" class="form-control form-control-sm w-25">
            <option value="1">近1天</option>
            <option value="3">近3天</option>
            <option value="7">近7天</option>
        </select>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card bg-primary">
                    <i class="fas fa-yen-sign float-end"></i>
                    <div class="stat-label">总销售额</div>
                    <h3 id="totalSales">¥0.00</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-success">
                    <i class="fas fa-clipboard-list float-end"></i>
                    <div class="stat-label">总订单数</div>
                    <h3 id="totalOrders">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-warning">
                    <i class="fas fa-shopping-cart float-end"></i>
                    <div class="stat-label">平均订单金额</div>
                    <h3 id="avgOrderAmount">¥0.00</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-info">
                    <i class="fas fa-utensils float-end"></i>
                    <div class="stat-label">售出菜品数</div>
                    <h3 id="totalDishesSold">0</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 页面加载完成后执行
    window.onload = function () {
        initCharts();
        loadStatistics();
        loadPopularDishes();

        // 添加时间范围选择事件监听
        $('#statisticsRange').on('change', function () {
            loadStatistics();
        });
    };

    // 初始化图表
    let salesChart;
    function initCharts() {
        // 销售趋势图配置
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00',
                    '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
                    '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
                    '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'],
                datasets: [
                    {
                        label: '订单数',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '订单数'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '时间'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    // 加载统计数据
    function loadStatistics() {
        const token = localStorage.getItem('merchant_token');
        const days = $('#statisticsRange').val(); // 获取选择的时间范围

        $.ajax({
            url: `/api/merchant/statistics_data?days=${days}`,
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success && res.data) {
                    const data = res.data;

                    // 更新统计卡片
                    $('#totalSales').text('¥' + (data.total_income || 0).toFixed(2));
                    $('#totalOrders').text(data.total_orders || 0);

                    // 计算平均订单金额
                    const avgOrderAmount = data.total_orders > 0 ? data.total_income / data.total_orders : 0;
                    $('#avgOrderAmount').text('¥' + avgOrderAmount.toFixed(2));

                    // 更新售出菜品数
                    $('#totalDishesSold').text(data.total_dishes_sold || 0);
                }
            }
        });

        // 加载销售趋势图数据（当前只支持今日数据）
        $.ajax({
            url: '/api/merchant/statistics_data',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success && res.data) {
                    const data = res.data;

                    // 更新销售趋势图
                    if (data.hourly_orders) {
                        salesChart.data.datasets[0].data = data.hourly_orders;
                        salesChart.update();
                    }
                }
            }
        });
    }

    // 加载热销菜品
    function loadPopularDishes() {
        const token = localStorage.getItem('merchant_token');
        $.ajax({
            url: '/api/merchant/dishes/popular?limit=10',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.success === true) {
                    let html = '';
                    if (res.data.length === 0) {
                        html = '<tr><td colspan="4" class="text-center text-muted">暂无销售数据</td></tr>';
                    } else {
                        res.data.forEach((dish, index) => {
                            html += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>
                                        <img src="/static/${dish.img_url}" class="rounded me-2" width="30" height="30">
                                        ${dish.dish_name}
                                    </td>
                                    <td>售出${dish.sales}</td>
                                    <td>¥${(dish.total_amount || 0).toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    }
                    $('#popularDishesTable').html(html);
                }
            }
        });
    }
</script>
{% endblock %}