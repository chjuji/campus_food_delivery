{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}购物车 - 校内外卖平台{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
<li><a href="/student/index">首页</a></li>
<li><a href="/student/cart" class="active">购物车</a></li>
<li><a href="/student/orders">我的订单</a></li>
<li><a href="/student/profile">个人信息</a></li>
<li><a href="/student/complaints">我的投诉</a></li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5>我的购物车</h5>
    </div>
    <div class="card-body">
        <!-- 购物车列表 -->
        <div id="cartList" class="mb-4">
            <div class="text-center text-muted">购物车为空</div>
        </div>

        <div class="card-footer bg-light p-4">
            <div class="row justify-content-between mb-2">
                <div class="col-6">
                    <div class="text-sm text-muted">商品合计</div>
                    <div class="text-xl font-bold" id="totalPrice">¥0.00</div>
                </div>
            </div>
            <div class="row justify-content-between mb-2">
                <div class="col-6">
                    <div class="text-sm text-muted">配送费</div>
                    <div class="text-sm" id="deliveryFeeDisplay">¥5.00</div>
                </div>
            </div>
            <div id="discountRow" class="row justify-content-between mb-2" style="display: none;">
                <div class="col-6">
                    <div class="text-sm text-muted">优惠券优惠</div>
                    <div class="text-sm"><span id="discountAmount" class="text-danger">-¥0.00</span></div>
                </div>
            </div>
            <div class="row justify-content-between mb-3 mt-3 border-t pt-3">
                <div class="col-6">
                    <div class="text-sm text-muted">最终合计</div>
                    <div class="text-2xl font-bold text-danger" id="finalPrice">¥5.00</div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">收货地址</label>
                <div class="input-group">
                    <input type="text" id="addressInput" class="form-control" placeholder="请选择收货地址" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="selectAddress()">选择地址</button>
                </div>
            </div>

            <!-- <div class="mb-3">
                <label class="form-label">支付方式</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payType" id="payWechat" value="wechat"
                            checked>
                        <label class="form-check-label" for="payWechat">微信支付</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payType" id="payAlipay" value="alipay">
                        <label class="form-check-label" for="payAlipay">支付宝</label>
                    </div>
                </div>
                <input type="hidden" id="payType" value="wechat">
            </div> -->

            <div class="mb-3">
                <label class="form-label">备注</label>
                <textarea class="form-control" id="orderRemark" rows="2" placeholder="如有特殊要求请在此备注"></textarea>
            </div>

            <div class="d-grid gap-2">
                <button id="selectCouponBtn" class="btn btn-outline-primary py-2" onclick="showCouponModal()">
                    选择优惠券
                </button>
                <div id="selectedCouponInfo" class="alert alert-success d-none">
                    <div class="row align-items-center">
                        <div class="col">已选择优惠券：<span id="selectedCouponName"></span></div>
                        <div class="col text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeCoupon()">移除</button>
                        </div>
                    </div>
                </div>
                <button id="payBtn" class="btn btn-danger w-100 py-2" disabled onclick="createOrder()">去支付</button>
            </div>
        </div>

    </div>
</div>

<style>
    /* 优惠券样式 */
    .coupon-item {
        transition: all 0.3s ease;
    }

    .coupon-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .coupon-amount {
        font-size: 1.8rem;
        font-weight: bold;
        color: #dc3545;
    }

    .coupon-condition {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .coupon-name {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 4px;
    }

    .coupon-type {
        font-size: 0.8rem;
        color: #0d6efd;
        margin-bottom: 2px;
    }

    .coupon-merchant {
        font-size: 0.8rem;
        color: #666;
        margin-top: 3px;
    }

    .coupon-expire {
        font-size: 0.8rem;
        color: #888;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block modals %}
<!-- 优惠券选择模态框 -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">选择优惠券</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between items-center">
                        <div class="text-sm text-muted">当前订单金额：<span id="modalTotalPrice"
                                class="text-danger">¥0.00</span></div>
                        <div class="text-sm text-muted">配送费：¥5.00</div>
                    </div>
                </div>
                <div id="couponList" class="mt-4">
                    <!-- 优惠券列表将通过JavaScript动态加载 -->
                    <div class="text-center text-muted py-4">加载中...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 支付确认弹窗 -->
<div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-labelledby="paymentConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentConfirmModalLabel">确认订单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>已购菜品</h6>
                    <div id="confirmDishList" class="mt-2">
                        <!-- 菜品列表将通过JavaScript动态加载 -->
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="text-sm">商品合计</div>
                        <div class="text-sm font-medium" id="confirmTotalPrice">¥0.00</div>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <div class="text-sm">配送费</div>
                        <div class="text-sm" id="confirmDeliveryFee">¥5.00</div>
                    </div>
                    <div id="confirmDiscountRow" class="d-flex justify-content-between mb-2" style="display: none;">
                        <div class="text-sm">优惠券优惠</div>
                        <div class="text-sm text-danger" id="confirmDiscountAmount">-¥0.00</div>
                    </div>
                    <div class="d-flex justify-content-between mt-3 pt-3 border-t">
                        <div class="text-lg font-bold">实付金额</div>
                        <div class="text-lg font-bold text-danger" id="confirmFinalPrice">¥0.00</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                    onclick="cancelPayment()">取消支付</button>
                <button type="button" class="btn btn-danger" onclick="confirmPayment()">确认支付</button>
            </div>
        </div>
    </div>
</div>

<!-- 支付密码悬浮框 -->
<div class="modal fade" id="paymentPasswordModal" tabindex="-1" aria-labelledby="paymentPasswordModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentPasswordModalLabel">输入支付密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"
                    onclick="cancelPasswordPayment()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">支付金额</label>
                    <div class="text-danger fs-4 font-bold" id="paymentAmount">¥0.00</div>
                </div>
                <div class="mb-4">
                    <label for="payPassword" class="form-label">请输入6位支付密码</label>
                    <input type="password" class="form-control" id="payPassword" placeholder="请输入支付密码" maxlength="6"
                        pattern="\d{6}" inputmode="numeric">
                </div>
                <div id="passwordError" class="alert alert-danger d-none">支付密码错误，请重新输入</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cancelPasswordPayment()">取消支付</button>
                <button type="button" class="btn btn-primary" onclick="verifyPaymentPassword()">确认支付</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .cart-item {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
    }

    .dish-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .summary-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .cart-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease;
    }

    .decrease-btn,
    .increase-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .decrease-btn:hover,
    .increase-btn:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* 全屏地址选择模态对话框样式 */
    /* 背景遮罩层 */
    .address-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* 模态对话框容器 */
    .address-modal-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }

    /* 模态对话框头部 */
    .address-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .address-modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 500;
        color: #333;
    }

    .address-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .address-modal-close:hover {
        background-color: #f0f0f0;
        color: #333;
    }

    /* 模态对话框主体 */
    .address-modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
        max-height: calc(80vh - 120px);
    }

    /* 地址列表 */
    .address-list {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* 地址项 */
    .address-item {
        padding: 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        user-select: none;
    }

    /* 地址项鼠标悬停效果 */
    .address-item:hover {
        background-color: #f5f5f5;
        border-color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }

    /* 地址信息 */
    .address-info {
        position: relative;
    }

    .address-info-name {
        font-weight: 500;
        color: #333;
        font-size: 16px;
        margin-bottom: 8px;
    }

    .address-info-detail {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
    }

    /* 地址标签 */
    .address-tag {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    /* 空地址提示 */
    .address-empty {
        text-align: center;
        padding: 40px 0;
        color: #999;
        font-size: 14px;
    }

    /* 确保地址项有完整的点击区域 */
    .address-item {
        cursor: pointer;
    }

    /* 地址项内的文本和元素不干扰点击事件 */
    .address-info * {
        pointer-events: auto;
    }

    /* 模态对话框底部 */
    .address-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* 按钮样式微调 */
    .address-modal-footer .btn {
        padding: 8px 20px;
        font-size: 14px;
        border-radius: 4px;
    }
</style>
<script>
    // 全局变量：配送费
    let currentDeliveryFee = 5.00;

    // 获取配送费
    function getDeliveryFee() {
        $.ajax({
            url: '/api/student/delivery-fee',
            type: 'GET',
            success: function (res) {
                if (res && res.code === 200 && res.data && res.data.delivery_fee !== undefined) {
                    currentDeliveryFee = res.data.delivery_fee;
                    console.log('获取配送费成功：', currentDeliveryFee);
                    // 更新页面上所有显示配送费的地方
                    updateDeliveryFeeDisplay();
                }
            },
            error: function () {
                console.error('获取配送费失败，使用默认值：', currentDeliveryFee);
            }
        });
    }

    // 更新页面上的配送费显示
    function updateDeliveryFeeDisplay() {
        console.log('updateDeliveryFeeDisplay函数被调用');
        console.log('当前配送费:', currentDeliveryFee);
        // 获取当前购物车数据并按商户分组
        let deliveryFee = currentDeliveryFee;
        const currentCart = JSON.parse(localStorage.getItem('currentCart')) || [];
        console.log('当前购物车数据:', currentCart);
        if (currentCart.length > 0) {
            const itemsByMerchant = {};
            currentCart.forEach(item => {
                if (item && item.dish) {
                    const merchantId = item.dish.merchant_id;
                    if (!itemsByMerchant[merchantId]) {
                        itemsByMerchant[merchantId] = [];
                    }
                    itemsByMerchant[merchantId].push(item);
                }
            });
            console.log('按商户分组的数据:', itemsByMerchant);
            // 根据商户数量计算配送费
            const totalMerchants = Object.keys(itemsByMerchant).length;
            console.log('商户数量:', totalMerchants);
            deliveryFee = currentDeliveryFee * totalMerchants;
            console.log('计算后的配送费:', deliveryFee);
        }

        // 更新结算区域的配送费显示
        const formattedFee = deliveryFee.toFixed(2);
        $('#deliveryFeeDisplay').text(`¥${formattedFee}`);
        // 更新优惠券模态框中的配送费显示
        $('#couponModal .text-sm.text-muted:contains(配送费)').text(`配送费：¥${formattedFee}`);
        // 更新确认订单模态框中的配送费显示
        $('#confirmDeliveryFee').text(`¥${formattedFee}`);
    }

    // 页面加载时检查登录状态并初始化
    $(function () {
        // 获取用户信息并验证登录状态
        const token = UserAuthManager.getToken();
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));

        // 如果未登录，跳转到登录页面
        if (!token || !userInfo) {
            window.location.href = '/student/login';
            return;
        }

        // 更新用户信息显示
        if ($('#userName').length) {
            $('#userName').text(userInfo.name);
        }

        // 获取配送费
        getDeliveryFee();

        // 加载购物车数据
        loadCart();

        // 设置当前菜单激活状态
        const currentPath = window.location.pathname;
        $('.sidebar-menu a').each(function () {
            if ($(this).attr('href') === currentPath) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });

        // 初始化优惠券显示
        initCouponDisplay();

        // 检查地址
        const selectedAddress = JSON.parse(localStorage.getItem('selectedAddress')) || null;
        if (selectedAddress) {
            // 构建完整的地址字符串，与confirmAddress函数保持一致
            let fullAddress = selectedAddress.full_address || `${selectedAddress.province}${selectedAddress.city}${selectedAddress.district}${selectedAddress.detail_address}`;

            // 添加联系人信息
            fullAddress += ` (联系人：${selectedAddress.recipient}，电话：${selectedAddress.phone})`;

            $('#addressInput').val(fullAddress);
        }

        // 监听支付方式选择变化
        $('input[name="payType"]').change(function () {
            $('#payType').val($(this).val());
        });

        // 加载存储的备注信息
        const savedRemark = localStorage.getItem('orderRemark');
        if (savedRemark) {
            $('#orderRemark').val(savedRemark);
        }

        // 监听备注输入变化，实时保存到localStorage
        $('#orderRemark').on('input', function () {
            localStorage.setItem('orderRemark', $(this).val());
        });
    });

    // 加载购物车数据
    function loadCart() {
        const token = UserAuthManager.getToken();
        // 添加加载动画
        // $('#cartList').html('<div class="text-center py-4"><div class="spinner-border" role="status"><span class="sr-only">加载中...</span></div></div>');

        $.ajax({
            url: '/api/student/cart',
            type: 'GET',
            // 移除Authorization头，因为后端使用session验证
            success: function (res) {
                if (res && res.code === 200 && res.data) {
                    // 正确处理后端返回的数据结构，购物车数组在res.data.items中
                    const cartItems = res.data.items || [];
                    // 将购物车数据保存到localStorage，以便updateDeliveryFeeDisplay函数使用
                    localStorage.setItem('currentCart', JSON.stringify(cartItems));
                    renderCart(cartItems);
                } else {
                    console.error('获取购物车失败：', res ? res.msg : '未知错误');
                    alert('获取购物车失败，请稍后重试');
                    // 即使获取购物车失败，也更新配送费显示
                    updateDeliveryFeeDisplay();
                }
            },
            error: function () {
                alert('网络错误，无法获取购物车数据');
                // 显示错误状态
                $('#cartList').html('<div class="text-center text-danger py-4">无法加载购物车数据，请稍后重试</div>');
                // API失败时尝试使用localStorage中的数据
                const localCart = localStorage.getItem('currentCart');
                if (localCart) {
                    try {
                        renderCart(JSON.parse(localCart));
                    } catch (e) {
                        console.error('解析本地购物车数据失败：', e);
                    }
                }
                // 即使API失败，也更新配送费显示
                updateDeliveryFeeDisplay();
            }
        });
    }



    // 更新购物车商品数量
    function updateQuantity(cartId, newQuantity) {
        // 数量小于1时直接删除
        if (newQuantity < 1) {
            removeFromCart(cartId);
            return;
        }

        // 添加加载状态
        // const button = event ? $(event.target) : null;
        // if (button) {
        //     const originalText = button.text();
        //     button.prop('disabled', true).text('更新中...');
        // }

        const token = UserAuthManager.getToken();
        $.ajax({
            url: `/api/student/cart/${cartId}`,
            type: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: 'application/json',
            data: JSON.stringify({ quantity: newQuantity }),
            success: function (res) {
                if (res && res.code === 200) {
                    loadCart(); // 刷新购物车
                } else {
                    alert('更新失败：' + (res ? res.msg : '未知错误'));
                }
            },
            error: function () {
                alert('网络错误，无法更新商品数量');
            },
            // complete: function () {
            //     // 恢复按钮状态
            //     if (button) {
            //         button.prop('disabled', false).text(originalText);
            //     }
            // }
        });
    }

    // 从购物车删除商品
    function removeFromCart(cartId) {
        if (!confirm('确定要从购物车删除该商品吗？')) return;

        const token = UserAuthManager.getToken();
        $.ajax({
            url: `/api/student/cart/${cartId}`,
            type: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res && res.code === 200) {
                    // 删除成功后刷新购物车
                    loadCart();
                } else {
                    alert('删除失败：' + (res ? res.msg : '未知错误'));
                }
            },
            error: function () {
                alert('网络错误，无法删除商品');
                // 即使API失败，也从本地移除该商品，保持UI一致性
                try {
                    const currentCart = JSON.parse(localStorage.getItem('currentCart') || '[]');
                    const updatedCart = currentCart.filter(item => item.id !== cartId);
                    localStorage.setItem('currentCart', JSON.stringify(updatedCart));
                    // 刷新购物车
                    loadCart();
                } catch (e) {
                    console.error('从本地购物车删除失败：', e);
                }
            }
        });
    }



    // 提示函数
    function showToast(message, type = 'success') {
        try {
            // 如果Bootstrap Toast组件可用
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                // 检查是否已有toast元素
                let toastElement = document.getElementById('toastNotification');
                if (!toastElement) {
                    // 创建toast元素
                    toastElement = document.createElement('div');
                    toastElement.id = 'toastNotification';
                    toastElement.className = `toast position-fixed top-0 end-0 m-3 text-white ${type === 'error' ? 'bg-danger' : 'bg-success'}`;
                    toastElement.role = 'alert';
                    toastElement.setAttribute('aria-live', 'assertive');
                    toastElement.setAttribute('aria-atomic', 'true');

                    toastElement.innerHTML = `
                        <div class="toast-body">
                            ${message}
                        </div>
                    `;

                    document.body.appendChild(toastElement);
                } else {
                    // 更新现有toast内容和样式
                    toastElement.className = `toast position-fixed top-0 end-0 m-3 text-white ${type === 'error' ? 'bg-danger' : 'bg-success'}`;
                    const bodyElement = toastElement.querySelector('.toast-body');
                    if (bodyElement) {
                        bodyElement.textContent = message;
                    }
                }

                // 显示toast
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            } else {
                // 降级为简单的alert
                console.log(`Toast: ${message}`);
                // 可选：如果需要，也可以使用简单的alert
                // alert(message);
            }
        } catch (e) {
            console.error('显示提示时出错:', e);
        }
    }

    // 显示优惠券模态框
    function showCouponModal() {
        try {
            console.log('开始显示优惠券模态框...');

            // 检查模态框元素是否存在
            const couponModalElement = document.getElementById('couponModal');
            if (!couponModalElement) {
                console.error('优惠券模态框元素不存在');
                if (typeof showToast === 'function') {
                    showToast('模态框未找到', 'error');
                }
                return;
            }

            // 更新模态框中的订单金额
            const modalTotalPriceElement = document.getElementById('modalTotalPrice');
            const totalPriceElement = document.getElementById('totalPrice');
            if (modalTotalPriceElement && totalPriceElement) {
                modalTotalPriceElement.textContent = totalPriceElement.textContent;
                console.log('已更新模态框订单金额:', modalTotalPriceElement.textContent);
            } else {
                console.warn('无法更新模态框订单金额');
            }

            // 加载优惠券数据
            loadCoupons();

            // 显示模态框
            // 先检查是否已有实例
            let modal = bootstrap.Modal.getInstance(couponModalElement);
            if (!modal) {
                modal = new bootstrap.Modal(couponModalElement);
                console.log('创建新的模态框实例');
            }

            // 显示模态框
            modal.show();
            console.log('优惠券模态框已显示');

            // 显示提示
            // if (typeof showToast === 'function') {
            //     showToast('优惠券选择界面已打开');
            // }
        } catch (e) {
            console.error('显示优惠券模态框时发生异常:', e);
            if (typeof showToast === 'function') {
                showToast('打开优惠券失败', 'error');
            }
        }
    }

    // 加载用户可用的优惠券
    function loadCoupons() {
        console.log('开始加载可用优惠券...');

        try {
            // 显示加载状态
            const couponListElement = document.getElementById('couponList');
            if (couponListElement) {
                couponListElement.innerHTML = '<div class="text-center py-5"><i class="fa fa-spinner fa-spin mr-2"></i>正在加载优惠券...</div>';
            }

            // 使用session验证，不再需要Authorization头
            $.ajax({
                url: '/api/student/coupons',
                type: 'GET',
                cache: false,
                dataType: 'json',
                success: function (res) {
                    console.log('优惠券加载响应:', res);

                    // 增强数据格式处理
                    let couponsData = [];
                    if (res && res.code === 200) {
                        if (Array.isArray(res.data)) {
                            couponsData = res.data;
                        } else if (res.data && Array.isArray(res.data.coupons)) {
                            couponsData = res.data.coupons;
                        } else {
                            console.warn('未识别的数据格式');
                        }
                    } else if (Array.isArray(res)) {
                        // 兼容直接返回数组的情况
                        couponsData = res;
                    }

                    console.log('处理后的优惠券数据:', couponsData);

                    // 调用更新后的renderCoupons函数
                    renderCoupons(couponsData);
                },
                error: function (xhr, status, error) {
                    console.error('优惠券加载请求错误:', error);
                    console.log('XHR状态:', xhr.status);
                    console.log('响应文本:', xhr.responseText);

                    if (couponListElement) {
                        couponListElement.innerHTML = '<div class="text-center text-danger py-4">网络错误，无法加载优惠券</div>';
                    }

                    // 显示错误提示
                    if (typeof showToast === 'function') {
                        showToast('加载优惠券失败', 'error');
                    }
                },
                complete: function () {
                    console.log('优惠券加载请求完成');
                }
            });
        } catch (e) {
            console.error('加载优惠券时发生异常:', e);
            if (document.getElementById('couponList')) {
                document.getElementById('couponList').innerHTML = '<div class="text-center text-danger py-4">加载异常</div>';
            }
        }
    }

    // 渲染优惠券列表
    function renderCoupons(coupons) {
        console.log('开始渲染优惠券列表...');
        console.log('传入的优惠券数据:', coupons);

        try {
            // 使用原生DOM操作，清空优惠券列表
            const couponListElement = document.getElementById('couponList');
            if (!couponListElement) {
                console.error('优惠券列表容器不存在');
                return;
            }

            // 清空列表
            couponListElement.innerHTML = '';

            if (!Array.isArray(coupons) || coupons.length === 0) {
                console.log('优惠券列表为空');
                couponListElement.innerHTML = '<div class="text-center text-muted py-4">暂无可用优惠券</div>';
                return;
            }

            let html = '';
            let selectedCoupon = null;
            try {
                selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
            } catch (e) {
                console.error('解析选中优惠券时出错:', e);
                selectedCoupon = null;
            }

            console.log('当前选中的优惠券:', selectedCoupon);

            // 按商家ID计算购物车中每个商家的商品总价
            const merchantTotals = {};
            try {
                const currentCart = JSON.parse(localStorage.getItem('currentCart')) || [];
                currentCart.forEach(item => {
                    if (item && item.dish && item.dish.merchant_id) {
                        const merchantId = item.dish.merchant_id;
                        const itemTotal = item.dish.price * item.quantity;
                        merchantTotals[merchantId] = (merchantTotals[merchantId] || 0) + itemTotal;
                    }
                });
                console.log('按商家ID计算的商品总价:', merchantTotals);
            } catch (e) {
                console.error('计算商家商品总价时出错:', e);
            }

            coupons.forEach(coupon => {
                try {
                    console.log('处理优惠券:', coupon.id, coupon.coupon_name || coupon.name);
                    const isSelected = selectedCoupon && selectedCoupon.id === coupon.id;
                    const validTotalPrice = coupon.min_spend || 0;

                    // 根据优惠券的商家ID计算对应商家的商品总价
                    const couponMerchantId = coupon.merchant_id;
                    const merchantTotal = merchantTotals[couponMerchantId] || 0;

                    // 优惠券是否可用：必须有该商家的商品，且该商家的商品总价满足最低消费要求
                    const hasMerchantItems = merchantTotal > 0;
                    const isAvailable = hasMerchantItems && merchantTotal >= validTotalPrice;

                    console.log(`优惠券 ${coupon.id}: 选中状态=${isSelected}, 可用状态=${isAvailable}, 商家${couponMerchantId}总价=${merchantTotal}, 最低消费=${validTotalPrice}`);

                    html += `
                            <div class="coupon-item p-3 mb-3 border rounded bg-white shadow-sm ${isSelected ? 'border-success bg-success-subtle' : 'border-gray-200'} ${!isAvailable ? 'opacity-50' : ''}" data-id="${coupon.id}">
                                <div class="row align-items-center">
                                    <div class="col-md-3 text-center">
                                        <div class="coupon-amount">${coupon.type === '折扣' ? `${(coupon.discount_amount || coupon.value)}折` : `¥${(coupon.discount_amount || coupon.value)}`}</div>
                                        <div class="coupon-condition">满¥${validTotalPrice}可用</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="coupon-name">${coupon.coupon_name || coupon.name}</div>
                                        <div class="coupon-type">${coupon.type === '折扣' ? '折扣券' : coupon.type === '满减' ? '满减券' : '无门槛券'}</div>
                                        <div class="coupon-merchant">商家: ${coupon.merchant_name || '未知商家'}</div>
                                        <div class="coupon-expire">有效期至: ${coupon.expire_date || '未知'}</div>
                                    </div>
                                    <div class="col-md-3 text-end">
                                    <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-primary'} select-coupon-btn" 
                                        onclick="selectCoupon(${coupon.id}, '${coupon.coupon_name || coupon.name}', ${coupon.discount_amount || coupon.value || 0}, '${coupon.type}', ${coupon.min_spend || 0}, ${coupon.merchant_id})" 
                                        ${!isAvailable ? 'disabled title="未满足最低消费条件或没有对应商家商品"' : ''}>
                                        ${isSelected ? '已选择' : '选择'}
                                    </button>
                                </div>
                                </div>
                            </div>
                        `;
                } catch (e) {
                    console.error('处理单个优惠券时出错:', e, '优惠券数据:', coupon);
                }
            });

            couponListElement.innerHTML = html;
            console.log('优惠券列表渲染完成');
        } catch (e) {
            console.error('渲染优惠券列表时发生异常:', e);
            $('#couponList').html('<div class="text-center text-danger py-4">渲染优惠券失败</div>');
        }
    }

    // 选择地址 - 全屏中心模态对话框实现
    function selectAddress() {
        console.log('selectAddress called');
        // 先关闭已存在的模态框（如果有）
        closeAddressModal();

        // 禁用背景滚动
        $('body').css('overflow', 'hidden');

        // 创建模态框HTML
        const modalHtml = `
        <div id="addressModalOverlay" class="address-modal-overlay" style="display: flex;">
            <div class="address-modal-container" id="addressModalContainer">
                <div class="address-modal-header">
                    <h5 class="address-modal-title">选择收货地址</h5>
                    <button type="button" class="address-modal-close" aria-label="Close" onclick="closeAddressModal()">&times;</button>
                </div>
                <div class="address-modal-body">
                    <div class="address-list" id="addressList">
                        <!-- 地址列表将在这里动态加载 -->
                    </div>
                </div>
                <div class="address-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddressModal()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addNewAddress()">添加新地址</button>
                </div>
            </div>
        </div>`;

        // 检查是否已存在模态框，如果存在则移除
        if ($('#addressModalOverlay').length) {
            $('#addressModalOverlay').remove();
        }

        // 添加到页面
        $(document.body).append(modalHtml);

        // 获取模态框元素
        const modalOverlay = document.getElementById('addressModalOverlay');
        const modalContainer = document.getElementById('addressModalContainer');

        // 添加点击关闭事件，注意阻止事件冒泡
        modalOverlay.addEventListener('click', function (event) {
            // 只有点击遮罩层本身时才关闭，防止点击内容区域也关闭
            if (event.target === modalOverlay) {
                closeAddressModal();
            }
        });

        // 为内容容器添加点击事件，阻止冒泡到遮罩层
        modalContainer.addEventListener('click', function (event) {
            event.stopPropagation();
        });

        // 显示动画
        setTimeout(() => {
            modalOverlay.style.opacity = '1';
            modalContainer.style.transform = 'translateY(0)';
        }, 10);

        // 从后端API获取用户地址列表
        $.ajax({
            url: '/api/student/addresses',
            type: 'GET',
            success: function (res) {
                if (res && res.code === 200 && res.data && Array.isArray(res.data)) {
                    const addresses = res.data;
                    const addressList = document.getElementById('addressList');

                    if (addresses.length === 0) {
                        addressList.innerHTML = '<div class="address-empty">您还没有添加收货地址</div>';
                    } else {
                        // 清空地址列表
                        addressList.innerHTML = '';

                        // 逐个添加地址项，使用数据属性存储地址信息
                        addresses.forEach(addr => {
                            // 优先使用后端组装的full_address，如果没有则自己组装
                            const displayAddress = addr.full_address || `${addr.province}${addr.city}${addr.district}${addr.detail_address}`;

                            // 创建地址项元素
                            const addressItem = document.createElement('div');
                            addressItem.className = 'address-item';
                            addressItem.dataset.addressId = addr.id;
                            addressItem.dataset.addressData = encodeURIComponent(JSON.stringify(addr));

                            // 设置地址项内容
                            addressItem.innerHTML = `
                                <div class="address-info">
                                    <div class="address-info-name">${addr.recipient} ${addr.phone}</div>
                                    <div class="address-info-detail">${displayAddress}</div>
                                    ${addr.is_default ? '<div class="address-tag">默认地址</div>' : ''}
                                </div>
                            `;

                            // 添加点击事件监听器
                            addressItem.addEventListener('click', function () {
                                console.log('Address item clicked:', addr);
                                confirmAddress(addr);
                            });

                            // 添加到地址列表
                            addressList.appendChild(addressItem);
                        });
                    }
                } else {
                    const addressList = document.getElementById('addressList');
                    addressList.innerHTML = `<div class="address-empty">获取地址列表失败：${res ? res.msg : '未知错误'}</div>`;
                }
            },
            error: function () {
                const addressList = document.getElementById('addressList');
                addressList.innerHTML = '<div class="address-empty">网络错误，无法获取地址列表</div>';
            }
        });
    }

    // 关闭地址选择模态对话框
    function closeAddressModal() {
        console.log('closeAddressModal function called');
        const overlay = $('#addressModalOverlay');
        if (overlay.length) {
            console.log('Modal overlay found, hiding modal');
            overlay.fadeOut(200, function () {
                overlay.remove();
                // 恢复背景滚动
                $('body').css('overflow', 'auto');
                console.log('Modal removed and body scrolling restored');
            });
        } else {
            console.error('Modal overlay element not found!');
        }
    }


    // 添加新地址 - 打开模态框
    function addNewAddress() {
        // 关闭地址选择模态框（如果存在）
        if ($('#addressSelectModal').length) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addressSelectModal'));
            if (modal) {
                modal.hide();
            }
        }
        // 重置表单所有字段
        $('#address-id').val('');
        $('#address-name').val('');
        $('#address-phone').val('');
        $('#address-province').val('');
        $('#address-city').val('');
        $('#address-district').val('');
        $('#address-detail').val('');
        $('#address-default').prop('checked', false);

        // 设置模态框标题
        $('#addressModalLabel').text('添加收货地址');

        // 显示模态框
        $('#addressModal').modal('show');
    }

    // 保存地址
    function saveAddress() {
        const id = $('#address-id').val();
        const data = {
            recipient: $('#address-name').val().trim(),
            phone: $('#address-phone').val().trim(),
            province: $('#address-province').val().trim(),
            city: $('#address-city').val().trim(),
            district: $('#address-district').val().trim(),
            detail_address: $('#address-detail').val().trim(),
            is_default: $('#address-default').prop('checked')
        };

        // 简单验证
        if (!data.recipient || !data.phone || !data.province || !data.city || !data.district || !data.detail_address) {
            alert('请填写完整地址信息，包括省份、城市和区县');
            return;
        }

        // 验证手机号码格式
        if (!/^1[3-9]\d{9}$/.test(data.phone)) {
            alert('请输入正确的11位手机号码');
            return;
        }

        // 使用session验证，不再需要Authorization头
        let url = '/api/student/addresses';
        let type = 'POST';

        $.ajax({
            url: url,
            type: type,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                if (res && res.code === 200 && res.data) {
                    $('#addressModal').modal('hide');
                    const newAddress = res.data;
                    confirmAddress(newAddress);
                    alert('地址保存成功！');

                    // 如果地址选择模态框存在，刷新地址列表
                    if ($('#addressSelectModal').length) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addressSelectModal'));
                        modal.hide();
                    }
                } else {
                    alert('地址保存失败：' + (res ? res.msg : '未知错误'));
                }
            },
            error: function () {
                // 即使API失败，也保存到本地并显示
                const newAddress = {
                    id: Date.now(),
                    recipient: data.recipient,
                    phone: data.phone,
                    province: data.province,
                    city: data.city,
                    district: data.district,
                    detail_address: data.detail_address,
                    is_default: data.is_default,
                    full_address: `${data.province}${data.city}${data.district}${data.detail_address}`
                };
                $('#addressModal').modal('hide');
                confirmAddress(newAddress);
                alert('地址已临时保存，请稍后检查是否同步到服务器');
            }
        });
    }

    // 确认地址选择
    function confirmAddress(address) {
        console.log('confirmAddress function called with address:', address);

        // 保存选择的地址到本地存储
        localStorage.setItem('selectedAddress', JSON.stringify(address));

        // 构建完整的地址字符串，优先使用后端返回的full_address
        let fullAddress = address.full_address || `${address.province}${address.city}${address.district}${address.detail_address}`;

        // 添加联系人信息
        fullAddress += ` (联系人：${address.recipient}，电话：${address.phone})`;

        console.log('Constructed full address:', fullAddress);

        // 更新地址输入框的值
        $('#addressInput').val(fullAddress);
        console.log('Address input updated');

        // 更新结算信息
        updatePrices();
        console.log('Prices updated');

        // 关闭地址选择模态对话框
        closeAddressModal();
        console.log('Address modal closed');

        // 显示提示信息（可选）
        // 为了更好的用户体验，这里可以考虑不显示alert，让用户看到地址更新即可
        // alert(`已选择地址：${fullAddress}`);
    }

    // 选择优惠券
    function selectCoupon(id, name, value, type, minSpend, merchantId) {
        try {
            // 构建优惠券对象
            const coupon = {
                id: id,
                name: name,
                coupon_name: name,
                value: parseFloat(value) || 0,
                type: type || '满减',
                min_spend: parseFloat(minSpend) || 0,
                merchant_id: merchantId
            };

            // 调试信息
            console.log('选择优惠券:', coupon);
            console.log('优惠券ID:', coupon.id);

            // 存储选择的优惠券
            localStorage.setItem('selectedCoupon', JSON.stringify(coupon));
            console.log('优惠券已存储到localStorage');

            // 更新UI显示
            $('#selectedCouponName').text(coupon.name);
            $('#selectedCouponInfo').removeClass('d-none');

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
            if (modal) {
                modal.hide();
            } else {
                console.error('无法获取模态框实例');
            }

            // 更新价格计算（包含优惠）
            updatePrices();

            // 显示提示
            if (typeof showToast === 'function') {
                showToast('优惠券已选择');
            }
        } catch (e) {
            console.error('选择优惠券时发生异常:', e);
            if (typeof showToast === 'function') {
                showToast('选择优惠券失败', 'error');
            }
        }
    }

    // 移除已选择的优惠券
    function removeCoupon() {
        localStorage.removeItem('selectedCoupon');
        $('#selectedCouponInfo').addClass('d-none');
        updatePrices();
    }

    // 更新价格计算（包含优惠券）
    function updatePrices() {
        const totalPrice = parseFloat($('#totalPrice').text().replace('¥', '')) || 0;

        // 获取当前购物车数据并按商户分组
        let deliveryFee = currentDeliveryFee;
        const currentCart = JSON.parse(localStorage.getItem('currentCart')) || [];
        if (currentCart.length > 0) {
            const itemsByMerchant = {};
            currentCart.forEach(item => {
                if (item && item.dish) {
                    const merchantId = item.dish.merchant_id;
                    if (!itemsByMerchant[merchantId]) {
                        itemsByMerchant[merchantId] = [];
                    }
                    itemsByMerchant[merchantId].push(item);
                }
            });
            // 根据商户数量计算配送费
            const totalMerchants = Object.keys(itemsByMerchant).length;
            deliveryFee = currentDeliveryFee * totalMerchants;
        }

        // 检查是否有选中的优惠券
        let discount = 0;
        let discountText = '';
        const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;

        if (selectedCoupon) {
            // 获取优惠券的商家ID
            const couponMerchantId = selectedCoupon.merchant_id;

            // 计算优惠券对应商家的商品总价
            let merchantTotal = 0;
            const currentCart = JSON.parse(localStorage.getItem('currentCart')) || [];
            currentCart.forEach(item => {
                if (item && item.dish && item.dish.merchant_id === couponMerchantId) {
                    merchantTotal += item.dish.price * item.quantity;
                }
            });

            const minSpend = parseFloat(selectedCoupon.min_spend) || 0;

            // 只有当对应商家的商品总价满足最低消费要求时才应用优惠券
            if (merchantTotal >= minSpend && merchantTotal > 0) {
                // 根据优惠券类型计算折扣
                const couponValue = parseFloat(selectedCoupon.value || selectedCoupon.discount_amount) || 0;
                if (selectedCoupon.type === '折扣' || selectedCoupon.type === 'discount') {
                    // 折扣券，如9表示9折，折扣金额为该商家商品总价的10%
                    const discountRate = couponValue / 10;
                    discount = merchantTotal * (1 - discountRate);
                    // 确保优惠金额不超过该商家的商品总价
                    if (discount > merchantTotal) {
                        discount = merchantTotal;
                    }
                    // 显示为-XX%
                    const discountPercent = Math.round((1 - discountRate) * 100);
                    discountText = `- ${discountPercent}%`;
                } else {
                    // 满减券或无门槛券，直接显示金额
                    discount = couponValue;
                    // 确保优惠金额不超过该商家的商品总价
                    if (discount > merchantTotal) {
                        discount = merchantTotal;
                    }
                    // 显示为-¥XX
                    discountText = `-¥${discount.toFixed(2)}`;
                }
                $('#discountRow').show();
                $('#discountAmount').text(discountText);
                $('#discountAmountRight').text(discountText);
            } else {
                // 未满足最低消费或没有对应商家的商品，不应用优惠
                $('#discountRow').hide();
            }
        } else {
            $('#discountRow').hide();
        }

        // 计算最终价格
        const finalPrice = Math.max(0, totalPrice + deliveryFee - discount);
        $('#finalPrice').text(`¥${finalPrice.toFixed(2)}`);
    }

    // 修改渲染购物车函数，添加优惠券相关逻辑
    function renderCart(cartItems) {
        // 处理空购物车情况
        if (!cartItems || cartItems.length === 0) {
            $('#cartList').html('<div class="text-center text-muted py-4">购物车为空</div>');
            $('#totalPrice').text('¥0.00');
            // 使用全局配送费变量
            $('#finalPrice').text(`¥${currentDeliveryFee.toFixed(2)}`);
            $('#payBtn').prop('disabled', true);
            $('#selectCouponBtn').prop('disabled', true);
            $('#selectedCouponInfo').addClass('d-none');
            $('#discountRow').hide();
            localStorage.removeItem('selectedCoupon');
            return;
        }

        let html = '';
        let totalPrice = 0;

        // 遍历购物车商品并生成HTML
        cartItems.forEach(item => {
            if (!item || !item.dish) return;

            const itemTotal = item.dish.price * item.quantity;
            totalPrice += itemTotal;

            html += `
                    <div class="cart-item row">
                        <div class="col-md-2">
                            <img src="/static/${item.dish.img_url || 'uploads/dish/default.png'}" class="dish-img rounded">
                        </div>
                        <div class="col-md-4">
                            <h6>${item.dish.dish_name}</h6>
                            <p class="text-muted">${item.dish.description || '无描述'}</p>
                            <small class="text-muted">商家：${item.dish.merchant_name || '未知商家'}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="text-danger fs-5">¥${item.dish.price.toFixed(2)}</span>
                        </div>
                        <div class="col-md-2">
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-outline-secondary decrease-btn" 
                                    onclick="updateQuantity(${item.dish.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary increase-btn" 
                                    onclick="updateQuantity(${item.dish.id}, ${item.quantity + 1})">+</button>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="fs-6 font-weight-bold">¥${itemTotal.toFixed(2)}</span>
                            <button class="btn btn-sm btn-danger mt-2" 
                                onclick="removeFromCart(${item.dish.id})">删除</button>
                        </div>
                    </div>
                `;
        });

        // 更新DOM
        $('#cartList').html(html);
        $('#totalPrice').text('¥' + totalPrice.toFixed(2));
        $('#payBtn').prop('disabled', false);

        // 如果有商品，启用优惠券按钮
        $('#selectCouponBtn').prop('disabled', false);

        // 加载优惠券数量
        loadCouponCount();

        // 更新价格（包含优惠）
        updatePrices();
        // 更新配送费显示
        updateDeliveryFeeDisplay();
    }

    // 加载用户可用的优惠券数量
    function loadCouponCount() {
        const token = UserAuthManager.getToken();
        $.ajax({
            url: '/api/student/coupons/count',
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res && res.code === 200) {
                    const count = res.data || 0;
                    $('#selectCouponBtn').text(`选择优惠券 (${count})`);
                }
            },
            error: function () {
                // 不显示错误，保持默认文本
            }
        });
    }



    // 初始化优惠券显示
    function initCouponDisplay() {
        console.log('初始化优惠券显示...');
        const savedCoupon = JSON.parse(localStorage.getItem('selectedCoupon'));
        if (savedCoupon) {
            console.log('找到已保存的优惠券:', savedCoupon);
            // 更新UI显示已选择的优惠券
            $('#selectedCouponName').text(savedCoupon.name);
            $('#selectedCouponInfo').removeClass('d-none');
            // 更新价格计算
            updatePrices();
        } else {
            console.log('未找到已保存的优惠券');
            // 确保优惠券信息区域隐藏
            $('#selectedCouponInfo').addClass('d-none');
        }
    }

    // 创建订单
    function createOrder() {
        // 验证是否有选中的地址
        const selectedAddress = localStorage.getItem('selectedAddress');
        if (!selectedAddress) {
            alert('请先选择收货地址');
            return;
        }

        // 获取选中的支付方式
        const selectedPayType = $('#payType').val() || 'wechat';

        // 添加加载状态
        const payBtn = $('#payBtn');
        const originalText = payBtn.text();
        payBtn.prop('disabled', true).text('处理中...');

        // 直接从后端API获取最新的购物车数据
        $.ajax({
            url: '/api/student/cart',
            type: 'GET',
            success: function (res) {
                if (res && res.code === 200 && res.data && res.data.items) {
                    const cartItems = res.data.items;

                    if (cartItems.length === 0) {
                        alert('购物车为空');
                        payBtn.prop('disabled', false).text(originalText);
                        return;
                    }

                    // 按商户ID对商品进行分组
                    const itemsByMerchant = {};
                    cartItems.forEach(item => {
                        const merchantId = item.dish.merchant_id;
                        if (!itemsByMerchant[merchantId]) {
                            itemsByMerchant[merchantId] = [];
                        }
                        itemsByMerchant[merchantId].push(item);
                    });

                    // 保存按钮引用，用于取消支付时恢复状态
                    window.currentPayBtn = payBtn;
                    window.currentOriginalText = originalText;

                    // 显示支付确认弹窗
                    showPaymentConfirmModal(cartItems, itemsByMerchant, selectedAddress, selectedPayType, payBtn, originalText);
                } else {
                    alert('获取购物车数据失败：' + (res ? res.msg : '未知错误'));
                    payBtn.prop('disabled', false).text(originalText);
                }
            },
            error: function () {
                alert('网络错误，无法获取购物车数据');
                payBtn.prop('disabled', false).text(originalText);
            }
        });

        // 阻止后续代码立即执行
        return;
    }

    // 处理订单创建的核心逻辑
    // function processOrderCreation(cartItems, itemsByMerchant, selectedAddress, selectedPayType, payBtn, originalText) {
    //     // 获取选中的优惠券
    //     const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
    //     // 调试信息 - 验证优惠券ID
    //     console.log('从localStorage获取的优惠券:', selectedCoupon);
    //     console.log('传递给后端的优惠券ID:', selectedCoupon ? selectedCoupon.id : null);
    //     console.log('按商户分组的商品:', itemsByMerchant);

    //     const token = UserAuthManager.getToken();
    //     const address = JSON.parse(selectedAddress);
    //     const orderRemark = $('#orderRemark').val() || '';

    //     // 保存创建的订单信息
    //     const createdOrders = [];
    //     let orderCreationCount = 0;
    //     const totalMerchants = Object.keys(itemsByMerchant).length;
    //     let hasError = false;

    //     // 为每个商户创建单独的订单
    //     Object.keys(itemsByMerchant).forEach(merchantId => {
    //         // 构建订单数据
    //         const orderData = {
    //             merchant_id: merchantId,
    //             address_id: address.id,
    //             coupon_id: selectedCoupon ? selectedCoupon.id : null,
    //             remark: orderRemark,
    //             // 在前端临时存储购物车项ID，方便后端处理
    //             cart_item_ids: itemsByMerchant[merchantId].map(item => item.id)
    //         };

    //         console.log(`为商户 ${merchantId} 创建订单时传递的数据:`, orderData);

    //         $.ajax({
    //             url: '/api/student/order/create',
    //             type: 'POST',
    //             headers: { 'Authorization': `Bearer ${token}` },
    //             contentType: 'application/json',
    //             data: JSON.stringify(orderData),
    //             success: function (res) {
    //                 if (res && res.code === 200 && res.data) {
    //                     createdOrders.push({
    //                         order_id: res.data.order_id,
    //                         pay_amount: res.data.pay_amount,
    //                         merchant_id: merchantId
    //                     });
    //                     // console.log(`商户 ${merchantId} 订单创建成功:`, res.data);
    //                 } else {
    //                     hasError = true;
    //                     alert(`为商户创建订单失败：${res ? res.msg : '未知错误'}`);
    //                     console.error(`商户 ${merchantId} 订单创建失败:`, res);
    //                 }
    //             },
    //             error: function () {
    //                 hasError = true;
    //                 alert('网络错误，无法创建订单');
    //             },
    //             complete: function () {
    //                 orderCreationCount++;

    //                 // 当所有订单都创建完成
    //                 if (orderCreationCount === totalMerchants) {
    //                     // 恢复按钮状态
    //                     payBtn.prop('disabled', false).text(originalText);

    //                     if (!hasError && createdOrders.length > 0) {
    //                         // 清除选中的优惠券
    //                         localStorage.removeItem('selectedCoupon');
    //                         // 清除购物车数据
    //                         localStorage.removeItem('currentCart');

    //                         // 处理多订单支付
    //                         processMultiplePayments(createdOrders, selectedPayType);
    //                     }
    //                 }
    //             }
    //         });
    //     });
    // }

    // 处理单个支付流程
    function processPayment(orderId, amount, payType, couponsAdded = 0) {
        // 模拟支付过程
        console.log(`开始支付订单 ${orderId}，金额：${amount}，支付方式：${payType}`);

        // 这里应该调用实际的支付接口，现在简单模拟
        setTimeout(() => {
            // 模拟支付成功
            let message = '支付成功！';

            // 如果有优惠券发放，添加提示
            if (couponsAdded > 0) {
                message += '\n恭喜获得优惠券！';
            }

            alert(message);
            // 跳转到订单页面
            window.location.href = '/student/orders';
        }, 1500);
    }

    // 处理多订单支付流程
    function processMultiplePayments(orders, payType, couponsAdded = 0, isPaymentSuccess = true) {
        // 计算总支付金额
        const totalAmount = orders.reduce((sum, order) => sum + order.pay_amount, 0);

        console.log('开始处理多订单支付:', orders);
        console.log(`总支付金额: ${totalAmount}，支付方式: ${payType}`);

        let message;

        if (isPaymentSuccess) {
            // 支付成功
            message = `订单支付成功！`;

            // 如果有优惠券发放，添加提示
            if (couponsAdded > 0) {
                message += `\n恭喜获得 ${couponsAdded} 张优惠券！请前往卡包查看`;
            }

            alert(message);

            // 记录支付成功的订单ID，便于后续查询
            const successOrderIds = orders.map(order => order.order_id).join(', ');
            console.log(`支付成功的订单ID: ${successOrderIds}`);

        } else {
            // 支付被取消或失败，订单已创建到待支付列表
            message = `订单创建成功！\n您的订单已保存到待支付列表，您可以在订单页面继续完成支付`;
            alert(message);
        }

        // 无论支付结果如何，都跳转到订单页面
        window.location.href = '/student/orders';
    }

    // 保存当前购物车数据到localStorage
    function saveCartToLocalStorage(cartItems) {
        localStorage.setItem('currentCart', JSON.stringify(cartItems));
    }

    // 保存订单备注到localStorage
    function saveOrderRemark(remark) {
        localStorage.setItem('orderRemark', remark);
    }

    // 移除重复的退出登录函数，使用base.html中定义的全局logout函数

    // 全局变量，用于存储待处理的订单数据
    let pendingOrderData = null;

    // 显示支付确认弹窗
    function showPaymentConfirmModal(cartItems, itemsByMerchant, selectedAddress, selectedPayType, payBtn, originalText) {
        // 保存待处理的订单数据
        pendingOrderData = {
            cartItems,
            itemsByMerchant,
            selectedAddress,
            selectedPayType,
            payBtn,
            originalText
        };

        // 填充菜品列表
        populateConfirmDishList(cartItems);

        // 计算并显示价格信息
        const totalPrice = cartItems.reduce((sum, item) => sum + (item.dish.price * item.quantity), 0);
        // 根据商户数量计算配送费
        const totalMerchants = Object.keys(itemsByMerchant).length;
        const deliveryFee = currentDeliveryFee * totalMerchants;
        const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
        let discountAmount = 0;
        let discountText = '';

        if (selectedCoupon) {
            // 获取优惠券的商家ID
            const couponMerchantId = selectedCoupon.merchant_id;

            // 计算优惠券对应商家的商品总价
            let merchantTotal = 0;
            cartItems.forEach(item => {
                if (item.dish.merchant_id === couponMerchantId) {
                    merchantTotal += item.dish.price * item.quantity;
                }
            });

            const minSpend = parseFloat(selectedCoupon.min_spend) || 0;

            // 只有当对应商家的商品总价满足最低消费要求时才应用优惠券
            if (merchantTotal >= minSpend && merchantTotal > 0) {
                // 根据优惠券类型计算折扣
                const couponValue = parseFloat(selectedCoupon.value || selectedCoupon.discount_amount) || 0;
                if (selectedCoupon.type === '折扣' || selectedCoupon.type === 'discount') {
                    // 折扣券，如9表示9折，折扣金额为该商家商品总价的10%
                    const discountRate = couponValue / 10;
                    discountAmount = merchantTotal * (1 - discountRate);
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                    // 显示为-XX%
                    const discountPercent = Math.round((1 - discountRate) * 100);
                    discountText = `- ${discountPercent}%`;
                } else {
                    // 满减券或无门槛券，直接显示金额
                    discountAmount = couponValue;
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                    // 显示为-¥XX
                    discountText = `-¥${discountAmount.toFixed(2)}`;
                }

                // 显示优惠信息
                $('#confirmDiscountRow').show();
                $('#confirmDiscountAmount').text(discountText);
            } else {
                // 未满足最低消费或没有对应商家的商品，不应用优惠
                $('#confirmDiscountRow').hide();
            }
        } else {
            // 隐藏优惠信息
            $('#confirmDiscountRow').hide();
        }

        // 计算实付金额
        const finalPrice = Math.max(0, totalPrice + deliveryFee - discountAmount);

        // 更新价格显示
        $('#confirmTotalPrice').text(`¥${totalPrice.toFixed(2)}`);
        $('#confirmDeliveryFee').text(`¥${deliveryFee.toFixed(2)}`);
        $('#confirmFinalPrice').text(`¥${finalPrice.toFixed(2)}`);

        // 显示弹窗
        $('#paymentConfirmModal').modal('show');
    }

    // 填充确认弹窗中的菜品列表
    function populateConfirmDishList(cartItems) {
        const dishListContainer = $('#confirmDishList');
        dishListContainer.empty(); // 清空现有内容

        // 按商户分组显示菜品
        const dishesByMerchant = {};
        cartItems.forEach(item => {
            const merchantId = item.dish.merchant_id;
            if (!dishesByMerchant[merchantId]) {
                dishesByMerchant[merchantId] = [];
            }
            dishesByMerchant[merchantId].push(item);
        });

        // 遍历每个商户的菜品
        Object.values(dishesByMerchant).forEach(merchantDishes => {
            // 添加商户名称（如果有商户名称信息）
            if (merchantDishes.length > 0 && merchantDishes[0].dish.merchant_name) {
                const merchantName = $('<div class="font-medium text-sm text-muted mb-2"></div>')
                    .text(merchantDishes[0].dish.merchant_name);
                dishListContainer.append(merchantName);
            }

            // 添加每个菜品
            merchantDishes.forEach(item => {
                const dishItem = $('<div class="confirm-dish-item"></div>');

                const dishName = $('<div class="confirm-dish-name"></div>')
                    .text(item.dish.name);

                const dishQuantity = $('<div class="confirm-dish-quantity"></div>')
                    .text(`x${item.quantity}`);

                const dishPrice = $('<div class="confirm-dish-price"></div>')
                    .text(`¥${(item.dish.price * item.quantity).toFixed(2)}`);

                dishItem.append(dishName, dishQuantity, dishPrice);
                dishListContainer.append(dishItem);
            });
        });
    }

    // 确认支付
    function confirmPayment() {
        if (!pendingOrderData) {
            alert('订单数据异常，请重新尝试');
            return;
        }

        // 隐藏确认弹窗
        $('#paymentConfirmModal').modal('hide');

        // 计算实付金额
        const cartItems = pendingOrderData.cartItems;
        const itemsByMerchant = pendingOrderData.itemsByMerchant;
        const totalPrice = cartItems.reduce((sum, item) => sum + (item.dish.price * item.quantity), 0);
        // 根据商户数量计算配送费
        const totalMerchants = Object.keys(itemsByMerchant).length;
        const deliveryFee = currentDeliveryFee * totalMerchants;
        const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
        let discountAmount = 0;

        if (selectedCoupon) {
            // 获取优惠券的商家ID
            const couponMerchantId = selectedCoupon.merchant_id;

            // 计算优惠券对应商家的商品总价
            let merchantTotal = 0;
            cartItems.forEach(item => {
                if (item.dish.merchant_id === couponMerchantId) {
                    merchantTotal += item.dish.price * item.quantity;
                }
            });

            const minSpend = parseFloat(selectedCoupon.min_spend) || 0;

            // 只有当对应商家的商品总价满足最低消费要求时才应用优惠券
            if (merchantTotal >= minSpend && merchantTotal > 0) {
                // 根据优惠券类型计算折扣
                const couponValue = parseFloat(selectedCoupon.value || selectedCoupon.discount_amount) || 0;
                if (selectedCoupon.type === '折扣' || selectedCoupon.type === 'discount') {
                    // 折扣券，如9表示9折，折扣金额为该商家商品总价的10%
                    const discountRate = couponValue / 10;
                    discountAmount = merchantTotal * (1 - discountRate);
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                } else {
                    // 满减券或无门槛券，直接显示金额
                    discountAmount = couponValue;
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                }
            }
        }

        // 计算实付金额
        const finalPrice = Math.max(0, totalPrice + deliveryFee - discountAmount);

        // 更新支付金额显示
        $('#paymentAmount').text(`¥${finalPrice.toFixed(2)}`);
        // 清空密码输入框和错误提示
        $('#payPassword').val('');
        $('#passwordError').addClass('d-none');

        // 显示支付密码悬浮框
        $('#paymentPasswordModal').modal('show');
    }

    // 验证支付密码
    function verifyPaymentPassword() {
        const payPassword = $('#payPassword').val();
        const errorElement = $('#passwordError');

        // 验证密码格式
        if (!payPassword || payPassword.length !== 6 || !/^\d+$/.test(payPassword)) {
            errorElement.text('请输入6位数字支付密码').removeClass('d-none');
            return;
        }

        // 隐藏错误提示
        errorElement.addClass('d-none');

        // 获取实付金额
        const cartItems = pendingOrderData.cartItems;
        const itemsByMerchant = pendingOrderData.itemsByMerchant;
        const totalPrice = cartItems.reduce((sum, item) => sum + (item.dish.price * item.quantity), 0);
        // 根据商户数量计算配送费
        const totalMerchants = Object.keys(itemsByMerchant).length;
        const deliveryFee = currentDeliveryFee * totalMerchants;
        const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
        let discountAmount = 0;

        if (selectedCoupon) {
            // 获取优惠券的商家ID
            const couponMerchantId = selectedCoupon.merchant_id;

            // 计算优惠券对应商家的商品总价
            let merchantTotal = 0;
            cartItems.forEach(item => {
                if (item.dish.merchant_id === couponMerchantId) {
                    merchantTotal += item.dish.price * item.quantity;
                }
            });

            const minSpend = parseFloat(selectedCoupon.min_spend) || 0;

            // 只有当对应商家的商品总价满足最低消费要求时才应用优惠券
            if (merchantTotal >= minSpend && merchantTotal > 0) {
                // 根据优惠券类型计算折扣
                const couponValue = parseFloat(selectedCoupon.value || selectedCoupon.discount_amount) || 0;
                if (selectedCoupon.type === '折扣' || selectedCoupon.type === 'discount') {
                    // 折扣券，如9表示9折，折扣金额为该商家商品总价的10%
                    const discountRate = couponValue / 10;
                    discountAmount = merchantTotal * (1 - discountRate);
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                } else {
                    // 满减券或无门槛券，直接显示金额
                    discountAmount = couponValue;
                    // 确保优惠金额不超过该商家的商品总价
                    if (discountAmount > merchantTotal) {
                        discountAmount = merchantTotal;
                    }
                }
            }
        }

        // 计算实付金额
        const finalPrice = Math.max(0, totalPrice + deliveryFee - discountAmount);

        const token = UserAuthManager.getToken();

        // 调用支付密码验证和钱包扣款API
        $.ajax({
            url: '/api/student/wallet/pay',
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: 'application/json',
            data: JSON.stringify({
                password: payPassword,
                amount: finalPrice
            }),
            success: function (res) {
                if (res && res.code === 200) {
                    // 密码正确，扣款成功
                    $('#paymentPasswordModal').modal('hide');
                    // 调用原始的订单创建逻辑（支付成功，直接设置为待接单状态）
                    createOrdersFromPendingData('待接单');
                } else {
                    // 密码错误或扣款失败
                    errorElement.text(res && res.msg ? res.msg : '支付密码错误，请重新输入').removeClass('d-none');
                }
            },
            error: function (xhr) {
                // 尝试解析错误响应
                let errorMessage = '网络错误，请稍后重试';
                if (xhr.responseText) {
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.msg) {
                            errorMessage = errorResponse.msg;
                        }
                    } catch (e) {
                        // 如果无法解析JSON，保持默认错误信息
                    }
                }
                errorElement.text(errorMessage).removeClass('d-none');
            }
        });
    }

    // 取消密码支付
    function cancelPasswordPayment() {
        // 隐藏密码悬浮框
        $('#paymentPasswordModal').modal('hide');
        // 恢复按钮状态
        if (window.currentPayBtn) {
            window.currentPayBtn.prop('disabled', false).text(window.currentOriginalText);
            window.currentPayBtn = null;
            window.currentOriginalText = null;
        }
        // 在取消支付时创建待支付状态的订单
        if (pendingOrderData) {
            // 创建待支付状态的订单
            createOrdersFromPendingData();
            // 清空待处理数据
            pendingOrderData = null;
        }
    }

    // 取消支付
    function cancelPayment() {
        // 清空待处理数据
        pendingOrderData = null;

        // 恢复按钮状态
        if (window.currentPayBtn) {
            window.currentPayBtn.prop('disabled', false).text(window.currentOriginalText);
            window.currentPayBtn = null;
            window.currentOriginalText = null;
        }

        // 隐藏弹窗
        $('#paymentConfirmModal').modal('hide');
    }

    // 从待处理数据创建订单
    function createOrdersFromPendingData(status = '待支付') {
        const { cartItems, itemsByMerchant, selectedAddress, selectedPayType, payBtn, originalText } = pendingOrderData;

        // 获取选中的优惠券
        const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;

        const token = UserAuthManager.getToken();
        const address = JSON.parse(selectedAddress);
        const orderRemark = $('#orderRemark').val() || '';

        // 保存创建的订单信息
        const createdOrders = [];
        let orderCreationCount = 0;
        const totalMerchants = Object.keys(itemsByMerchant).length;
        let hasError = false;
        // 记录优惠券发放数量
        let totalCouponsAdded = 0;
        // 根据订单状态判断支付是否成功
        const isPaymentSuccess = status === '待接单';

        // 为每个商户创建单独的订单
        Object.keys(itemsByMerchant).forEach(merchantId => {
            // 构建订单数据
            const orderData = {
                merchant_id: merchantId,
                address_id: address.id,
                coupon_id: selectedCoupon ? selectedCoupon.id : null,
                remark: orderRemark,
                status: status,
                // 在前端临时存储购物车项ID，方便后端处理
                cart_item_ids: itemsByMerchant[merchantId].map(item => item.id)
            };

            console.log(`为商户 ${merchantId} 创建订单时传递的数据:`, orderData);

            $.ajax({
                url: '/api/student/order/create',
                type: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                success: function (res) {
                    if (res && res.code === 200 && res.data) {
                        createdOrders.push({
                            order_id: res.data.order_id,
                            pay_amount: res.data.pay_amount,
                            merchant_id: merchantId,
                            status: status // 添加订单状态
                        });

                        // 检查是否有优惠券发放
                        if (res.coupons_added && res.coupons_added > 0) {
                            totalCouponsAdded += res.coupons_added;
                        }

                        console.log(`商户 ${merchantId} 订单创建成功:`, res.data);
                    } else {
                        hasError = true;
                        alert(`为商户创建订单失败：${res ? res.msg : '未知错误'}`);
                        console.error(`商户 ${merchantId} 订单创建失败:`, res);
                    }
                },
                error: function () {
                    hasError = true;
                    alert('网络错误，无法创建订单');
                },
                complete: function () {
                    orderCreationCount++;

                    // 当所有订单都创建完成
                    if (orderCreationCount === totalMerchants) {
                        // 恢复按钮状态
                        payBtn.prop('disabled', false).text(originalText);

                        if (!hasError && createdOrders.length > 0) {
                            // 清除选中的优惠券
                            localStorage.removeItem('selectedCoupon');
                            // 清除购物车数据
                            localStorage.removeItem('currentCart');
                            // 清空订单备注信息
                            $('#orderRemark').val('');
                            localStorage.removeItem('orderRemark');
                            // 清空选中的地址信息
                            localStorage.removeItem('selectedAddress');
                            // 更新页面上的地址显示
                            $('#selectedAddressText').text('请选择收货地址');

                            // 处理多订单支付
                            processMultiplePayments(createdOrders, selectedPayType, totalCouponsAdded, isPaymentSuccess);
                        }

                        // 清空待处理数据
                        pendingOrderData = null;
                    }
                }
            });
        });
    }
</script>

<style>
    /* 支付确认弹窗样式 */
    #paymentConfirmModal .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
    }

    #paymentConfirmModal .modal-header {
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
    }

    #paymentConfirmModal .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    #paymentConfirmModal .modal-body {
        padding: 20px;
    }

    #paymentConfirmModal h6 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }

    #confirmDishList {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .confirm-dish-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .confirm-dish-item:last-child {
        border-bottom: none;
    }

    .confirm-dish-name {
        flex: 1;
        font-size: 14px;
        color: #333;
    }

    .confirm-dish-quantity {
        font-size: 14px;
        color: #666;
        margin: 0 10px;
    }

    .confirm-dish-price {
        font-size: 14px;
        font-weight: 600;
        color: #ff4d4f;
        text-align: right;
    }

    #paymentConfirmModal .border-t {
        border-top: 1px solid #f0f0f0;
    }

    /* 支付密码悬浮框样式 */
    #paymentPasswordModal .modal-dialog {
        max-width: 400px;
        margin: 1.75rem auto;
    }

    #paymentPasswordModal .modal-header {
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
    }

    #paymentPasswordModal .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    #paymentPasswordModal .modal-body {
        padding: 20px;
    }

    #paymentPasswordModal .form-label {
        font-weight: 500;
        color: #333;
    }

    #paymentAmount {
        letter-spacing: 0.5px;
    }

    #payPassword {
        font-size: 16px;
        text-align: center;
        letter-spacing: 5px;
    }

    #passwordError {
        font-size: 14px;
        padding: 8px 12px;
    }

    #paymentConfirmModal .modal-footer {
        border-top: 1px solid #f0f0f0;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
    }

    #paymentConfirmModal .modal-footer button {
        min-width: 100px;
    }

    #paymentConfirmModal .btn-secondary {
        background-color: #f5f5f5;
        border-color: #f5f5f5;
        color: #666;
    }

    #paymentConfirmModal .btn-secondary:hover {
        background-color: #e8e8e8;
        border-color: #e8e8e8;
        color: #333;
    }

    #paymentConfirmModal .btn-danger {
        background-color: #ff4d4f;
        border-color: #ff4d4f;
    }

    #paymentConfirmModal .btn-danger:hover {
        background-color: #ff7875;
        border-color: #ff7875;
    }

    /* 自定义滚动条样式 */
    #confirmDishList::-webkit-scrollbar {
        width: 6px;
    }

    #confirmDishList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    #confirmDishList::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    #confirmDishList::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

<!-- 添加/编辑地址模态框 -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressModalLabel">添加收货地址</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <input type="hidden" id="address-id">
                    <div class="mb-3">
                        <label for="address-name" class="form-label">收货人姓名</label>
                        <input type="text" class="form-control" id="address-name" placeholder="请输入收货人姓名">
                    </div>
                    <div class="mb-3">
                        <label for="address-phone" class="form-label">联系电话</label>
                        <input type="tel" class="form-control" id="address-phone" placeholder="请输入联系电话">
                    </div>
                    <div class="mb-3">
                        <label for="address-province" class="form-label">省份</label>
                        <input type="text" class="form-control" id="address-province" placeholder="请输入省份">
                    </div>
                    <div class="mb-3">
                        <label for="address-city" class="form-label">城市</label>
                        <input type="text" class="form-control" id="address-city" placeholder="请输入城市">
                    </div>
                    <div class="mb-3">
                        <label for="address-district" class="form-label">区县</label>
                        <input type="text" class="form-control" id="address-district" placeholder="请输入区县">
                    </div>
                    <div class="mb-3">
                        <label for="address-detail" class="form-label">详细地址</label>
                        <textarea class="form-control" id="address-detail" rows="3"
                            placeholder="请输入详细地址，如宿舍号"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="address-default">
                        <label class="form-check-label" for="address-default">设为默认地址</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAddress()">保存地址</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}