{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}购物车 - 校内外卖平台{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
    <li><a href="/student/index">首页</a></li>
    <li><a href="/student/cart" class="active">购物车</a></li>
    <li><a href="/student/orders">我的订单</a></li>
    <li><a href="/student/profile">个人信息</a></li>
    <li><a href="/student/complaints">我的投诉</a></li>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h5>我的购物车</h5>
        </div>
        <div class="card-body">
            <!-- 购物车列表 -->
            <div id="cartList" class="mb-4">
                <div class="text-center text-muted">购物车为空</div>
            </div>

            <div class="card-footer bg-light p-4">
                <div class="row justify-content-between mb-2">
                    <div class="col-6">
                        <div class="text-sm text-muted">商品总价</div>
                        <div class="text-sm">¥5.00</div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="text-sm text-muted">商品合计</div>
                        <div class="text-xl font-bold" id="totalPrice">¥0.00</div>
                    </div>
                </div>
                <div class="row justify-content-between mb-2">
                    <div class="col-6">
                        <div class="text-sm text-muted">配送费</div>
                        <div class="text-sm">¥5.00</div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="text-sm text-muted">配送费</div>
                        <div class="text-sm">¥5.00</div>
                    </div>
                </div>
                <div id="discountRow" class="row justify-content-between mb-2" style="display: none;">
                    <div class="col-6">
                        <div class="text-sm text-muted">优惠券优惠</div>
                        <div class="text-sm"><span id="discountAmount" class="text-danger">-¥0.00</span></div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="text-sm text-muted">优惠金额</div>
                        <div class="text-sm"><span id="discountAmountRight" class="text-danger">-¥0.00</span></div>
                    </div>
                </div>
                <div class="row justify-content-between mb-3 mt-3 border-t pt-3">
                    <div class="col-6">
                        <div class="text-sm text-muted">最终合计</div>
                        <div class="text-2xl font-bold text-danger" id="finalPrice">¥5.00</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">收货地址</label>
                    <div class="input-group">
                        <input type="text" id="addressInput" class="form-control" placeholder="请选择收货地址" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="selectAddress()">选择地址</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">支付方式</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payType" id="payWechat" value="wechat" checked>
                            <label class="form-check-label" for="payWechat">微信支付</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payType" id="payAlipay" value="alipay">
                            <label class="form-check-label" for="payAlipay">支付宝</label>
                        </div>
                    </div>
                    <input type="hidden" id="payType" value="wechat">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">备注</label>
                    <textarea class="form-control" id="orderRemark" rows="2" placeholder="如有特殊要求请在此备注"></textarea>
                </div>
                
                <div class="d-grid gap-2">
                    <button id="selectCouponBtn" class="btn btn-outline-primary py-2" onclick="showCouponModal()">
                        选择优惠券
                    </button>
                    <div id="selectedCouponInfo" class="alert alert-success d-none">
                        <div class="row align-items-center">
                            <div class="col">已选择优惠券：<span id="selectedCouponName"></span></div>
                            <div class="col text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeCoupon()">移除</button>
                            </div>
                        </div>
                    </div>
                    <button id="payBtn" class="btn btn-danger w-100 py-2" disabled onclick="createOrder()">去支付</button>
                </div>
            </div>
            
        </div>
    </div>
{% endblock %}

{% block modals %}
<!-- 优惠券选择模态框 -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">选择优惠券</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between items-center">
                        <div class="text-sm text-muted">当前订单金额：<span id="modalTotalPrice" class="text-danger">¥0.00</span></div>
                        <div class="text-sm text-muted">配送费：¥5.00</div>
                    </div>
                </div>
                <div id="couponList" class="mt-4">
                    <!-- 优惠券列表将通过JavaScript动态加载 -->
                    <div class="text-center text-muted py-4">加载中...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <style>
        .cart-item {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .dish-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .cart-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
    </style>
    <script>
        // 页面加载时检查登录状态并初始化
        $(function () {
            // 获取用户信息并验证登录状态
            const token = UserAuthManager.getToken();
            const userInfo = JSON.parse(localStorage.getItem('userInfo'));
            
            // 如果未登录，跳转到登录页面
            if (!token || !userInfo) {
                window.location.href = '/student/login';
                return;
            }
            
            // 更新用户信息显示
            if ($('#userName').length) {
                $('#userName').text(userInfo.name);
            }
            
            // 加载购物车数据
            loadCart();
            
            // 设置当前菜单激活状态
            const currentPath = window.location.pathname;
            $('.sidebar-menu a').each(function() {
                if ($(this).attr('href') === currentPath) {
                    $(this).addClass('active');
                } else {
                    $(this).removeClass('active');
                }
            });
            
            // 初始化优惠券显示
            initCouponDisplay();
            
            // 检查地址
            const selectedAddress = JSON.parse(localStorage.getItem('selectedAddress')) || null;
            if (selectedAddress) {
                $('#addressInput').val(`${selectedAddress.dormitory} ${selectedAddress.room}`);
            }
            
            // 监听支付方式选择变化
            $('input[name="payType"]').change(function() {
                $('#payType').val($(this).val());
            });
        });

        // 加载购物车数据
        function loadCart() {
            const token = UserAuthManager.getToken();
            // 添加加载动画
            $('#cartList').html('<div class="text-center py-4"><div class="spinner-border" role="status"><span class="sr-only">加载中...</span></div></div>');
            
            $.ajax({
                url: '/api/student/cart',
                type: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function (res) {
                    if (res && res.code === 200) {
                        renderCart(res.data || []);
                    } else {
                        console.error('获取购物车失败：', res ? res.msg : '未知错误');
                        alert('获取购物车失败，请稍后重试');
                    }
                },
                error: function () {
                    alert('网络错误，无法获取购物车数据');
                    // 显示错误状态
                    $('#cartList').html('<div class="text-center text-danger py-4">无法加载购物车数据，请稍后重试</div>');
                    // API失败时尝试使用localStorage中的数据
                    const localCart = localStorage.getItem('currentCart');
                    if (localCart) {
                        try {
                            renderCart(JSON.parse(localCart));
                        } catch (e) {
                            console.error('解析本地购物车数据失败：', e);
                        }
                    }
                }
            });
        }

        // 渲染购物车商品列表
        function renderCart(cartItems) {
            // 处理空购物车情况
            if (!cartItems || cartItems.length === 0) {
                $('#cartList').html('<div class="text-center text-muted py-4">购物车为空</div>');
                $('#totalPrice').text('¥0.00');
                $('#finalPrice').text('¥5.00');
                $('#payBtn').prop('disabled', true);
                return;
            }

            let html = '';
            let totalPrice = 0;

            // 遍历购物车商品并生成HTML
            cartItems.forEach(item => {
                if (!item || !item.dish) return;
                
                const itemTotal = item.dish.price * item.quantity;
                totalPrice += itemTotal;

                html += `
                    <div class="cart-item row">
                        <div class="col-md-2">
                            <img src="/static/${item.dish.img_url || 'uploads/dish/default.png'}" class="dish-img rounded">
                        </div>
                        <div class="col-md-4">
                            <h6>${item.dish.dish_name}</h6>
                            <p class="text-muted">${item.dish.description || '无描述'}</p>
                            <small class="text-muted">商家：${item.dish.merchant_name || '未知商家'}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="text-danger fs-5">¥${item.dish.price.toFixed(2)}</span>
                        </div>
                        <div class="col-md-2">
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity + 1})"></button>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="fs-6 font-weight-bold">¥${itemTotal.toFixed(2)}</span>
                            <button class="btn btn-sm btn-danger mt-2" 
                                    onclick="removeFromCart(${item.id})"></button>
                        </div>
                    </div>
                `;
            });

            // 保存购物车数据到localStorage
            saveCartToLocalStorage(cartItems);

            // 更新DOM
            $('#cartList').html(html);
            $('#totalPrice').text('¥' + totalPrice.toFixed(2));
            $('#finalPrice').text('¥' + (totalPrice + 5).toFixed(2));
            $('#payBtn').prop('disabled', false);
        }

        // 更新购物车商品数量
        function updateQuantity(cartId, newQuantity) {
            // 数量小于1时直接删除
            if (newQuantity < 1) {
                removeFromCart(cartId);
                return;
            }

            // 添加加载状态
            const button = event ? $(event.target) : null;
            if (button) {
                const originalText = button.text();
                button.prop('disabled', true).text('更新中...');
            }

            const token = UserAuthManager.getToken();
            $.ajax({
                url: `/api/student/cart/${cartId}`,
                type: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                contentType: 'application/json',
                data: JSON.stringify({ quantity: newQuantity }),
                success: function (res) {
                    if (res && res.code === 200) {
                        loadCart(); // 刷新购物车
                    } else {
                        alert('更新失败：' + (res ? res.msg : '未知错误'));
                    }
                },
                error: function () {
                    alert('网络错误，无法更新商品数量');
                },
                complete: function() {
                    // 恢复按钮状态
                    if (button) {
                        button.prop('disabled', false).text(originalText);
                    }
                }
            });
        }

        // 从购物车删除商品
        function removeFromCart(cartId) {
            if (!confirm('确定要从购物车删除该商品吗？')) return;

            // 添加加载状态
            const button = event ? $(event.target) : null;
            if (button) {
                const originalText = button.text();
                button.prop('disabled', true).text('删除中...');
            }

            const token = UserAuthManager.getToken();
            $.ajax({
                url: `/api/student/cart/${cartId}`,
                type: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function (res) {
                    if (res && res.code === 200) {
                        // 删除成功后，为了更好的用户体验，可以先从DOM中移除该项，然后再刷新购物车
                        if (button) {
                            const cartItem = button.closest('.cart-item');
                            if (cartItem) {
                                cartItem.fadeOut('fast', function() {
                                    loadCart(); // 完全移除后刷新购物车以更新总价
                                });
                            } else {
                                loadCart();
                            }
                        } else {
                            loadCart();
                        }
                    } else {
                        alert('删除失败：' + (res ? res.msg : '未知错误'));
                    }
                },
                error: function () {
                    alert('网络错误，无法删除商品');
                    // 即使API失败，也从本地移除该商品，保持UI一致性
                    try {
                        const currentCart = JSON.parse(localStorage.getItem('currentCart') || '[]');
                        const updatedCart = currentCart.filter(item => item.id !== cartId);
                        localStorage.setItem('currentCart', JSON.stringify(updatedCart));
                        if (button) {
                            const cartItem = button.closest('.cart-item');
                            if (cartItem) {
                                cartItem.fadeOut('fast');
                            }
                        }
                    } catch (e) {
                        console.error('从本地购物车删除失败：', e);
                    }
                },
                complete: function() {
                    // 恢复按钮状态
                    if (button) {
                        button.prop('disabled', false).text(originalText);
                    }
                }
            });
        }



        // 显示优惠券模态框
        function showCouponModal() {
            // 更新模态框中的订单金额
            $('#modalTotalPrice').text($('#totalPrice').text());
            // 加载优惠券数据
            loadCoupons();
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('couponModal'));
            modal.show();
        }
        
        // 加载用户可用的优惠券
        function loadCoupons() {
            console.log('开始加载可用优惠券...');
            const token = UserAuthManager.getToken();
            $.ajax({
                url: '/api/student/coupons',
                type: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(res) {
                    console.log('优惠券加载响应:', res);
                    if (res && res.code === 200 && res.data) {
                        console.log('获取到的优惠券列表:', res.data);
                        renderCoupons(res.data);
                    } else {
                        console.error('优惠券加载失败:', res ? res.msg : '未知错误');
                        $('#couponList').html('<div class="text-center text-danger py-4">无法加载优惠券</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('优惠券加载请求错误:', error);
                    $('#couponList').html('<div class="text-center text-danger py-4">网络错误，无法加载优惠券</div>');
                }
            });
        }
        
        // 渲染优惠券列表
        function renderCoupons(coupons) {
            console.log('开始渲染优惠券列表...');
            console.log('传入的优惠券数据:', coupons);
            
            if (!coupons || coupons.length === 0) {
                console.log('优惠券列表为空');
                $('#couponList').html('<div class="text-center text-muted py-4">暂无可用优惠券</div>');
                return;
            }
            
            let html = '';
            const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
            console.log('当前选中的优惠券:', selectedCoupon);
            
            coupons.forEach(coupon => {
                console.log('处理优惠券:', coupon.id, coupon.name);
                const isSelected = selectedCoupon && selectedCoupon.id === coupon.id;
                const validTotalPrice = coupon.min_spend || 0;
                const currentTotal = parseFloat($('#totalPrice').text().replace('¥', '')) || 0;
                const isAvailable = currentTotal >= validTotalPrice;
                
                console.log(`优惠券 ${coupon.id}: 选中状态=${isSelected}, 可用状态=${isAvailable}, 当前总价=${currentTotal}, 最低消费=${validTotalPrice}`);
                
                html += `
                    <div class="coupon-item p-3 mb-3 border rounded ${isSelected ? 'border-success bg-success-subtle' : 'border-gray-200'} ${!isAvailable ? 'opacity-50' : ''}">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center">
                                <span class="text-danger fs-3 font-bold">¥${coupon.discount_amount}</span>
                                <div class="text-xs text-muted mt-1">满${validTotalPrice}元可用</div>
                            </div>
                            <div class="col-md-6">
                                <h6>${coupon.name}</h6>
                                <p class="text-xs text-muted">有效期至：${coupon.expire_date}</p>
                            </div>
                            <div class="col-md-3 text-end">
                            <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-primary'}"
                                onclick="selectCoupon(${JSON.stringify(coupon).replace(/"/g, '\\"')})"
                                ${!isAvailable ? 'disabled title="未满足最低消费条件"' : ''}>
                                ${isSelected ? '已选择' : '选择'}
                            </button>
                        </div>
                        </div>
                    </div>
                `;
            });
            
            $('#couponList').html(html);
            console.log('优惠券列表渲染完成')
        }
        
        // 选择地址
        function selectAddress() {
            // 模拟打开地址选择界面
            // 在实际应用中，这里应该打开地址管理模态框或跳转到地址选择页面
            const addresses = [
                {id: 1, dormitory: '学生公寓A栋', room: '302室'},
                {id: 2, dormitory: '学生公寓B栋', room: '405室'},
                {id: 3, dormitory: '研究生公寓', room: '501室'}
            ];
            
            let addressHtml = '请选择收货地址：<div class="mt-2">';
            addresses.forEach(addr => {
                addressHtml += `<div class="mb-2 p-2 border rounded cursor-pointer hover:bg-light" onclick="confirmAddress(${JSON.stringify(addr)})">
                    ${addr.dormitory} ${addr.room}
                </div>`;
            });
            addressHtml += '</div>';
            
            if (confirm(addressHtml)) {
                // 这里只是示例，实际应该在confirmAddress函数中处理
            } else {
                const newDorm = prompt('请输入宿舍栋数：');
                const newRoom = prompt('请输入房间号：');
                if (newDorm && newRoom) {
                    const newAddress = {
                        id: Date.now(),
                        dormitory: newDorm,
                        room: newRoom
                    };
                    confirmAddress(newAddress);
                }
            }
        }
        
        // 确认地址选择
        function confirmAddress(address) {
            localStorage.setItem('selectedAddress', JSON.stringify(address));
            $('#addressInput').val(`${address.dormitory} ${address.room}`);
            alert(`已选择地址：${address.dormitory} ${address.room}`);
        }
        
        // 选择优惠券
        function selectCoupon(coupon) {
            // 调试信息
            console.log('选择优惠券:', coupon);
            console.log('优惠券ID:', coupon.id);
            
            // 存储选择的优惠券
            localStorage.setItem('selectedCoupon', JSON.stringify(coupon));
            console.log('优惠券已存储到localStorage');
            
            // 更新UI显示
            $('#selectedCouponName').text(coupon.name);
            $('#selectedCouponInfo').removeClass('d-none');
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
            modal.hide();
            
            // 更新价格计算（包含优惠）
            updatePrices();
        }
        
        // 移除已选择的优惠券
        function removeCoupon() {
            localStorage.removeItem('selectedCoupon');
            $('#selectedCouponInfo').addClass('d-none');
            updatePrices();
        }
        
        // 更新价格计算（包含优惠券）
        function updatePrices() {
            const totalPrice = parseFloat($('#totalPrice').text().replace('¥', '')) || 0;
            const deliveryFee = 5.00;
            
            // 检查是否有选中的优惠券
            let discount = 0;
            const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
            
            if (selectedCoupon) {
                const minSpend = selectedCoupon.min_spend || 0;
                if (totalPrice >= minSpend) {
                    discount = selectedCoupon.discount_amount;
                    // 确保优惠金额不超过总价
                    if (discount > totalPrice) {
                        discount = totalPrice;
                    }
                    $('#discountRow').show();
                    $('#discountAmount').text(`-¥${discount.toFixed(2)}`);
                    $('#discountAmountRight').text(`-¥${discount.toFixed(2)}`);
                } else {
                    // 未满足最低消费，不应用优惠
                    $('#discountRow').hide();
                }
            } else {
                $('#discountRow').hide();
            }
            
            // 计算最终价格
            const finalPrice = totalPrice + deliveryFee - discount;
            $('#finalPrice').text(`¥${finalPrice.toFixed(2)}`);
        }
        
        // 修改渲染购物车函数，添加优惠券相关逻辑
        function renderCart(cartItems) {
            // 处理空购物车情况
            if (!cartItems || cartItems.length === 0) {
                $('#cartList').html('<div class="text-center text-muted py-4">购物车为空</div>');
                $('#totalPrice').text('¥0.00');
                $('#finalPrice').text('¥5.00');
                $('#payBtn').prop('disabled', true);
                $('#selectCouponBtn').prop('disabled', true);
                $('#selectedCouponInfo').addClass('d-none');
                $('#discountRow').hide();
                localStorage.removeItem('selectedCoupon');
                return;
            }

            let html = '';
            let totalPrice = 0;

            // 遍历购物车商品并生成HTML
            cartItems.forEach(item => {
                if (!item || !item.dish) return;
                
                const itemTotal = item.dish.price * item.quantity;
                totalPrice += itemTotal;

                html += `
                    <div class="cart-item row">
                        <div class="col-md-2">
                            <img src="/static/${item.dish.img_url || 'uploads/dish/default.png'}" class="dish-img rounded">
                        </div>
                        <div class="col-md-4">
                            <h6>${item.dish.dish_name}</h6>
                            <p class="text-muted">${item.dish.description || '无描述'}</p>
                            <small class="text-muted">商家：${item.dish.merchant_name || '未知商家'}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="text-danger fs-5">¥${item.dish.price.toFixed(2)}</span>
                        </div>
                        <div class="col-md-2">
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="updateQuantity(${item.id}, ${item.quantity + 1})"></button>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="fs-6 font-weight-bold">¥${itemTotal.toFixed(2)}</span>
                            <button class="btn btn-sm btn-danger mt-2" 
                                onclick="removeFromCart(${item.id})"></button>
                        </div>
                    </div>
                `;
            });

            // 更新DOM
            $('#cartList').html(html);
            $('#totalPrice').text('¥' + totalPrice.toFixed(2));
            $('#payBtn').prop('disabled', false);
            
            // 如果有商品，启用优惠券按钮
            $('#selectCouponBtn').prop('disabled', false);
            
            // 加载优惠券数量
            loadCouponCount();
            
            // 更新价格（包含优惠）
            updatePrices();
        }
        
        // 加载用户可用的优惠券数量
        function loadCouponCount() {
            const token = UserAuthManager.getToken();
            $.ajax({
                url: '/api/student/coupons/count',
                type: 'GET',
                headers: { 'Authorization': `Bearer ${token}` },
                success: function(res) {
                    if (res && res.code === 200) {
                        const count = res.data || 0;
                        $('#selectCouponBtn').text(`选择优惠券 (${count})`);
                    }
                },
                error: function() {
                    // 不显示错误，保持默认文本
                }
            });
        }
        

        
        // 初始化优惠券显示
        function initCouponDisplay() {
            console.log('初始化优惠券显示...');
            const savedCoupon = JSON.parse(localStorage.getItem('selectedCoupon'));
            if (savedCoupon) {
                console.log('找到已保存的优惠券:', savedCoupon);
                // 更新UI显示已选择的优惠券
                $('#selectedCouponName').text(savedCoupon.name);
                $('#selectedCouponInfo').removeClass('d-none');
                // 更新价格计算
                updatePrices();
            } else {
                console.log('未找到已保存的优惠券');
                // 确保优惠券信息区域隐藏
                $('#selectedCouponInfo').addClass('d-none');
            }
        }
        
        // 创建订单
        function createOrder() {
            // 验证是否有选中的地址
            const selectedAddress = localStorage.getItem('selectedAddress');
            if (!selectedAddress) {
                alert('请先选择收货地址');
                return;
            }
            
            // 获取选中的支付方式
            const selectedPayType = $('#payType').val() || 'wechat';
            
            // 获取购物车中的商品，检查是否来自同一商户
            const cartItems = JSON.parse(localStorage.getItem('currentCart')) || [];
            if (cartItems.length === 0) {
                alert('购物车为空');
                return;
            }
            
            // 检查所有商品是否来自同一商户
            const merchantIds = [...new Set(cartItems.map(item => item.dish.merchant_id))];
            if (merchantIds.length > 1) {
                alert('暂不支持跨商户下单，请分开结算');
                return;
            }
            
            // 获取选中的优惠券
            const selectedCoupon = JSON.parse(localStorage.getItem('selectedCoupon')) || null;
            // 调试信息 - 验证优惠券ID
            console.log('从localStorage获取的优惠券:', selectedCoupon);
            console.log('传递给后端的优惠券ID:', selectedCoupon ? selectedCoupon.id : null);
            
            // 添加加载状态
            const payBtn = $('#payBtn');
            const originalText = payBtn.text();
            payBtn.prop('disabled', true).text('处理中...');
            
            const token = UserAuthManager.getToken();
            const address = JSON.parse(selectedAddress);
            
            // 构建订单数据
            const orderData = {
                merchant_id: merchantIds[0],
                address: `${address.dormitory} ${address.room}`,
                pay_type: selectedPayType,
                coupon_id: selectedCoupon ? selectedCoupon.id : null,
                remark: $('#orderRemark').val() || ''
            };
            
            console.log('创建订单时传递的数据:', orderData);
            
            $.ajax({
                url: '/api/student/order/create',
                type: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                success: function (res) {
                    if (res && res.code === 200 && res.data) {
                        // 清除选中的优惠券
            localStorage.removeItem('selectedCoupon');
            
            // 清除购物车数据
            localStorage.removeItem('currentCart');
            
            // 模拟支付流程
            processPayment(res.data.order_id, res.data.pay_amount, selectedPayType);
                    } else {
                        alert('创建订单失败：' + (res ? res.msg : '未知错误'));
                    }
                },
                error: function () {
                    alert('网络错误，无法创建订单');
                },
                complete: function() {
                    // 恢复按钮状态
                    payBtn.prop('disabled', false).text(originalText);
                }
            });
        }
        
        // 处理支付流程
        function processPayment(orderId, amount, payType) {
            // 模拟支付过程
            console.log(`开始支付订单 ${orderId}，金额：${amount}，支付方式：${payType}`);
            
            // 这里应该调用实际的支付接口，现在简单模拟
            setTimeout(() => {
                // 模拟支付成功
                alert('支付成功！');
                // 跳转到订单页面
                window.location.href = '/student/orders';
            }, 1500);
        }
        
        // 保存当前购物车数据到localStorage
        function saveCartToLocalStorage(cartItems) {
            localStorage.setItem('currentCart', JSON.stringify(cartItems));
        }
        
        // 移除重复的退出登录函数，使用base.html中定义的全局logout函数
    </script>
{% endblock %}