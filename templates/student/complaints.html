{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}投诉评论 - 校园外卖平台{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
<li><a href="/student/index">首页</a></li>
<li><a href="/student/cart">购物车</a></li>
<li><a href="/student/orders">我的订单</a></li>
<li><a href="/student/profile">个人信息</a></li>
<li><a href="/student/complaints" class="active">投诉评论</a></li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">投诉评论管理</h5>
            <!-- <button class="btn btn-primary" onclick="showComplaintForm()">
                <i class="fas fa-plus me-1"></i>提交投诉
            </button> -->
        </div>
    </div>
    <div class="card-body">
        <!-- 标签页切换 -->
        <div class="mb-4">
            <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="complaints-tab" data-bs-toggle="tab"
                        data-bs-target="#complaints" type="button" role="tab" aria-controls="complaints"
                        aria-selected="true" onclick="loadComplaints(1, 'all')">投诉列表</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments"
                        type="button" role="tab" aria-controls="comments" aria-selected="false"
                        onclick="loadComments(1)">评论列表</button>
                </li>
            </ul>
        </div>

        <!-- 标签页内容 -->
        <div class="tab-content" id="contentTabsContent">
            <!-- 投诉列表 -->
            <div class="tab-pane fade show active" id="complaints" role="tabpanel" aria-labelledby="complaints-tab">
                <div class="mb-4">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-outline-primary active"
                            onclick="filterComplaints('all')">全部</button>
                        <button class="btn btn-sm btn-outline-secondary"
                            onclick="filterComplaints('pending')">待处理</button>
                        <button class="btn btn-sm btn-outline-secondary"
                            onclick="filterComplaints('processing')">处理中</button>
                        <button class="btn btn-sm btn-outline-secondary"
                            onclick="filterComplaints('resolved')">已解决</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>投诉内容</th>
                                <th>涉及订单</th>
                                <th>投诉时间</th>
                                <th>状态</th>
                                <th>处理结果</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="complaintsTable">
                            <!-- 投诉列表将通过JavaScript动态加载 -->
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 d-flex justify-content-center" id="complaintsPagination">
                    <!-- 投诉分页控件将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 评论列表 -->
            <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>评论内容</th>
                                <th>涉及订单</th>
                                <th>菜品评分</th>
                                <th>服务评分</th>
                                <th>评论时间</th>
                                <th>商家回复</th>
                                <th>回复时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="commentsTable">
                            <!-- 评论列表将通过JavaScript动态加载 -->
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 d-flex justify-content-center" id="commentsPagination">
                    <!-- 评论分页控件将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 订单详情模态框 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailModalLabel">订单详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 订单详情内容将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 检查登录状态
    $(document).ready(function () {
        const token = localStorage.getItem('student_token');
        if (!token) {
            window.location.href = '/student/login';
            return;
        }

        // 更新用户名显示
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        $('#userName').text(userInfo.name || '学生');

        // 设置侧边栏激活状态
        $('.nav-link').removeClass('active');
        $('.nav-link[href="/student/complaints"]').addClass('active');

        // 设置初始显示状态为投诉列表
        $('#contentTabs .nav-link').removeClass('active');
        $('#contentTabs .nav-link[aria-controls="complaints"]').addClass('active');
        $('#contentTabsContent .tab-pane').removeClass('show active');
        $('#contentTabsContent #complaints').addClass('show active');

        // 加载投诉列表
        loadComplaints(1, 'all');
        // 预加载评论列表
        loadComments(1);
    });

    // 加载投诉列表
    function loadComplaints(page = 1, status = 'all') {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/complaints?page=${page}&status=${status}`,
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    renderComplaintsTable(res.data.items);
                    renderPagination(res.data.total, res.data.page, res.data.page_size, status);
                } else {
                    alert('获取投诉列表失败：' + res.msg);
                    $('#complaintsTable').html('<tr><td colspan="6" class="text-center text-muted">加载失败</td></tr>');
                }
            },
            error: function () {
                alert('网络错误，请稍后重试');
                $('#complaintsTable').html('<tr><td colspan="6" class="text-center text-muted">网络错误</td></tr>');
            }
        });
    }

    // 渲染投诉列表
    function renderComplaintsTable(complaints) {
        if (!complaints || complaints.length === 0) {
            $('#complaintsTable').html('<tr><td colspan="6" class="text-center text-muted">暂无投诉记录</td></tr>');
            return;
        }

        let html = '';
        complaints.forEach(complaint => {
            let statusText, statusClass;
            switch (complaint.status) {
                case 'pending':
                    statusText = '待处理';
                    statusClass = 'badge bg-warning';
                    break;
                case 'processing':
                    statusText = '处理中';
                    statusClass = 'badge bg-info';
                    break;
                case 'resolved':
                    statusText = '已解决';
                    statusClass = 'badge bg-success';
                    break;
                default:
                    statusText = '未知';
                    statusClass = 'badge bg-secondary';
            }

            html += `
                    <tr>
                        <td>
                            ${complaint.content || '-'}
                            ${complaint.img_urls && complaint.img_urls.length > 0 ? `
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    ${complaint.img_urls.map(img => `
                                        <img src="${img}" alt="投诉图片" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${img}');">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </td>
                        <td>
                            ${complaint.order_no ?
                    `<a href="javascript:void(0);" onclick="viewOrderDetail('${complaint.order_id}');" class="text-primary">${complaint.order_no}</a>` :
                    '-'}
                        </td>
                        <td>${formatDate(complaint.created_at)}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${complaint.response || '-'}</td>
                        <td>
                            ${complaint.status === 'pending' || complaint.status === 'resolved' ?
                    `<button class="btn btn-sm btn-outline-danger" onclick="deleteComplaint(${complaint.id})">删除</button>` :
                    '<span class="text-muted">无操作</span>'}
                        </td>
                    </tr>
                `;
        });

        $('#complaintsTable').html(html);
    }

    // 渲染投诉分页
    function renderComplaintsPagination(total, currentPage, pageSize, status) {
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) {
            $('#complaintsPagination').html('');
            return;
        }

        let html = '<nav aria-label="Complaints pagination">';
        html += '<ul class="pagination">';

        // 上一页
        html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComplaints(${currentPage - 1}, '${status}')" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;

        // 页码
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadComplaints(${i}, '${status}')">${i}</a>
                        </li>
                    `;
            } else if ((i === currentPage - 2 || i === currentPage + 2) && totalPages > 5) {
                html += '<li class="page-item"><span class="page-link">...</span></li>';
            }
        }

        // 下一页
        html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComplaints(${currentPage + 1}, '${status}')" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;

        html += '</ul></nav>';
        $('#complaintsPagination').html(html);
    }

    // 加载评论列表
    function loadComments(page = 1, pageSize = 10) {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/comments?page=${page}&page_size=${pageSize}`,
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    renderCommentsList(res.data.items);
                    renderCommentsPagination(res.data.total, res.data.page, res.data.page_size);
                } else {
                    console.error('加载评论失败:', res.msg);
                    $('#commentsTable').html('<tr><td colspan="8" class="text-center text-danger">加载失败，请稍后重试</td></tr>');
                }
            },
            error: function () {
                $('#commentsTable').html('<tr><td colspan="8" class="text-center text-danger">网络错误，请稍后重试</td></tr>');
            }
        });
    }

    // 渲染评论列表
    function renderCommentsList(comments) {
        if (!comments || comments.length === 0) {
            $('#commentsTable').html('<tr><td colspan="8" class="text-center text-muted">暂无评论记录</td></tr>');
            return;
        }

        let html = '';
        comments.forEach(comment => {
            html += `
                    <tr>
                        <td>
                            ${comment.content || '-'}
                            ${comment.img_urls && comment.img_urls.length > 0 ? `
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    ${comment.img_urls.map(img => `
                                        <img src="${img}" alt="评论图片" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${img}');">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </td>
                        <td>
                            ${comment.order_no ?
                    `<a href="javascript:void(0);" onclick="viewOrderDetail('${comment.order_id}');" class="text-primary">${comment.order_no}</a>` :
                    '-'}
                        </td>
                        <td>${renderStars(comment.dish_score)}</td>
                        <td>${renderStars(comment.service_score)}</td>
                        <td>${comment.create_time}</td>
                        <td>${comment.merchant_reply || '-'}</td>
                        <td>${comment.reply_time || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id})">删除</button>
                        </td>
                    </tr>
                `;
        });

        $('#commentsTable').html(html);
    }

    // 渲染星级评分
    function renderStars(score) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= score) {
                stars += '<i class="fa fa-star text-warning"></i>';
            } else {
                stars += '<i class="fa fa-star-o text-secondary"></i>';
            }
        }
        return stars;
    }

    // 渲染评论分页
    function renderCommentsPagination(total, currentPage, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) {
            $('#commentsPagination').html('');
            return;
        }

        let html = '<nav aria-label="Comments pagination">';
        html += '<ul class="pagination">';

        // 上一页
        html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${currentPage - 1})" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;

        // 页码
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadComments(${i})">${i}</a>
                        </li>
                    `;
            } else if ((i === currentPage - 2 || i === currentPage + 2) && totalPages > 5) {
                html += '<li class="page-item"><span class="page-link">...</span></li>';
            }
        }

        // 下一页
        html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${currentPage + 1})" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;

        html += '</ul></nav>';
        $('#commentsPagination').html(html);
    }

    // 删除评论
    function deleteComment(commentId) {
        if (!confirm('确定要删除这条评论吗？')) return;

        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/comments/${commentId}`,
            type: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    loadComments(1);
                    alert('评论删除成功！');
                } else {
                    alert('评论删除失败：' + res.msg);
                }
            },
            error: function (xhr) {
                try {
                    const res = JSON.parse(xhr.responseText);
                    alert('评论删除失败：' + res.msg);
                } catch (e) {
                    alert('网络错误，请稍后重试');
                }
            }
        });
    }

    // 显示投诉表单
    function showComplaintForm() {
        loadOrdersForComplaint();
        $('#complaintModal').modal('show');
    }

    // 加载可投诉的订单
    function loadOrdersForComplaint() {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: '/api/student/orders?status=completed',
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    const orderSelect = $('#complaint-order');
                    orderSelect.empty();
                    orderSelect.append('<option value="">无关联订单</option>');

                    res.data.items.forEach(order => {
                        orderSelect.append(`
                                <option value="${order.id}">订单号：${order.order_no} - ${order.created_at}</option>
                            `);
                    });

                    // 添加订单选择变化事件
                    orderSelect.change(function () {
                        const selectedOrder = $(this).val();
                        if (selectedOrder === '') {
                            // 显示商户选择部分并加载商户列表
                            $('#merchantSection').show();
                            loadMerchants();
                        } else {
                            // 隐藏商户选择部分
                            $('#merchantSection').hide();
                        }
                    });
                }
            }
        });
    }

    // 加载商户列表
    function loadMerchants() {
        $.ajax({
            url: '/api/common/merchants',
            type: 'GET',
            success: function (res) {
                if (res.code === 200) {
                    const merchantSelect = $('#complaint-merchant');
                    merchantSelect.empty();
                    merchantSelect.append('<option value="">请选择商户</option>');

                    res.data.forEach(merchant => {
                        merchantSelect.append(`
                                <option value="${merchant.id}">${merchant.name}</option>
                            `);
                    });
                }
            }
        });
    }

    // 提交投诉
    function submitComplaint() {
        const content = $('#complaint-content').val().trim();
        const orderId = $('#complaint-order').val();
        const merchantId = $('#complaint-merchant').val();
        const images = $('#complaint-images')[0].files;

        if (!content) {
            alert('请输入投诉内容');
            return;
        }

        if (content.trim().length < 10) {
            alert('投诉内容至少需要10个字符');
            return;
        }

        if (!orderId && !merchantId) {
            alert('请选择关联订单或商户');
            return;
        }

        // 创建FormData对象
        const formData = new FormData();
        formData.append('content', content);
        if (orderId) formData.append('order_id', orderId);
        if (merchantId) formData.append('merchant_id', merchantId);

        // 添加图片
        for (let i = 0; i < images.length; i++) {
            formData.append('images', images[i]);
        }

        const token = localStorage.getItem('student_token');
        $.ajax({
            url: '/api/student/complaints',
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: false, // 不设置contentType，由浏览器自动设置
            processData: false, // 不处理数据，保持FormData格式
            data: formData,
            success: function (res) {
                if (res.code === 200) {
                    $('#complaintModal').modal('hide');
                    $('#complaintForm')[0].reset();
                    loadComplaints(1, 'all');
                    alert('投诉提交成功！');
                } else {
                    alert('投诉提交失败：' + res.msg);
                }
            },
            error: function (xhr) {
                try {
                    const res = JSON.parse(xhr.responseText);
                    alert('投诉提交失败：' + res.msg);
                } catch (e) {
                    alert('网络错误，请稍后重试');
                }
            }
        });
    }

    // 删除投诉
    function deleteComplaint(complaintId) {
        if (!confirm('确定要删除这条投诉吗？')) return;

        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/complaints/${complaintId}`,
            type: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    loadComplaints(1, 'all');
                    alert('投诉删除成功！');
                } else {
                    alert('投诉删除失败：' + res.msg);
                }
            },
            error: function () {
                alert('网络错误，请稍后重试');
            }
        });
    }

    // 筛选投诉
    function filterComplaints(status) {
        // 更新按钮状态
        $('.btn-outline-primary, .btn-outline-secondary').removeClass('active btn-outline-primary').addClass('btn-outline-secondary');
        const btn = status === 'all' ? $('.btn-outline-secondary:first') : $(`button[onclick="filterComplaints('${status}')"]`);
        btn.addClass('active btn-outline-primary').removeClass('btn-outline-secondary');

        // 重新加载投诉列表
        loadComplaints(1, status);
    }

    // 格式化日期
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 查看订单详情
    function viewOrderDetail(orderId) {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/orders/${orderId}`,
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    showOrderDetail(res.data);
                } else {
                    alert('获取订单详情失败：' + res.msg);
                }
            }
        });
    }

    // 显示订单详情
    function showOrderDetail(order) {
        const statusMap = {
            // 中文状态值映射
            '待支付': { text: '待支付', class: 'bg-warning text-white' },
            '已支付': { text: '已支付', class: 'bg-info text-white' },
            '待接单': { text: '待接单', class: 'bg-info text-white' },
            '待配送': { text: '配送中', class: 'bg-primary text-white' },
            '已完成': { text: '已送达', class: 'bg-success text-white' },
            '已送达': { text: '已送达', class: 'bg-success text-white' },
            '已取消': { text: '已取消', class: 'bg-secondary text-white' },
            // 兼容英文状态值
            'pending': { text: '待支付', class: 'bg-warning text-white' },
            'preparing': { text: '待接单', class: 'bg-info text-white' },
            'delivering': { text: '配送中', class: 'bg-primary text-white' },
            'delivered': { text: '已送达', class: 'bg-success text-white' },
            'cancelled': { text: '已取消', class: 'bg-secondary text-white' }
        };
        const statusInfo = statusMap[order.status] || { text: '未知状态', class: 'bg-gray text-white' };

        let html = `
                <dl class="row mb-3">
                    <dt class="col-sm-3">订单编号：</dt>
                    <dd class="col-sm-9">${order.order_no}</dd>
                    <dt class="col-sm-3">订单ID：</dt>
                    <dd class="col-sm-9">${order.order_id}</dd>
                    <dt class="col-sm-3">订单状态：</dt>
                    <dd class="col-sm-9"><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></dd>
                    <dt class="col-sm-3">商户名称：</dt>
                    <dd class="col-sm-9">${order.merchant.name}</dd>
                    <dt class="col-sm-3">下单时间：</dt>
                    <dd class="col-sm-9">${formatDate(order.created_at)}</dd>
            `;

        // 显示支付时间（如果有）
        if (order.pay_time) {
            html += `
                    <dt class="col-sm-3">支付时间：</dt>
                    <dd class="col-sm-9">${formatDate(order.pay_time)}</dd>
            `;
        }

        // 显示完成时间（如果有）
        if (order.finish_time) {
            html += `
                    <dt class="col-sm-3">完成时间：</dt>
                    <dd class="col-sm-9">${formatDate(order.finish_time)}</dd>
            `;
        }

        html += `
                    <dt class="col-sm-3">收货地址：</dt>
                    <dd class="col-sm-9">${order.address}</dd>
            `;

        // 显示备注（如果有）
        if (order.remark) {
            html += `
                    <dt class="col-sm-3">备注：</dt>
                    <dd class="col-sm-9">${order.remark}</dd>
            `;
        }

        html += `
                </dl>
                <h6 class="mb-2">商品清单</h6>
                <table class="table table-sm mb-3">
                    <thead>
                        <tr>
                            <th>商品名称</th>
                            <th>单价</th>
                            <th>数量</th>
                            <th>小计</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        let subtotal = 0;
        order.items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            html += `
                    <tr>
                        <td>${item.dish_name}</td>
                        <td>¥${item.price}</td>
                        <td>${item.quantity}</td>
                        <td>¥${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
        });

        html += `
                    </tbody>
                </table>
                <div class="text-start">
                    <div class="d-flex mb-2">
                        <span style="width: 80px;">商品总价：</span>
                        <span>¥${subtotal.toFixed(2)}</span>
                    </div>
                    ${order.discount_amount > 0 ? `
                    <div class="d-flex mb-2">
                        <span style="width: 80px;">优惠金额：</span>
                        <span class="text-success">-¥${order.discount_amount.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div class="d-flex mb-2">
                        <span style="width: 80px;">配送费：</span>
                        <span>¥${order.delivery_fee.toFixed(2)}</span>
                    </div>
                    <div class="d-flex font-bold">
                        <span style="width: 80px;">实付金额：</span>
                        <span class="text-danger">¥${order.pay_amount.toFixed(2)}</span>
                    </div>
                </div>
            `;

        $('#orderDetailContent').html(html);
        $('#orderDetailModal').modal('show');
    }

    // 打开图片预览模态框
    function openImagePreview(imgUrl) {
        $('#imagePreviewSrc').attr('src', imgUrl);
        $('#imagePreviewModal').modal('show');
    }

    // 退出登录
    function logout() {
        localStorage.removeItem('student_token');
        localStorage.removeItem('userInfo');
        window.location.href = '/student/login';
    }
</script>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header p-1 border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body p-1 d-flex justify-content-center align-items-center">
                <img id="imagePreviewSrc" src="" alt="预览图片" class="img-fluid"
                    style="max-height: 80vh; max-width: 100%;">
            </div>
        </div>
    </div>
</div>

<!-- 投诉表单模态框 -->
<div class="modal fade" id="complaintModal" tabindex="-1" aria-labelledby="complaintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="complaintModalLabel">提交投诉</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="complaintForm">
                    <div class="mb-3">
                        <label for="complaint-order" class="form-label">关联订单（可选）</label>
                        <select class="form-select" id="complaint-order">
                            <option value="">无关联订单</option>
                            <!-- 订单选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="mb-3" id="merchantSection" style="display: none;">
                        <label for="complaint-merchant" class="form-label">选择商户 <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="complaint-merchant">
                            <option value="">请选择商户</option>
                            <!-- 商户选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="complaint-content" class="form-label">投诉内容 <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="complaint-content" rows="5"
                            placeholder="请详细描述您的投诉内容，至少10个字符"></textarea>
                        <div class="form-text text-muted">请准确、客观地描述问题，以便我们更好地为您解决。</div>
                    </div>
                    <div class="mb-3">
                        <label for="complaint-images" class="form-label">上传图片（可选）</label>
                        <input type="file" class="form-control" id="complaint-images" multiple accept="image/*">
                        <div class="form-text text-muted">最多上传9张图片，每张图片不超过5MB</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <!-- <button type="button" class="btn btn-primary" onclick="submitComplaint()">提交投诉</button> -->
            </div>
        </div>
    </div>
</div>
{% endblock %}