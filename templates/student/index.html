{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}校园美食 - 首页{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
<li><a href="/student/index" class="active">首页</a></li>
<li><a href="/student/cart">购物车</a></li>
<li><a href="/student/orders">我的订单</a></li>
<li><a href="/student/profile">个人信息</a></li>
<li><a href="/student/complaints">我的投诉</a></li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h5 class="mb-0 me-3">推荐商家</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="showAllMerchants()">全部商家</button>
        </div>
        <div class="d-flex gap-3">
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" class="form-control" placeholder="搜索商家..." id="searchMerchant">
                <button class="btn btn-outline-secondary" onclick="searchMerchants()">搜索</button>
            </div>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" class="form-control" placeholder="搜索菜品..." id="searchDish">
                <button class="btn btn-outline-secondary" onclick="searchDishes()">搜索</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            <span>分类筛选</span>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#categoryCollapse" aria-expanded="true"
                                aria-controls="categoryCollapse">
                            </button>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="collapse show p-3" id="categoryCollapse">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="category" id="categoryAll"
                                    value="categoryAll" checked>
                                <label class="form-check-label" for="categoryAll">
                                    全部分类
                                </label>
                            </div>
                            <div class="category-list" id="categoryList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="row" id="merchantList"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block scripts %}
<script>
    $(function () {
        const token = localStorage.getItem('student_token');
        if (!token) {
            window.location.href = '/student/login';
            return;
        }

        // 尝试获取学生信息，但即使获取失败也继续执行
        try {
            const studentInfo = JSON.parse(localStorage.getItem('studentInfo'));
            if (studentInfo && studentInfo.name) {
                $('#userName').text(studentInfo.name);
            }
        } catch (e) {
            console.error('获取学生信息失败:', e);
        }

        // 加载分类
        loadCategories();

        // 默认显示所有菜品（全部分类）
        showDefaultContent();

        // 设置当前菜单激活状态
        const currentPath = window.location.pathname;
        $('.sidebar-menu a').each(function () {
            if ($(this).attr('href') === currentPath) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
    });

    // 加载商家列表
    function loadMerchants() {
        $.ajax({
            url: '/api/common/merchants',
            success: function (res) {
                if (res.code === 200) {
                    renderMerchantList(res.data);
                }
            }
        });
    }

    // 加载分类（使用菜品类别）
    function loadCategories() {
        // 使用菜品类别作为分类选项
        const categories = [
            { id: '川菜', name: '川菜' },
            { id: '粤菜', name: '粤菜' },
            { id: '湘菜', name: '湘菜' },
            { id: '东北菜', name: '东北菜' },
            { id: '西北菜', name: '西北菜' },
            { id: '快餐', name: '快餐' },
            { id: '火锅', name: '火锅' },
            { id: '烧烤', name: '烧烤' },
            { id: '面食', name: '面食' },
            { id: '甜品', name: '甜品' },
            { id: '饮品', name: '饮品' },
            { id: '其他', name: '其他' }
        ];

        let html = '';
        categories.forEach(category => {
            html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="category" id="category_${category.id}" value="${category.id}">
                        <label class="form-check-label" for="category_${category.id}">
                            ${category.name}
                        </label>
                    </div>
                `;
        });
        $('#categoryList').html(html);
    }

    // 渲染商家列表
    function renderMerchantList(merchants) {
        let html = '';
        if (merchants.length === 0) {
            html = '<div class="col-12 text-center text-muted py-4">暂无商家</div>';
        } else {
            merchants.forEach(merchant => {
                html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <img src="/static/${merchant.logo || 'uploads/merchant/default.svg'}" class="card-img-top" alt="${merchant.merchant_name || merchant.name}" style="height: 180px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${merchant.name}</h5>
                                    <p class="card-text text-muted">${merchant.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-success">月售${merchant.month_sales || 0}</span>
                                        <button onclick="viewMerchantDetails(${merchant.id})" class="btn btn-primary btn-sm">查看商家</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            });
        }
        $('#merchantList').html(html);
    }

    // 渲染菜品列表
    function renderDishList(dishes) {
        let html = '';
        if (dishes.length === 0) {
            html = '<div class="col-12 text-center text-muted py-4">暂无菜品</div>';
        } else {
            dishes.forEach(dish => {
                html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <img src="/static/${dish.img_url || 'uploads/dish/default.jpg'}" class="card-img-top" alt="${dish.name}" style="height: 180px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${dish.name}</h5>
                                    <p class="card-text text-muted">${dish.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger">¥${dish.price}</span>
                                        <span class="text-success">月售${dish.sales || 0}</span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="badge bg-secondary">${dish.category}</span>
                                        <span class="text-muted ms-2">${dish.merchant_name}</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm mt-2" onclick="viewMerchantDetails(${dish.merchant_id})">查看菜品</button>
                                </div>
                            </div>
                        </div>
                    `;
            });
        }
        $('#merchantList').html(html);
    }

    // 搜索商家
    function searchMerchants() {
        const keyword = $('#searchMerchant').val().trim();

        // 清空菜品搜索框
        $('#searchDish').val('');

        if (keyword) {
            $.ajax({
                url: '/api/common/merchants',
                success: function (res) {
                    if (res.code === 200) {
                        let filteredMerchants = res.data;

                        // 按关键词过滤
                        filteredMerchants = filteredMerchants.filter(merchant =>
                            merchant.name.toLowerCase().includes(keyword.toLowerCase())
                        );

                        renderMerchantList(filteredMerchants);
                    }
                }
            });
        } else {
            // 显示默认内容
            showDefaultContent();
        }
    }

    // 搜索菜品
    function searchDishes() {
        const keyword = $('#searchDish').val().trim();

        // 清空商家搜索框
        $('#searchMerchant').val('');

        if (keyword) {
            $.ajax({
                url: '/api/common/all_dishes',
                success: function (res) {
                    if (res.code === 200) {
                        let filteredDishes = res.data;

                        // 按关键词过滤
                        filteredDishes = filteredDishes.filter(dish =>
                            dish.name.toLowerCase().includes(keyword.toLowerCase())
                        );

                        renderDishList(filteredDishes);
                    }
                }
            });
        } else {
            // 显示默认内容
            showDefaultContent();
        }
    }

    // 显示默认内容
    function showDefaultContent() {
        // 恢复页面标题
        $('#page_title').text('校园美食 - 首页');

        // 显示分类筛选面板
        $('#categoryList').closest('.col-md-3').show();

        // 恢复内容区域布局
        $('#merchantList').closest('.col-12').removeClass('col-12').addClass('col-md-9');

        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 获取选中的分类
        const category = $('input[name="category"]:checked').val();

        // 如果选择了全部分类，显示所有菜品
        if (category === 'categoryAll' || category === undefined) {
            // 查询所有菜品
            $.ajax({
                url: '/api/common/all_dishes',
                success: function (res) {
                    if (res.code === 200) {
                        renderDishList(res.data);
                    }
                }
            });
        } else {
            // 否则，根据菜品类别筛选菜品
            $.ajax({
                url: `/api/common/dishes_by_category?category=${encodeURIComponent(category)}`,
                success: function (res) {
                    if (res.code === 200) {
                        renderDishList(res.data);
                    }
                }
            });
        }
    }

    // 显示所有商家
    function showAllMerchants() {
        loadMerchants();
    }

    // 查看商家详情
    function viewMerchantDetails(merchantId) {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 先获取所有商家，找到对应商家的信息
        $.ajax({
            url: '/api/common/merchants',
            success: function (merchantsRes) {
                if (merchantsRes.code === 200) {
                    const merchant = merchantsRes.data.find(m => m.id === merchantId);
                    if (merchant) {
                        // 获取该商家的菜品
                        $.ajax({
                            url: `/api/common/dishes/${merchantId}`,
                            success: function (dishesRes) {
                                if (dishesRes.code === 200) {
                                    // 显示商家详情和菜品
                                    renderMerchantDetails(merchant, dishesRes.data);
                                }
                            }
                        });
                    }
                }
            }
        });
    }

    // 渲染商家详情和菜品
    function renderMerchantDetails(merchant, dishes) {
        // 更新页面标题
        $('#page_title').text(`${merchant.name} - 商家详情`);

        // 构建完整的商家介绍HTML
        const merchantInfoHtml = `
            <div class="col-12 mb-6">
                <div class="card">
                    <!-- 商家头部大图 -->
                    <div class="bg-warning py-10 px-6 text-dark relative">
                        <!-- 返回首页按钮 - 匹配查看商家样式 -->
                        <button onclick="showDefaultContent()" class="absolute top-4 right-4 btn btn-primary btn-sm">
                            <i class="bi bi-arrow-left mr-2"></i>返回首页
                        </button>

                        <div class="d-flex align-items-center">
                            <img src="/static/${merchant.logo || 'uploads/merchant/default.svg'}" 
                                 alt="${merchant.name}" 
                                 style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 4px solid white;"
                                 class="mr-6">
                            <div class="flex-grow-1">
                                <h2 class="mb-3">${merchant.name}</h2>
                                <p class="mb-4 text-white-80">${merchant.description || '暂无商家介绍'}</p>
                                <div class="d-flex flex-wrap gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${merchant.month_sales || 0}</div>
                                        <div class="text-sm text-white-80">月售</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">5.0</div>
                                        <div class="text-sm text-white-80">评分</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">20</div>
                                        <div class="text-sm text-white-80">起送</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">¥${merchant.service_fee || 5}</div>
                                        <div class="text-sm text-white-80">配送费</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 商家信息 -->
                    <div class="p-4 border-bottom">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="text-secondary"><i class="bi bi-geo-alt mr-2"></i>地址</div>
                            <div>${merchant.address || '暂无地址信息'}</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="text-secondary"><i class="bi bi-phone mr-2"></i>电话</div>
                            <div>${merchant.contact_phone || '暂无联系电话'}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 菜品列表标题 -->
            <div class="col-12 mb-4">
                <h3 class="border-bottom pb-2">
                    <i class="bi bi-utensils mr-2"></i>菜品列表
                </h3>
            </div>
        `;

        // 构建菜品列表HTML
        let dishesHtml = '';
        if (dishes.length === 0) {
            dishesHtml = '<div class="col-12 text-center text-muted py-10">该商家暂无上架菜品</div>';
        } else {
            // 按分类分组菜品
            const dishesByCategory = {};
            dishes.forEach(dish => {
                if (!dishesByCategory[dish.category]) {
                    dishesByCategory[dish.category] = [];
                }
                dishesByCategory[dish.category].push(dish);
            });

            // 遍历分类构建菜品HTML
            Object.keys(dishesByCategory).forEach(category => {
                dishesHtml += `
                    <div class="col-12 mb-6">
                        <div class="bg-light p-3 mb-4">
                            <h4 class="mb-0">${category}</h4>
                        </div>
                        <div class="row">
                `;

                dishesByCategory[category].forEach(dish => {
                    dishesHtml += `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <img src="/static/${dish.img_url || 'uploads/dish/default.jpg'}" 
                                     class="card-img-top" 
                                     alt="${dish.name}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${dish.name}</h5>
                                    <p class="card-text text-muted small mb-3">${dish.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger font-bold">¥${dish.price}</span>
                                        <button class="btn btn-primary" onclick="addToCart(${dish.id})">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                dishesHtml += `
                        </div>
                    </div>
                `;
            });
        }

        // 组合HTML并更新页面内容区域
        $('#merchantList').html(merchantInfoHtml + dishesHtml);
    }

    // 分类筛选
    $(document).on('click', 'input[name="category"]', function (e) {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 如果点击的是已经选中的分类
        if (this.checked) {
            // 直接调用showDefaultContent重新加载内容
            showDefaultContent();
        }
    });

    // 同时保留change事件处理，确保两种情况下都能正常工作
    $(document).on('change', 'input[name="category"]', function () {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');
        showDefaultContent();
    });

    function logout() {
        localStorage.removeItem('student_token');
        localStorage.removeItem('studentInfo');
        window.location.href = '/student/login';
    }
</script>
{% endblock %}