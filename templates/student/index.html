{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}校园美食 - 首页{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
<li><a href="/student/index" class="active">首页</a></li>
<li><a href="/student/cart">购物车</a></li>
<li><a href="/student/orders">我的订单</a></li>
<li><a href="/student/profile">个人信息</a></li>
<li><a href="/student/complaints">投诉评论</a></li>
{% endblock %}

{% block content %}
<style>
    /* 购物车按钮和弹框样式 */
    /* 移除可能冲突的样式定义 */
    #cartButton {
        transition: all 0.3s ease;
    }

    #cartButton:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* 确保hidden类有正确的样式 */
    .hidden {
        display: none !important;
    }

    #cartDropdown {
        transition: all 0.3s ease;
        transform-origin: bottom right;
        animation: cartSlideIn 0.3s ease-out;
    }

    @keyframes cartSlideIn {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(10px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .cart-item {
        transition: all 0.2s ease;
    }

    .cart-item:hover {
        background-color: #f8f9fa;
    }

    .decrease-btn,
    .increase-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .decrease-btn:hover,
    .increase-btn:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* 确保购物车弹框在移动端也能正常显示 */
    @media (max-width: 768px) {
        #cartDropdown {
            width: 90vw;
            max-width: 320px;
        }

        .cart-item {
            padding: 12px;
        }

        .cart-item img {
            width: 48px;
            height: 48px;
        }
    }

    /* 展开状态：显示向下箭头，隐藏向上箭头 */
    .btn[aria-expanded="true"] .expand-icon {
        display: inline;
    }

    .btn[aria-expanded="true"] .collapse-icon {
        display: none;
    }

    /* 收起状态：显示向上箭头，隐藏向下箭头 */
    .btn[aria-expanded="false"] .expand-icon {
        display: none;
    }

    .btn[aria-expanded="false"] .collapse-icon {
        display: inline;
    }
</style>
<!-- 引入 Bootstrap Icons 字体库, 用于上下箭头图标显示 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h5 class="mb-0 me-3">推荐商家</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="showAllMerchants()">全部商家</button>
        </div>
        <div class="d-flex gap-3">
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" class="form-control" placeholder="搜索商家..." id="searchMerchant">
                <button class="btn btn-outline-secondary" onclick="searchMerchants()">搜索</button>
            </div>
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" class="form-control" placeholder="搜索菜品..." id="searchDish">
                <button class="btn btn-outline-secondary" onclick="searchDishes()">搜索</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            <span>分类筛选</span>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#categoryCollapse" aria-expanded="true"
                                aria-controls="categoryCollapse">
                                <!-- <span class="collapse-icon collapse-btn-icon">▼</span>
                                <span class="expand-icon collapse-btn-icon">▲</span> -->
                                <!-- 展开（向下）图标 -->
                                <i class="bi bi-chevron-down collapse-icon"></i>
                                <!-- 收起（向上）图标 -->
                                <i class="bi bi-chevron-up expand-icon"></i>
                            </button>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="collapse show p-3" id="categoryCollapse">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="category" id="categoryAll"
                                    value="categoryAll" checked>
                                <label class="form-check-label" for="categoryAll">
                                    全部分类
                                </label>
                            </div>
                            <div class="category-list" id="categoryList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="row" id="merchantList"></div>
            </div>
        </div>
    </div>
</div>

<!-- 购物车弹框按钮和弹框 -->
<div id="cartButtonContainer"
    style="position: fixed; bottom: 40px; right: 40px; z-index: 9999; display: block !important; cursor: move; user-select: none; background-color: rgba(255, 255, 255, 0.7); border-radius: 45px; padding: 5px;">
    <script>
        // 购物车按钮拖拽功能实现
        document.addEventListener('DOMContentLoaded', function () {
            const cartButtonContainer = document.getElementById('cartButtonContainer');
            let isDragging = false;
            let offsetX, offsetY;

            // 鼠标按下事件，开始拖拽
            cartButtonContainer.addEventListener('mousedown', function (e) {
                // 只有点击购物车按钮容器本身才触发拖拽，避免点击按钮时触发
                if (e.target === cartButtonContainer) {
                    isDragging = true;
                    const rect = cartButtonContainer.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    // 添加拖拽中样式
                    cartButtonContainer.style.opacity = '0.8';
                    cartButtonContainer.style.transition = 'none';
                }
            });

            // 鼠标移动事件，更新位置
            document.addEventListener('mousemove', function (e) {
                if (isDragging) {
                    // 计算新位置，确保不超出浏览器视口
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;

                    // 限制在视口范围内
                    const containerWidth = cartButtonContainer.offsetWidth;
                    const containerHeight = cartButtonContainer.offsetHeight;

                    newX = Math.max(0, Math.min(window.innerWidth - containerWidth, newX));
                    newY = Math.max(0, Math.min(window.innerHeight - containerHeight, newY));

                    // 更新位置
                    cartButtonContainer.style.left = newX + 'px';
                    cartButtonContainer.style.top = newY + 'px';
                    cartButtonContainer.style.bottom = 'auto';
                    cartButtonContainer.style.right = 'auto';
                }
            });

            // 鼠标松开事件，结束拖拽
            document.addEventListener('mouseup', function () {
                if (isDragging) {
                    isDragging = false;
                    // 恢复正常样式
                    cartButtonContainer.style.opacity = '1';
                    cartButtonContainer.style.transition = 'all 0.3s ease';
                }
            });
        });
    </script>
    <button id="cartButton"
        style="width: 70px; height: 70px; border-radius: 50%; background-color: #ff6b6b; color: white; border: 3px solid #ff8787; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5); cursor: pointer; z-index: 9999; transition: all 0.3s ease;"
        onclick="event.stopPropagation(); $('#cartDropdown').toggleClass('hidden'); updateCartItems();">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
            <path
                d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z">
            </path>
        </svg>
        <span id="cartCount"
            style="position: absolute; top: -10px; right: -10px; background-color: #ff3333; color: white; font-size: 14px; font-weight: bold; min-width: 26px; height: 26px; border-radius: 13px; display: flex; align-items: center; justify-content: center; padding: 0 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">0</span>
    </button>
    <div id="cartDropdown"
        class="hidden absolute bottom-full right-0 mb-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50 max-h-96 overflow-y-auto">
        <div class="p-3 border-b">
            <h5 class="mb-0">购物车</h5>
        </div>
        <div id="cartItems" class="p-3">
            <div id="emptyCart" class="text-center text-muted py-3">购物车是空的</div>
            <div id="cartItemsList" class="hidden">
                <!-- 这里会动态生成购物车菜品列表 -->
                <!-- 示例菜品项模板 -->
                <!-- 
                <div class="cart-item mb-3 p-2 border rounded" data-id="1">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="font-medium">菜品名称</div>
                            <div class="text-danger">¥20.00</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary decrease-btn">-</button>
                            <span class="mx-2">1</span>
                            <button class="btn btn-sm btn-outline-secondary increase-btn">+</button>
                        </div>
                    </div>
                </div>
                -->
            </div>
        </div>
        <div class="p-3 border-t">
            <div class="d-flex justify-content-between mb-3">
                <span class="font-bold">合计：</span>
                <span id="totalPrice" class="text-danger font-bold">¥0.00</span>
            </div>
            <div class="d-flex gap-2">
                <button id="checkoutButton" class="btn btn-danger flex-grow-1">去结算</button>
                <button id="clearCartButton" class="btn btn-outline-secondary">清空</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(function () {
        const token = localStorage.getItem('student_token');
        if (!token) {
            window.location.href = '/student/login';
            return;
        }

        // 尝试获取学生信息，但即使获取失败也继续执行
        try {
            const studentInfo = JSON.parse(localStorage.getItem('studentInfo'));
            if (studentInfo && studentInfo.name) {
                $('#userName').text(studentInfo.name);
            }
        } catch (e) {
            console.error('获取学生信息失败:', e);
        }

        // 加载分类
        loadCategories();

        // 默认显示所有菜品（全部分类）
        showDefaultContent();

        // 页面加载完成后初始化菜品数量显示
        setTimeout(initDishQuantities, 500);

        // 设置当前菜单激活状态
        const currentPath = window.location.pathname;
        $('.sidebar-menu a').each(function () {
            if ($(this).attr('href') === currentPath) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
    });

    // 加载商家列表
    function loadMerchants() {
        $.ajax({
            url: '/api/common/merchants',
            success: function (res) {
                if (res.code === 200) {
                    renderMerchantList(res.data);
                }
            }
        });
    }

    // 加载分类（使用菜品类别）
    function loadCategories() {
        // 使用菜品类别作为分类选项
        const categories = [
            { id: '川菜', name: '川菜' },
            { id: '粤菜', name: '粤菜' },
            { id: '湘菜', name: '湘菜' },
            { id: '东北菜', name: '东北菜' },
            { id: '西北菜', name: '西北菜' },
            { id: '快餐', name: '快餐' },
            { id: '火锅', name: '火锅' },
            { id: '烧烤', name: '烧烤' },
            { id: '面食', name: '面食' },
            { id: '甜品', name: '甜品' },
            { id: '饮品', name: '饮品' },
            { id: '其他', name: '其他' }
        ];

        let html = '';
        categories.forEach(category => {
            html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="category" id="category_${category.id}" value="${category.id}">
                        <label class="form-check-label" for="category_${category.id}">
                            ${category.name}
                        </label>
                    </div>
                `;
        });
        $('#categoryList').html(html);
    }

    // 渲染商家列表
    function renderMerchantList(merchants) {
        let html = '';
        if (merchants.length === 0) {
            html = '<div class="col-12 text-center text-muted py-4">暂无商家</div>';
        } else {
            merchants.forEach(merchant => {
                html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <img src="/static/${merchant.logo || 'uploads/merchant/default.svg'}" class="card-img-top" alt="${merchant.merchant_name || merchant.name}" style="height: 180px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${merchant.name}</h5>
                                    <p class="card-text text-muted">${merchant.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-success">售出${merchant.total_sales || 0}</span>
                                        <button onclick="viewMerchantDetails(${merchant.id})" class="btn btn-primary btn-sm">查看商家</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            });
        }
        $('#merchantList').html(html);
    }

    // 渲染菜品列表
    function renderDishList(dishes) {
        let html = '';
        if (dishes.length === 0) {
            html = '<div class="col-12 text-center text-muted py-4">暂无菜品</div>';
        } else {
            dishes.forEach(dish => {
                // 检查库存状态和下架状态
                const isOutOfStock = dish.stock === -1;
                const isShelf = dish.is_shelf !== false && dish.is_shelf !== 'false'; // 默认是true，处理布尔值和字符串
                // 构建库存显示文本
                let stockText = '';
                if (dish.stock === 0) {
                    stockText = '<span class="text-info">无限库存</span>';
                } else if (dish.stock > 0) {
                    stockText = `<span class="text-success">库存${dish.stock}</span>`;
                } else {
                    stockText = '<span class="text-danger">售罄</span>';
                }

                html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 position-relative ${(!isShelf || isOutOfStock) ? 'opacity-50' : ''}">
${!isShelf ? '<div class="position-absolute top-50 start-50 translate-middle bg-danger text-white px-4 py-2 rounded" style="z-index: 10; font-weight: bold; font-size: 18px;">该菜品已下架</div>' : ''}
${isOutOfStock ? '<div class="position-absolute top-50 start-50 translate-middle bg-danger text-white px-4 py-2 rounded" style="z-index: 10; font-weight: bold; font-size: 18px;">售罄</div>' : ''}
                                <img src="/static/${dish.img_url || 'uploads/dish/default.jpg'}" class="card-img-top" alt="${dish.name}" style="height: 180px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${dish.name}</h5>
                                    <p class="card-text text-muted">${dish.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger">¥${dish.price}</span>
                                        <span class="text-success">售出${dish.sales || 0}</span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="badge bg-secondary">${dish.category}</span>
                                        <span class="text-muted ms-2">${dish.merchant_name}</span>
                                    </div>
                                    <div class="mb-2">
                                        ${stockText}
                                    </div>
                                    <div class="mt-2 d-flex justify-content-between align-items-center">
                                        <div>
                                            <button class="btn btn-primary btn-sm me-2" onclick="viewMerchantDetails(${dish.merchant_id})">查看商家</button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewDishComments(${dish.id})"><i class="bi bi-chat-left-text mr-2"></i>查看评论</button>
                                        </div>
                                        <div class="quantity-control" id="quantity-control-${dish.id}">
                                            <button class="btn btn-sm btn-outline-secondary decrease-btn" onclick="updateDishQuantity(${dish.id}, -1)" ${(!isShelf || isOutOfStock) ? 'disabled' : ''} style="float: left;">-</button>
                                            <span class="quantity-value mx-2" style="display: inline-block; min-width: 30px; text-align: center;">0</span>
                                            <button class="btn btn-sm btn-outline-secondary increase-btn" onclick="updateDishQuantity(${dish.id}, 1)" ${(!isShelf || isOutOfStock) ? 'disabled' : ''} style="float: right;">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            });
        }
        $('#merchantList').html(html);
    }

    // 搜索商家
    function searchMerchants() {
        const keyword = $('#searchMerchant').val().trim();

        // 清空菜品搜索框
        $('#searchDish').val('');

        if (keyword) {
            $.ajax({
                url: '/api/common/merchants',
                success: function (res) {
                    if (res.code === 200) {
                        let filteredMerchants = res.data;

                        // 按关键词过滤
                        filteredMerchants = filteredMerchants.filter(merchant =>
                            merchant.name.toLowerCase().includes(keyword.toLowerCase())
                        );

                        renderMerchantList(filteredMerchants);
                    }
                }
            });
        } else {
            // 显示默认内容
            showDefaultContent();
        }
    }

    // 搜索菜品
    function searchDishes() {
        const keyword = $('#searchDish').val().trim();

        // 清空商家搜索框
        $('#searchMerchant').val('');

        if (keyword) {
            $.ajax({
                url: '/api/common/all_dishes',
                success: function (res) {
                    if (res.code === 200) {
                        let filteredDishes = res.data;

                        // 按关键词过滤
                        filteredDishes = filteredDishes.filter(dish =>
                            dish.name.toLowerCase().includes(keyword.toLowerCase())
                        );

                        renderDishList(filteredDishes);
                        // 初始化菜品数量显示
                        setTimeout(initDishQuantities, 100);
                    }
                }
            });
        } else {
            // 显示默认内容
            showDefaultContent();
        }
    }

    // 显示默认内容
    function showDefaultContent() {
        // 恢复页面标题
        $('#page_title').text('校园美食 - 首页');

        // 显示分类筛选面板
        $('#categoryList').closest('.col-md-3').show();

        // 恢复内容区域布局
        $('#merchantList').closest('.col-12').removeClass('col-12').addClass('col-md-9');

        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 获取选中的分类
        const category = $('input[name="category"]:checked').val();

        // 如果选择了全部分类，显示所有菜品
        if (category === 'categoryAll' || category === undefined) {
            // 查询所有菜品
            $.ajax({
                url: '/api/common/all_dishes',
                success: function (res) {
                    if (res.code === 200) {
                        renderDishList(res.data);
                        // 初始化菜品数量显示
                        setTimeout(initDishQuantities, 100);
                    }
                }
            });
        } else {
            // 否则，根据菜品类别筛选菜品
            $.ajax({
                url: `/api/common/dishes_by_category?category=${encodeURIComponent(category)}`,
                success: function (res) {
                    if (res.code === 200) {
                        renderDishList(res.data);
                        // 初始化菜品数量显示
                        setTimeout(initDishQuantities, 100);
                    }
                }
            });
        }
    }

    // 显示所有商家
    function showAllMerchants() {
        loadMerchants();
    }

    // 查看商家详情
    function viewMerchantDetails(merchantId) {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 先获取所有商家，找到对应商家的信息
        $.ajax({
            url: '/api/common/merchants',
            success: function (merchantsRes) {
                if (merchantsRes.code === 200) {
                    const merchant = merchantsRes.data.find(m => m.id === merchantId);
                    if (merchant) {
                        // 获取该商家的菜品
                        $.ajax({
                            url: `/api/common/dishes/${merchantId}`,
                            success: function (dishesRes) {
                                if (dishesRes.code === 200) {
                                    // 显示商家详情和菜品
                                    renderMerchantDetails(merchant, dishesRes.data);
                                }
                            }
                        });
                    }
                }
            }
        });
    }

    // 渲染商家详情和菜品
    function renderMerchantDetails(merchant, dishes) {
        // 更新页面标题
        $('#page_title').text(`${merchant.name} - 商家详情`);

        // 构建完整的商家介绍HTML
        const merchantInfoHtml = `
            <div class="col-12 mb-6">
                <div class="card">
                    <!-- 商家头部大图 -->
                    <div class="bg-warning py-10 px-6 text-dark relative">
                        <!-- 返回首页按钮 - 匹配查看商家样式 -->
                        <button onclick="showDefaultContent()" class="absolute top-4 right-4 btn btn-primary btn-sm">
                            <i class="bi bi-arrow-left mr-2"></i>返回首页
                        </button>

                        <div class="d-flex align-items-center">
                            <img src="/static/${merchant.logo || 'uploads/merchant/default.svg'}" 
                                 alt="${merchant.name}" 
                                 style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 4px solid white;"
                                 class="mr-6">
                            <div class="flex-grow-1">
                                <h2 class="mb-3">${merchant.name}</h2>
                                <p class="mb-4 text-white-80">${merchant.description || '暂无商家介绍'}</p>
                                <div class="d-flex flex-wrap gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${merchant.total_sales || 0}</div>
                                        <div class="text-sm text-white-80">售出</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">5.0</div>
                                        <div class="text-sm text-white-80">评分</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">20</div>
                                        <div class="text-sm text-white-80">起送</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">¥${merchant.service_fee || 5}</div>
                                        <div class="text-sm text-white-80">配送费</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 商家信息 -->
                    <div class="p-4 border-bottom">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="text-secondary"><i class="bi bi-geo-alt mr-2"></i>地址</div>
                            <div>${merchant.address || '暂无地址信息'}</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="text-secondary"><i class="bi bi-phone mr-2"></i>电话</div>
                            <div>${merchant.contact_phone || '暂无联系电话'}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 菜品列表标题 -->
            <div class="col-12 mb-4">
                <h3 class="border-bottom pb-2">
                    <i class="bi bi-utensils mr-2"></i>菜品列表
                </h3>
            </div>
        `;

        // 构建菜品列表HTML
        let dishesHtml = '';
        if (dishes.length === 0) {
            dishesHtml = '<div class="col-12 text-center text-muted py-10">该商家暂无上架菜品</div>';
        } else {
            // 按分类分组菜品
            const dishesByCategory = {};
            dishes.forEach(dish => {
                if (!dishesByCategory[dish.category]) {
                    dishesByCategory[dish.category] = [];
                }
                dishesByCategory[dish.category].push(dish);
            });

            // 遍历分类构建菜品HTML
            Object.keys(dishesByCategory).forEach(category => {
                dishesHtml += `
                    <div class="col-12 mb-6">
                        <div class="bg-light p-3 mb-4">
                            <h4 class="mb-0">${category}</h4>
                        </div>
                        <div class="row">
                `;

                dishesByCategory[category].forEach(dish => {
                    // 检查库存状态和下架状态
                    const isOutOfStock = dish.stock === -1;
                    const isShelf = dish.is_shelf !== false && dish.is_shelf !== 'false'; // 默认是true，处理布尔值和字符串
                    // 构建库存显示文本
                    let stockText = '';
                    if (dish.stock === 0) {
                        stockText = '<span class="text-info">无限库存</span>';
                    } else if (dish.stock > 0) {
                        stockText = `<span class="text-success">库存${dish.stock}</span>`;
                    } else {
                        stockText = '<span class="text-danger">售罄</span>';
                    }

                    dishesHtml += `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 position-relative ${(!isShelf || isOutOfStock) ? 'opacity-50' : ''}">
                                ${!isShelf ? '<div class="position-absolute top-50 start-50 translate-middle bg-danger text-white px-4 py-2 rounded" style="z-index: 10; font-weight: bold; font-size: 18px;">该菜品已下架</div>' : ''}
                                ${isOutOfStock ? '<div class="position-absolute top-50 start-50 translate-middle bg-danger text-white px-4 py-2 rounded" style="z-index: 10; font-weight: bold; font-size: 18px;">售罄</div>' : ''}
                                <img src="/static/${dish.img_url || 'uploads/dish/default.jpg'}" 
                                     class="card-img-top" 
                                     alt="${dish.name}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${dish.name}</h5>
                                    <p class="card-text text-muted small mb-3">${dish.description || '暂无描述'}</p>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-danger font-bold">¥${dish.price}</span>
                                        <span class="text-success">售出${dish.sales || 0}</span>
                                    </div>
                                    <div class="mb-3">
                                        ${stockText}
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button onclick="viewDishComments(${dish.id})" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-chat-left-text mr-2"></i>查看评论
                                        </button>
                                        <div class="quantity-control" id="quantity-control-${dish.id}" style="display: flex; align-items: center;">
                                            <button class="btn btn-sm btn-outline-secondary decrease-btn" onclick="updateDishQuantity(${dish.id}, -1)" ${(!isShelf || isOutOfStock) ? 'disabled' : ''} style="float: left;">-</button>
                                            <span class="quantity-value mx-2" style="display: inline-block; min-width: 30px; text-align: center;">0</span>
                                            <button class="btn btn-sm btn-outline-secondary increase-btn" onclick="updateDishQuantity(${dish.id}, 1)" ${(!isShelf || isOutOfStock) ? 'disabled' : ''} style="float: right;">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                dishesHtml += `
                        </div>
                    </div>
                `;
            });
        }

        // 组合HTML并更新页面内容区域
        $('#merchantList').html(merchantInfoHtml + dishesHtml);

        // 初始化菜品数量显示
        initDishQuantities();
    }

    // 分类筛选
    $(document).on('click', 'input[name="category"]', function (e) {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');

        // 如果点击的是已经选中的分类
        if (this.checked) {
            // 直接调用showDefaultContent重新加载内容
            showDefaultContent();
        }
    });

    // 同时保留change事件处理，确保两种情况下都能正常工作
    $(document).on('change', 'input[name="category"]', function () {
        // 清空搜索框
        $('#searchMerchant').val('');
        $('#searchDish').val('');
        showDefaultContent();
    });

    function logout() {
        localStorage.removeItem('student_token');
        localStorage.removeItem('studentInfo');
        window.location.href = '/student/login';
    }

    // 购物车功能相关代码
    // 页面加载完成后执行
    window.addEventListener('DOMContentLoaded', function () {
        // 初始化购物车数据
        updateCartDisplay();

        // 使用原生JavaScript控制购物车弹框的显示和隐藏
        const cartButton = document.getElementById('cartButton');
        const cartDropdown = document.getElementById('cartDropdown');
        const cartButtonContainer = document.getElementById('cartButtonContainer');
        const checkoutButton = document.getElementById('checkoutButton');

        // 确保元素存在
        if (!cartButton || !cartDropdown || !cartButtonContainer) {
            // console.error('购物车相关元素未找到');
            return;
        }

        // 使用内部状态变量跟踪弹框显示状态，避免依赖DOM
        let isCartOpen = false;

        // 明确设置初始状态：隐藏购物车弹框
        // console.log('购物车元素已找到，初始状态检查：');
        // console.log('cartDropdown初始类名:', cartDropdown.className);
        // console.log('cartDropdown是否包含hidden类:', cartDropdown.classList.contains('hidden'));

        // 强制添加hidden类，确保初始状态隐藏
        cartDropdown.classList.add('hidden');
        // console.log('强制添加hidden类后，是否包含hidden类:', cartDropdown.classList.contains('hidden'));
        // console.log('强制添加hidden类后，类名:', cartDropdown.className);

        // 点击购物车按钮显示/隐藏弹框
        cartButton.addEventListener('click', function (e) {
            // console.log('购物车按钮被点击，内部状态:', isCartOpen);
            e.stopPropagation();

            if (isCartOpen) {
                // 隐藏弹框
                // console.log('隐藏购物车弹框：添加hidden类');
                cartDropdown.classList.add('hidden');
                isCartOpen = false;
            } else {
                // 显示弹框
                // console.log('显示购物车弹框：移除hidden类');
                cartDropdown.classList.remove('hidden');
                // 展开时更新购物车内容
                updateCartItems();
                isCartOpen = true;
            }
            // console.log('操作后类名:', cartDropdown.className);
            // console.log('操作后内部状态:', isCartOpen);
        });

        // 去结算按钮点击事件
        if (checkoutButton) {
            checkoutButton.addEventListener('click', function () {
                window.location.href = '/student/cart';
            });
        }

        // 清空购物车按钮点击事件
        const clearCartButton = document.getElementById('clearCartButton');
        if (clearCartButton) {
            clearCartButton.addEventListener('click', function () {
                if (confirm('确定要清空购物车吗？')) {
                    // 发送清空购物车的请求
                    $.ajax({
                        url: '/api/student/cart/clear',
                        type: 'DELETE',
                        success: function (res) {
                            if (res && res.code === 200) {
                                // 更新购物车显示
                                updateCartDisplay();
                                updateCartItems();
                                // 初始化所有菜品数量为0
                                initDishQuantities();
                                alert('购物车已清空');
                            } else {
                                alert('清空购物车失败：' + (res ? res.msg : '未知错误'));
                            }
                        },
                        error: function () {
                            alert('网络错误，无法清空购物车');
                        }
                    });
                }
            });
        }

        // 动态绑定菜品数量增减按钮事件（使用事件委托）
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('decrease-btn')) {
                // 获取菜品ID
                const dishId = e.target.dataset.dishId;
                if (dishId) {
                    updateCartItemQuantity(dishId, -1);
                }
            } else if (e.target.classList.contains('increase-btn')) {
                // 获取菜品ID
                const dishId = e.target.dataset.dishId;
                if (dishId) {
                    updateCartItemQuantity(dishId, 1);
                }
            }
        });
    });

    // 更新购物车显示（角标数字等）
    function updateCartDisplay() {
        $.ajax({
            url: '/api/student/cart',
            // 使用session验证，不再需要Authorization头
            success: function (res) {
                if (res.code === 200 && res.data) {
                    // 正确获取购物车数据，支持新的数据结构
                    const cartItems = (res.data && res.data.items) ? res.data.items : (Array.isArray(res.data) ? res.data : []);
                    let totalCount = 0;

                    // 计算总数量
                    cartItems.forEach(item => {
                        totalCount += item.quantity || 0;
                    });

                    // 更新角标数字
                    const cartCount = document.getElementById('cartCount');
                    cartCount.textContent = totalCount;

                    // 如果购物车为空，隐藏角标；否则显示
                    if (totalCount === 0) {
                        cartCount.style.display = 'none';
                    } else {
                        cartCount.style.display = 'flex';
                    }
                }
            }
        });
    }

    // 更新购物车菜品列表
    function updateCartItems() {
        $.ajax({
            url: '/api/student/cart',
            // 使用session验证，不再需要Authorization头
            success: function (res) {
                if (res.code === 200 && res.data) {
                    // 正确获取购物车数据，支持新的数据结构
                    const cartItems = (res.data && res.data.items) ? res.data.items : (Array.isArray(res.data) ? res.data : []);
                    const cartItemsList = $('#cartItemsList');
                    const emptyCart = $('#emptyCart');

                    if (cartItems.length === 0) {
                        // 购物车为空
                        cartItemsList.addClass('hidden');
                        emptyCart.removeClass('hidden');
                        $('#totalPrice').text('¥0.00');
                    } else {
                        // 购物车有商品
                        cartItemsList.empty().removeClass('hidden');
                        emptyCart.addClass('hidden');

                        let totalPrice = 0;

                        // 渲染购物车菜品
                        cartItems.forEach(item => {
                            const quantity = item.quantity || 1;
                            const dish = item.dish || {};
                            const itemTotal = (dish.price || 0) * quantity;
                            totalPrice += itemTotal;

                            const cartItemHtml = `
                                <div class="cart-item mb-3 p-2 border rounded" data-id="${item.id}" data-dish-id="${dish.id}">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="font-medium">${dish.dish_name}</div>
                                            <div class="text-danger">¥${(dish.price || 0).toFixed(2)}</div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-secondary decrease-btn" data-dish-id="${dish.id}">-</button>
                                            <span class="mx-2 quantity">${quantity}</span>
                                            <button class="btn btn-sm btn-outline-secondary increase-btn" data-dish-id="${dish.id}">+</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            cartItemsList.append(cartItemHtml);
                        });

                        // 更新合计价格
                        $('#totalPrice').text(`¥${totalPrice.toFixed(2)}`);
                    }
                    // 更新菜品数量显示，确保购物车和菜品栏数量同步
                    initDishQuantities();
                }
            }
        });
    }

    // 更新购物车菜品数量
    function updateCartItemQuantity(dishId, change) {
        // 获取当前数量 - 使用data-dish-id查找购物车项
        const cartItem = $(`.cart-item[data-dish-id="${dishId}"]`);
        const quantityElement = cartItem.find('.quantity');
        let currentQuantity = parseInt(quantityElement.text()) || 1;

        // 计算新数量
        let newQuantity = currentQuantity + change;

        // 确保数量不小于1
        // if (newQuantity < 1) {
        //     // 可以选择删除商品或保持为1
        //     if (confirm('确定要从购物车中移除该商品吗？')) {
        //         // 从购物车中移除商品
        //         removeFromCart(dishId);
        //         return;
        //     } else {
        //         return; // 取消操作
        //     }
        // }

        // 更新购物车 - 使用学生路由中的购物车更新接口
        $.ajax({
            url: '/api/student/cart/' + dishId,
            method: 'PUT',
            // 使用session验证，不再需要Authorization头
            contentType: 'application/json',
            data: JSON.stringify({
                quantity: newQuantity
            }),
            success: function (res) {
                if (res.code === 200) {
                    // 更新本地显示
                    quantityElement.text(newQuantity);
                    updateTotalPrice();
                    updateCartDisplay();
                    updateCartItems(); // 同时更新购物车列表显示

                    // 更新菜品栏中对应菜品的数量显示
                    // 找到对应的菜品数量控件并更新
                    const quantityControl = $(`#quantity-control-${dishId}`);
                    if (quantityControl.length > 0) {
                        const quantityValue = quantityControl.find('.quantity-value');
                        quantityValue.text(newQuantity);
                    }

                    // 兼容其他可能的数量显示元素
                    $(`.dish-quantity[data-id="${dishId}"]`).each(function () {
                        $(this).text(newQuantity);
                        // 如果数量大于0，显示数字，否则可能需要处理减号按钮的禁用状态
                        if (newQuantity > 0) {
                            $(this).show();
                            $(this).siblings('.decrease-btn').removeClass('disabled');
                        } else {
                            $(this).hide();
                            $(this).siblings('.decrease-btn').addClass('disabled');
                        }
                    });

                    // 同时更新菜品卡片上的+按钮旁边的数量显示（如果有）
                    $(`.dish-card[data-id="${dishId}"] .quantity-display`).each(function () {
                        if (newQuantity > 0) {
                            $(this).text(newQuantity).show();
                            $(this).siblings('.decrease-btn').removeClass('disabled');
                        } else {
                            $(this).hide();
                            $(this).siblings('.decrease-btn').addClass('disabled');
                        }
                    });
                } else {
                    alert('更新失败：' + (res.msg || '未知错误'));
                }
            },
            error: function (xhr) {
                // 尝试获取更详细的错误信息
                let errorMsg = '网络错误，无法更新商品数量';
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    if (errorData && errorData.msg) {
                        errorMsg = errorData.msg;
                    }
                } catch (e) {
                    // 忽略解析错误
                }
                alert(errorMsg);
            }
        });
    }

    // 从购物车移除商品 - 使用学生路由中的购物车删除接口
    function removeFromCart(dishId) {
        $.ajax({
            url: '/api/student/cart/' + dishId,
            method: 'DELETE',
            // 使用session验证，不再需要Authorization头
            success: function (res) {
                if (res.code === 200) {
                    // 移除DOM元素 - 使用data-dish-id查找购物车项
                    $(`.cart-item[data-dish-id="${dishId}"]`).remove();
                    // 更新购物车显示
                    updateTotalPrice();
                    updateCartDisplay();
                    updateCartItems(); // 重新加载购物车列表，确保空状态正确显示

                    // 更新菜品栏中对应菜品的数量显示为0
                    const quantityControl = $(`#quantity-control-${dishId}`);
                    if (quantityControl.length > 0) {
                        const quantityValue = quantityControl.find('.quantity-value');
                        quantityValue.text('0');
                    }

                    // 兼容其他可能的数量显示元素
                    $(`.dish-quantity[data-id="${dishId}"]`).each(function () {
                        $(this).text('0');
                        $(this).hide();
                        $(this).siblings('.decrease-btn').addClass('disabled');
                    });

                    // 同时更新菜品卡片上的+按钮旁边的数量显示
                    $(`.dish-card[data-id="${dishId}"] .quantity-display`).each(function () {
                        $(this).text('0');
                        $(this).hide();
                        $(this).siblings('.decrease-btn').addClass('disabled');
                    });
                } else {
                    alert('移除失败：' + (res.msg || '未知错误'));
                }
            },
            error: function () {
                alert('网络错误，无法移除商品');
            }
        });
    }

    // 检查购物车是否为空
    if ($('.cart-item').length === 0) {
        $('#cartItemsList').addClass('hidden');
        $('#emptyCart').removeClass('hidden');
        $('#totalPrice').text('¥0.00');
    }

    // 更新合计价格
    function updateTotalPrice() {
        let totalPrice = 0;

        $('.cart-item').each(function () {
            const quantity = parseInt($(this).find('.quantity').text()) || 1;
            const priceText = $(this).find('.text-danger').text();
            const price = parseFloat(priceText.replace('¥', '')) || 0;

            totalPrice += price * quantity;
        });

        $('#totalPrice').text(`¥${totalPrice.toFixed(2)}`);
    }

    // 初始化菜品数量显示
    function initDishQuantities() {
        // 获取购物车数据
        $.ajax({
            url: '/api/student/cart',
            // 使用session验证，不再需要Authorization头

            success: function (res) {
                if (res.code === 200 && res.data) {
                    // 创建购物车中菜品数量的映射
                    const cartItemsMap = {};
                    // 使用正确的数据结构路径
                    if (res.data && res.data.items && Array.isArray(res.data.items)) {
                        res.data.items.forEach(item => {
                            if (item.dish) {
                                cartItemsMap[item.dish.id] = item.quantity || 0;
                            } else if (item.id) {
                                // 兼容不同的数据结构
                                cartItemsMap[item.id] = item.quantity || 0;
                            }
                        });
                    } else if (Array.isArray(res.data)) {
                        // 兼容旧的数据结构
                        res.data.forEach(item => {
                            if (item.dish) {
                                cartItemsMap[item.dish.id] = item.quantity || 0;
                            } else if (item.id) {
                                cartItemsMap[item.id] = item.quantity || 0;
                            }
                        });
                    }

                    // 更新页面上所有菜品的数量显示
                    $('.quantity-control').each(function () {
                        const dishId = $(this).attr('id').split('-')[2];
                        const quantity = cartItemsMap[dishId] || 0;
                        $(this).find('.quantity-value').text(quantity);
                    });
                }
            },
            error: function () {
                console.log('获取购物车数据失败，显示默认数量');
                // 显示默认数量0
                $('.quantity-value').text('0');
            }
        });
    }

    // 更新菜品数量（处理加减按钮点击）
    function updateDishQuantity(dishId, change) {
        // 获取当前数量
        const quantityElement = $(`#quantity-control-${dishId} .quantity-value`);
        let currentQuantity = parseInt(quantityElement.text()) || 0;

        // 计算新数量
        let newQuantity = currentQuantity + change;

        // 确保数量不小于0
        if (newQuantity < 0) {
            newQuantity = 0;
        }

        // 更新显示（立即更新UI，提升用户体验）
        quantityElement.text(newQuantity);

        // 如果要设置为0，先检查是否需要从购物车移除
        if (newQuantity === 0 && currentQuantity > 0) {
            // 首先获取购物车项列表，查找对应菜品的cart_id
            $.ajax({
                url: '/api/student/cart',
                method: 'GET',
                // 使用session验证，不再需要Authorization头
                success: function (cartRes) {
                    if (cartRes.code === 200 && cartRes.data && cartRes.data.items) {
                        // 查找对应菜品的购物车项
                        const cartItem = cartRes.data.items.find(item => item.dish && item.dish.id === parseInt(dishId));
                        if (cartItem) {
                            // 调用删除购物车项接口
                            $.ajax({
                                url: '/api/student/cart/' + dishId,
                                method: 'DELETE',
                                // 使用session验证，不再需要Authorization头

                                success: function (res) {
                                    if (res.code === 200) {
                                        // 更新购物车显示
                                        updateCartDisplay();
                                        if (typeof updateCartItems === 'function') {
                                            updateCartItems();
                                        }

                                        // 更新页面上所有相同菜品的数量显示为0
                                        $(`.quantity-control[id^="quantity-control-${dishId}"] .quantity-value`).each(function () {
                                            $(this).text('0');
                                        });
                                    } else {
                                        // 恢复原数量
                                        quantityElement.text(currentQuantity);
                                        alert('移除失败：' + (res.msg || '未知错误'));
                                    }
                                },
                                error: function (xhr) {
                                    // 恢复原数量
                                    quantityElement.text(currentQuantity);
                                    // 尝试获取更详细的错误信息
                                    let errorMsg = '网络错误，移除失败';
                                    try {
                                        const errorData = JSON.parse(xhr.responseText);
                                        if (errorData && errorData.msg) {
                                            errorMsg = errorData.msg;
                                        }
                                    } catch (e) {
                                        // 忽略解析错误
                                    }
                                    alert(errorMsg);
                                }
                            });
                        } else {
                            // 购物车中没有该商品，不需要删除
                            updateCartDisplay();
                            if (typeof updateCartItems === 'function') {
                                updateCartItems();
                            }
                        }
                    } else {
                        // 获取购物车失败
                        quantityElement.text(currentQuantity);
                        alert('获取购物车信息失败');
                    }
                },
                error: function () {
                    // 获取购物车失败
                    quantityElement.text(currentQuantity);
                    alert('网络错误，无法获取购物车信息');
                }
            });
        } else if (newQuantity > 0) {
            // 根据change的正负判断是增加还是减少数量
            if (change > 0) {
                // 对于增加数量，直接调用添加购物车接口
                $.ajax({
                    url: '/api/student/cart/add',
                    method: 'POST',
                    // 使用session验证，不再需要Authorization头

                    contentType: 'application/json',
                    data: JSON.stringify({
                        dish_id: parseInt(dishId), // 确保是整数类型
                        quantity: 1 // 每次点击+按钮增加1个
                    }),
                    success: function (res) {
                        if (res.code === 200) {
                            // 更新购物车显示
                            updateCartDisplay();
                            if (typeof updateCartItems === 'function') {
                                updateCartItems();
                            }

                            // 获取最新的数量
                            let updatedQuantity = newQuantity;
                            if (res.data && res.data.quantity !== undefined) {
                                updatedQuantity = res.data.quantity;
                            }

                            // 更新页面上所有相同菜品的数量显示
                            $(`.quantity-control[id^="quantity-control-${dishId}"] .quantity-value`).each(function () {
                                $(this).text(updatedQuantity);
                            });
                        } else {
                            // 恢复原数量
                            quantityElement.text(currentQuantity);
                            alert('添加失败：' + (res.msg || '未知错误'));
                        }
                    },
                    error: function (xhr) {
                        // 恢复原数量
                        quantityElement.text(currentQuantity);
                        // 尝试获取更详细的错误信息
                        let errorMsg = '网络错误，添加失败';
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            if (errorData && errorData.msg) {
                                errorMsg = errorData.msg;
                            }
                        } catch (e) {
                            // 忽略解析错误
                        }
                        alert(errorMsg);
                    }
                });
            } else {
                // 对于减少数量，需要找到对应的cart_id
                // 首先获取购物车项列表，查找对应菜品的cart_id
                $.ajax({
                    url: '/api/student/cart',
                    method: 'GET',
                    // 使用session验证，不再需要Authorization头

                    success: function (cartRes) {
                        if (cartRes.code === 200 && cartRes.data && cartRes.data.items) {
                            // 查找对应菜品的购物车项
                            const cartItem = cartRes.data.items.find(item => item.dish && item.dish.id === parseInt(dishId));
                            if (cartItem) {
                                // 调用更新购物车项接口
                                $.ajax({
                                    url: '/api/student/cart/' + dishId,
                                    method: 'PUT',
                                    // 使用session验证，不再需要Authorization头

                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        quantity: newQuantity
                                    }),
                                    success: function (updateRes) {
                                        if (updateRes.code === 200) {
                                            // 更新购物车显示
                                            updateCartDisplay();
                                            if (typeof updateCartItems === 'function') {
                                                updateCartItems();
                                            }

                                            // 更新页面上所有相同菜品的数量显示
                                            $(`.quantity-control[id^="quantity-control-${dishId}"] .quantity-value`).each(function () {
                                                $(this).text(newQuantity);
                                            });
                                        } else {
                                            // 恢复原数量
                                            quantityElement.text(currentQuantity);
                                            alert('减少失败：' + (updateRes.msg || '未知错误'));
                                        }
                                    },
                                    error: function (xhr) {
                                        // 恢复原数量
                                        quantityElement.text(currentQuantity);
                                        // 尝试获取更详细的错误信息
                                        let errorMsg = '网络错误，减少失败';
                                        try {
                                            const errorData = JSON.parse(xhr.responseText);
                                            if (errorData && errorData.msg) {
                                                errorMsg = errorData.msg;
                                            }
                                        } catch (e) {
                                            // 忽略解析错误
                                        }
                                        alert(errorMsg);
                                    }
                                });
                            } else {
                                // 没有找到对应的购物车项，恢复原数量
                                quantityElement.text(currentQuantity);
                                alert('未找到对应的购物车项');
                            }
                        } else {
                            // 获取购物车失败，恢复原数量
                            quantityElement.text(currentQuantity);
                            alert('获取购物车失败：' + (cartRes.msg || '未知错误'));
                        }
                    },
                    error: function (xhr) {
                        // 恢复原数量
                        quantityElement.text(currentQuantity);
                        alert('获取购物车失败，无法减少数量');
                    }
                });
            }
        }
    }

    // 定义addToCart函数，添加商品到购物车（保留以便兼容）
    function addToCart(dishId) {
        updateDishQuantity(dishId, 1);
    }

    // 查看菜品评论
    function viewDishComments(dishId) {
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('dishCommentsModal'));
        modal.show();

        // 加载评论
        loadDishComments(dishId);
    }

    // 加载菜品评论
    function loadDishComments(dishId) {
        $.ajax({
            url: `/api/common/dish_comments/${dishId}`,
            type: 'GET',
            success: function (res) {
                if (res.code === 200) {
                    renderDishCommentsList(res.data);
                } else {
                    $('#dishCommentsList').html('<div class="text-center text-muted py-4">加载评论失败：' + (res.msg || '未知错误') + '</div>');
                }
            },
            error: function () {
                $('#dishCommentsList').html('<div class="text-center text-muted py-4">网络错误，加载评论失败</div>');
            }
        });
    }

    // 渲染菜品评论列表
    function renderDishCommentsList(comments) {
        if (!comments || comments.length === 0) {
            $('#dishCommentsList').html('<div class="text-center text-muted py-4">暂无评论</div>');
            return;
        }

        let html = '';
        comments.forEach(comment => {
            html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="d-flex align-items-center">
                                        <span class="text-primary me-2">订单号：${comment.order_no || '-'}</span>
                                        <span class="text-muted">${comment.create_time || '-'}</span>
                                    </div>
                                    <div class="mt-1">
                                        <span class="text-warning">
                                            ${renderStars(comment.dish_score)} 菜品评分
                                        </span>
                                        <span class="text-warning ms-3">
                                            ${renderStars(comment.service_score)} 服务评分
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <p class="card-text mb-2">${comment.content || '-'}</p>
                            
                            ${comment.img_urls && comment.img_urls.length > 0 ? `
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    ${comment.img_urls.map(img => `
                                        <img src="/static/${img}" alt="评论图片" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${comment.merchant_reply ? `
                                <div class="mt-3 p-3 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="font-weight-bold">商家回复：</span>
                                        <span class="text-muted small">${comment.reply_time || '-'}</span>
                                    </div>
                                    <p class="mb-0">${comment.merchant_reply}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
        });

        $('#dishCommentsList').html(html);
    }

    // 渲染星级评分
    function renderStars(score) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= score) {
                stars += '<i class="fa fa-star"></i>';
            } else {
                stars += '<i class="fa fa-star-o"></i>';
            }
        }
        return stars;
    }
</script>

<!-- 菜品评论模态框 -->
<div class="modal fade" id="dishCommentsModal" tabindex="-1" aria-labelledby="dishCommentsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dishCommentsModalLabel">菜品评论</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dishCommentsList">
                    <!-- 评论列表将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}