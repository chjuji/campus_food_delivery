{% extends "layouts/base.html" %}

{% block title %}{% block page_title %}个人信息 - 校内外卖平台{% endblock %}{% endblock %}

{% block sidebar_title %}学生中心{% endblock %}

{% block sidebar_menu %}
<li><a href="/student/index">首页</a></li>
<li><a href="/student/cart">购物车</a></li>
<li><a href="/student/orders">我的订单</a></li>
<li><a href="/student/profile" class="active">个人信息</a></li>
<li><a href="/student/complaints">投诉评论</a></li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>基本信息</h5>
            </div>
            <div class="card-body text-center">
                <!-- 头像上传区域 -->
                <div class="avatar-upload mb-4">
                    <div class="avatar-preview"
                        style="position: relative; width: 150px; height: 150px; margin: 0 auto; cursor: pointer;">
                        <img id="avatarPreview" src="/static/uploads/avatar/default_avatar.jpg" alt="头像"
                            class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;">
                        <div class="avatar-upload-overlay"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                            <span class="text-white">点击查看大图</span>
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                <h5 id="info-name0" class="mb-1">{{ '加载中...' }}</h5>
                <p class="text-muted mb-3">学生用户</p>
                <div class="d-block">
                    <button class="btn btn-primary mb-2 w-100" onclick="openEditModal()">编辑信息</button>
                    <button class="btn btn-outline-danger mb-2 w-100" onclick="changePassword()">修改密码</button>
                    <button class="btn btn-success mb-2 w-100" onclick="openRechargeModal()">充值</button>
                    <button class="btn btn-warning mb-2 w-100" onclick="openWallet()">卡包</button>
                    <button class="btn btn-info w-100" onclick="checkPayPasswordStatus()">修改支付密码</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>详细信息</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">姓名：</div>
                    <div class="col-sm-9" id="info-name">加载中...</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">学号：</div>
                    <div class="col-sm-9" id="info-id">加载中...</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">手机号：</div>
                    <div class="col-sm-9" id="info-phone">加载中...</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">性别：</div>
                    <div class="col-sm-9" id="info-gender">未知</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">钱包余额：</div>
                    <div class="col-sm-9" id="info-wallet">¥0.00</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">默认收货地址：</div>
                    <div class="col-sm-9" id="info-address">加载中...</div>
                </div>
                <div class="row mb-4">
                    <div class="col-sm-3 col-form-label text-end">注册时间：</div>
                    <div class="col-sm-9" id="info-register-time">加载中...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 收货地址管理 -->
<div class="card mt-4">
    <div class="card-header">
        <div class="row justify-content-between align-items-center">
            <h5 class="mb-0">收货地址管理</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addAddress()">
                <i class="bi bi-plus"></i> 添加新地址
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="addressList" class="address-list">
            <!-- 地址列表将通过 JavaScript 动态加载 -->
            <div class="text-center text-muted py-4">
                <i class="bi bi-map" style="font-size: 2rem;"></i>
                <p class="mt-2">暂无收货地址，点击上方按钮添加</p>
            </div>
        </div>
    </div>
</div>

<!-- <div class="card">
    <div class="card-header">
        <h5>账户安全设置</h5>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <tbody>
                <tr onclick="changePassword()">
                    <td width="80%">修改登录密码</td>
                    <td class="text-right"><span class="text-muted">点击修改</span> <i class="bi bi-chevron-right"></i></td>
                </tr>
                <tr onclick="bindPhone()">
                    <td width="80%">绑定手机号</td>
                    <td class="text-right"><span class="text-muted">点击绑定</span> <i class="bi bi-chevron-right"></i></td>
                </tr>
                <tr onclick="bindEmail()">
                    <td width="80%">绑定邮箱</td>
                    <td class="text-right"><span class="text-muted">点击绑定</span> <i class="bi bi-chevron-right"></i></td>
                </tr>
            </tbody>
        </table>
    </div>
</div> -->
{% endblock %}

{% block scripts %}
<style>
    .avatar-preview:hover .avatar-upload-overlay {
        opacity: 1;
        cursor: pointer;
    }

    .address-item {
        position: relative;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .address-item:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .address-item.default::before {
        content: '默认';
        position: absolute;
        top: 0;
        left: 0;
        background-color: #0d6efd;
        color: white;
        padding: 2px 8px;
        font-size: 0.8rem;
        border-radius: 8px 0 8px 0;
    }

    .address-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }

    .table-hover tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>
<script>
    $(function () {
        // 检查登录状态
        const token = localStorage.getItem('student_token');
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        if (!token) {
            window.location.href = '/student/login';
            return;
        }

        // 设置当前菜单激活状态
        const currentPath = window.location.pathname;
        $('.sidebar-menu a').each(function () {
            if ($(this).attr('href') === currentPath) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });

        // 加载用户信息
        loadProfile();

        // 加载地址列表
        loadAddressList();

        // 头像点击事件 - 显示大图
        $('.avatar-preview').on('click', function () {
            // 获取当前头像的src
            const avatarSrc = $('#avatarPreview').attr('src');
            // 设置到大图模态框中
            $('#largeAvatarImage').attr('src', avatarSrc);
            // 显示模态框
            $('#largeAvatarModal').modal('show');
        });

        // 添加头像悬停效果
        $('.avatar-preview').hover(
            function () {
                $(this).find('.avatar-upload-overlay').css('opacity', '1');
            },
            function () {
                $(this).find('.avatar-upload-overlay').css('opacity', '0');
            }
        );

        // 大图模态框中的修改头像按钮点击事件
        $('#largeAvatarModal .change-avatar-btn').on('click', function () {
            $('#avatarInput').click();
        });

        $('#avatarInput').on('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    $('#avatarPreview').attr('src', event.target.result);
                    uploadAvatar(file);
                };
                reader.readAsDataURL(file);
            }
        });
    });

    // 加载个人信息
    function loadProfile() {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: '/api/student/profile',
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    const data = res.data;

                    // 更新基本信息
                    $('#userName').text(data.name);
                    if (data.avatar) {
                        $('#avatarPreview').attr('src', '/static/uploads/avatar/' + data.avatar);
                    }

                    // 更新详细信息
                    $('#info-name0').text(data.name || '未设置');
                    $('#info-name').text(data.name || '未设置');
                    $('#info-id').text(data.student_id || '未设置');
                    $('#info-phone').text(data.phone || '未设置');
                    $('#info-gender').text(data.gender || '未知');
                    // 邮箱已删除
                    $('#info-wallet').text('¥' + (data.wallet || '0.00'));

                    // 获取默认地址
                    $.ajax({
                        url: '/api/student/addresses',
                        type: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` },
                        success: function (addrRes) {
                            if (addrRes.code === 200) {
                                const defaultAddr = addrRes.data.find(addr => addr.is_default);
                                if (defaultAddr) {
                                    $('#info-address').text(`${defaultAddr.recipient} ${defaultAddr.phone} ${defaultAddr.full_address}`);
                                } else {
                                    $('#info-address').text('未设置');
                                }
                            } else {
                                $('#info-address').text('未设置');
                            }
                        },
                        error: function () {
                            $('#info-address').text('未设置');
                        }
                    });
                    // 注册时间
                    $('#info-register-time').text(data.register_time || '未知');

                    // 存储用户信息到本地
                    localStorage.setItem('userInfo', JSON.stringify(data));
                } else {
                    alert('获取用户信息失败：' + res.msg);
                }
            }
        });
    }

    // 上传头像
    function uploadAvatar(file) {
        const token = localStorage.getItem('student_token');
        const formData = new FormData();
        formData.append('avatar', file);

        $.ajax({
            url: '/api/student/avatar',
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.code === 200) {
                    alert('头像上传成功！');
                    // 关闭头像预览
                    $('#largeAvatarModal').modal('hide');
                } else {
                    alert('头像上传失败：' + res.msg);
                    // 恢复默认头像
                    $('#avatarPreview').attr('src', '/static/uploads/avatar/default_avatar.jpg');
                }
            },
            error: function () {
                alert('头像上传失败，请稍后重试');
                // 恢复默认头像
                $('#avatarPreview').attr('src', '/static/uploads/avatar/default_avatar.jpg');
            }
        });
    }

    // 加载地址列表
    function loadAddressList() {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: '/api/student/addresses',
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    renderAddressList(res.data);
                } else {
                    $('#addressList').html('\u003cdiv class="col-12 text-center text-muted"\u003e获取地址列表失败\u003c/div\u003e');
                }
            },
            error: function () {
                $('#addressList').html('\u003cdiv class="col-12 text-center text-muted"\u003e获取地址列表失败\u003c/div\u003e');
            }
        });
    }

    // 渲染地址列表
    function renderAddressList(addresses) {
        if (!addresses || addresses.length === 0) {
            $('#addressList').html('<div class="col-12 text-center text-muted">暂无收货地址，点击添加地址</div>');
            return;
        }

        let html = '';
        addresses.forEach(addr => {
            html += `
                    <div class="col-md-4 address-item ${addr.is_default ? 'default' : ''}">
                        <div class="address-actions">
                            ${!addr.is_default ? '<button class="btn btn-sm btn-outline-primary" onclick="setDefaultAddress(' + addr.id + ')">设为默认</button>' : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="editAddress(${addr.id})"><i class="bi bi-pencil"></i> 编辑</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress(${addr.id})"><i class="bi bi-trash"></i> 删除</button>
                        </div>
                        <h6 class="mb-1">${addr.recipient}</h6>
                        <p class="text-muted mb-2">${addr.phone}</p>
                        <p class="mb-0">${addr.full_address}</p>
                    </div>
                `;
        });

        $('#addressList').html(html);
    }

    // 编辑地址
    function editAddress(addressId) {
        const token = localStorage.getItem('student_token');
        // 从地址列表中查找
        $.ajax({
            url: '/api/student/addresses',
            type: 'GET',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    const addr = res.data.find(item => item.id === addressId);
                    if (addr) {
                        $('#address-id').val(addr.id);
                        $('#address-name').val(addr.recipient);
                        $('#address-phone').val(addr.phone);
                        // 设置省市区字段
                        $('#address-province').val(addr.province || '');
                        $('#address-city').val(addr.city || '');
                        $('#address-district').val(addr.district || '');
                        // 设置详细地址
                        $('#address-detail').val(addr.detail_address || '');
                        $('#address-default').prop('checked', addr.is_default);
                        $('#addressModalLabel').text('编辑收货地址');
                        $('#addressModal').modal('show');
                    } else {
                        alert('地址不存在');
                    }
                } else {
                    alert('获取地址列表失败：' + res.msg);
                }
            },
            error: function () {
                alert('网络错误，请重试');
            }
        });
    }

    // 添加地址
    function addAddress() {
        // 重置表单所有字段
        $('#address-id').val('');
        $('#address-name').val('');
        $('#address-phone').val('');
        $('#address-province').val('');
        $('#address-city').val('');
        $('#address-district').val('');
        $('#address-detail').val('');
        $('#address-default').prop('checked', false);

        // 设置模态框标题
        $('#addressModalLabel').text('添加收货地址');

        // 显示模态框
        $('#addressModal').modal('show');
    }

    // 保存地址
    function saveAddress() {
        const id = $('#address-id').val();
        const data = {
            recipient: $('#address-name').val().trim(),
            phone: $('#address-phone').val().trim(),
            province: $('#address-province').val().trim(),
            city: $('#address-city').val().trim(),
            district: $('#address-district').val().trim(),
            detail_address: $('#address-detail').val().trim(),
            is_default: $('#address-default').prop('checked')
        };

        // 简单验证
        if (!data.recipient || !data.phone || !data.province || !data.city || !data.district || !data.detail_address) {
            alert('请填写完整地址信息，包括省份、城市和区县');
            return;
        }

        // 验证手机号码格式
        if (!/^1[3-9]\d{9}$/.test(data.phone)) {
            alert('请输入正确的11位手机号码');
            return;
        }

        const token = localStorage.getItem('student_token');
        let url = '/api/student/addresses';
        let type = 'POST';

        if (id) {
            url = `/api/student/addresses/${id}`;
            type = 'PUT';
        }

        $.ajax({
            url: url,
            type: type,
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                if (res.code === 200) {
                    $('#addressModal').modal('hide');
                    loadAddressList();
                    loadProfile(); // 重新加载用户信息以更新默认地址显示
                    alert('地址保存成功！');
                } else {
                    alert('地址保存失败：' + res.msg);
                }
            },
            error: function () {
                alert('网络错误，请重试');
            }
        });
    }

    // 设置默认地址
    function setDefaultAddress(addressId) {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/addresses/${addressId}/default`,
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    loadAddressList();
                    loadProfile(); // 重新加载用户信息以更新默认地址显示
                    alert('设置默认地址成功！');
                } else {
                    alert('设置默认地址失败：' + res.msg);
                }
            },
            error: function () {
                alert('网络错误，请重试');
            }
        });
    }

    // 打开编辑信息模态框
    function openEditModal() {
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        $('#edit-name').val(userInfo.name || '');
        $('#edit-phone').val(userInfo.phone || '');
        // 邮箱输入已删除
        $('#edit-gender').val(userInfo.gender || '男');
        $('#editModal').modal('show');
    }

    // 保存用户信息
    function saveInfo() {
        const token = localStorage.getItem('student_token');
        const data = {
            name: $('#edit-name').val().trim(),
            phone: $('#edit-phone').val().trim(),
            // 邮箱字段已删除
            gender: $('#edit-gender').val().trim()
        };

        $.ajax({
            url: '/api/student/profile',
            type: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                if (res.code === 200) {
                    $('#editModal').modal('hide');
                    loadProfile();
                    alert('信息更新成功！');
                } else {
                    alert('信息更新失败：' + res.msg);
                }
            }
        });
    }

    // 打开修改密码模态框
    function changePassword() {
        $('#passwordModal').modal('show');
    }

    // 保存密码
    function savePassword() {
        const currentPassword = $('#current-password').val();
        const newPassword = $('#new-password').val();
        const confirmPassword = $('#confirm-password').val();

        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('请填写所有密码字段');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('两次输入的新密码不一致');
            return;
        }

        // 首先在前端进行基本验证
        if (newPassword.length < 8 || newPassword.length > 20) {
            alert('新密码长度需8-20位');
            return;
        }

        // 检查密码复杂度
        if (!(/[a-zA-Z]/.test(newPassword) && /[0-9]/.test(newPassword))) {
            alert('新密码必须包含字母和数字');
            return;
        }

        const token = localStorage.getItem('student_token');
        $.ajax({
            url: '/api/student/change-password',
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            contentType: 'application/json',
            data: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            }),
            success: function (res) {
                if (res.code === 200) {
                    $('#passwordModal').modal('hide');
                    $('#passwordForm')[0].reset();
                    $('#passwordError').hide();
                    alert('密码修改成功，请重新登录！');
                    localStorage.removeItem('student_token');
                    localStorage.removeItem('userInfo');
                    window.location.href = '/student/login';
                } else {
                    alert('密码修改失败：' + res.msg);
                }
            },
            error: function (xhr) {
                try {
                    const res = JSON.parse(xhr.responseText);
                    alert(res.msg || '网络错误，请稍后重试');
                } catch (e) {
                    alert('请求失败，请检查网络连接');
                }
            }
        });
    }

    // 添加地址
    function addAddress() {
        $('#address-id').val('');
        $('#addressForm')[0].reset();
        $('#addressModalLabel').text('添加收货地址');
        $('#addressModal').modal('show');
    }

    // 删除地址
    function deleteAddress(addressId) {
        if (!confirm('确定要删除该地址吗？')) return;

        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/addresses/${addressId}`,
            type: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    loadAddressList();
                    loadProfile(); // 重新加载用户信息以更新默认地址显示
                    alert('地址删除成功！');
                } else {
                    alert('地址删除失败：' + res.msg);
                }
            }
        });
    }

    // 绑定手机号
    function bindPhone() {
        alert('手机号绑定功能开发中...');
    }

    // 绑定邮箱
    function bindEmail() {
        alert('邮箱功能已移除');
    }

    // 设置默认地址
    function setDefaultAddress(addressId) {
        const token = localStorage.getItem('student_token');
        $.ajax({
            url: `/api/student/addresses/${addressId}/default`,
            type: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (res) {
                if (res.code === 200) {
                    loadAddressList();
                    loadProfile(); // 重新加载用户信息以更新默认地址显示
                    alert('设置成功！');
                } else {
                    alert('设置失败：' + res.msg);
                }
            },
            error: function () {
                alert('网络错误，请重试');
            }
        });
    }

    // 格式化日期
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 打开充值模态框
    function openRechargeModal() {
        $('#rechargeAmount').val('');
        $('#rechargeError').hide();

        // 获取并显示当前余额
        const currentWallet = parseFloat($('#info-wallet').text().replace('¥', ''));
        $('#currentBalance').text('¥' + currentWallet.toFixed(2));

        $('#rechargeModal').modal('show');
    }

    // 执行充值
    function doRecharge() {
        const amount = parseFloat($('#rechargeAmount').val().trim());

        // 验证输入（允许负数，用于调试）
        // if (isNaN(amount)) {

        // 验证输入
        if (isNaN(amount) || amount <= 0) {
            $('#rechargeError').text('请输入有效的充值金额').show();
            return;
        }

        if (amount > 10000) {
            $('#rechargeError').text('单次充值金额不能超过10000元').show();
            return;
        }

        // 调用后端API进行充值
        $.ajax({
            url: '/api/student/wallet/recharge',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ amount: amount }),
            success: function (response) {
                if (response.code === 200) {
                    // 更新前端钱包显示
                    $('#info-wallet').text('¥' + response.data.new_balance.toFixed(2));

                    // 更新本地存储的用户信息
                    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
                    userInfo.wallet = response.data.new_balance.toFixed(2);
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));

                    // 关闭模态框并显示成功提示
                    $('#rechargeModal').modal('hide');
                    alert(response.msg || '充值成功！钱包余额已更新。');
                } else {
                    $('#rechargeError').text(response.msg || '充值失败').show();
                }
            },
            error: function (xhr, status, error) {
                console.error('充值请求失败:', error);
                $('#rechargeError').text('网络错误，请稍后重试').show();
            }
        });
    }

    // 打开卡包
    function openWallet() {
        // 显示卡包模态框
        $('#walletModal').modal('show');
        // 加载优惠券列表
        loadCoupons();
    }

    // 加载优惠券列表
    function loadCoupons() {
        // 显示加载状态
        $('#couponList').html('<div class="text-center py-5"><i class="fa fa-spinner fa-spin mr-2"></i>正在加载优惠券...</div>');

        $.ajax({
            url: '/api/student/coupons',
            type: 'GET',
            cache: false,
            success: function (response) {
                if (response.code === 200 && response.data && response.data.length > 0) {
                    // 渲染优惠券列表
                    renderCoupons(response.data);
                } else {
                    // 显示无优惠券提示
                    $('#couponList').html('<div class="text-center py-5 text-muted"><i class="fa fa-gift" style="font-size: 2rem;"></i><p class="mt-2">暂无优惠券</p></div>');
                }
            },
            error: function (xhr, status, error) {
                console.error('加载优惠券失败:', error);
                $('#couponList').html('<div class="text-center py-5 text-danger"><i class="fa fa-exclamation-circle"></i><p class="mt-2">加载优惠券失败，请稍后重试</p></div>');
            }
        });
    }

    // 渲染优惠券列表
    function renderCoupons(coupons) {
        let html = '';
        coupons.forEach(function (coupon) {
            // 格式化过期日期
            const expireDate = new Date(coupon.expire_date).toLocaleDateString('zh-CN');

            html += `<div class="coupon-item mb-3 p-3 border rounded bg-white shadow-sm">
                        <div class="row align-items-center">
                            <div class="col-3 text-center">
                                <div class="coupon-amount">${coupon.type === '折扣' ? `${coupon.discount_amount}折` : `¥${coupon.discount_amount}`}</div>
                                <div class="coupon-condition">满¥${coupon.min_spend}可用</div>
                            </div>
                            <div class="col-7">
                                <div class="coupon-name">${coupon.name}</div>
                    <div class="coupon-type">${coupon.type === '折扣' ? '折扣券' : coupon.type === '满减' ? '满减券' : '无门槛券'}</div>
                    <div class="coupon-merchant">商家: ${coupon.merchant_name || '未知商家'}</div>
                    <div class="coupon-expire">有效期至: ${expireDate}</div>
                            </div>
                            <div class="col-2 text-center">
                                <button class="btn btn-sm btn-danger" onclick="deleteCoupon(${coupon.id})" title="删除优惠券">
                                    删除<i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
        });
        $('#couponList').html(html);
    }

    // 删除优惠券
    function deleteCoupon(couponId) {
        if (confirm('确定要删除此优惠券吗？')) {
            $.ajax({
                url: `/api/student/coupons/${couponId}`,
                type: 'DELETE',
                success: function (response) {
                    if (response.code === 200) {
                        alert('优惠券删除成功');
                        // 重新加载优惠券列表
                        loadCoupons();
                    } else {
                        alert(response.msg || '删除优惠券失败');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('删除优惠券失败:', error);
                    alert('网络错误，请稍后重试');
                }
            });
        }
    }

    // 检查支付密码状态
    function checkPayPasswordStatus() {
        $.ajax({
            url: '/api/student/check-pay-password',
            type: 'GET',
            success: function (response) {
                if (response.code === 200) {
                    if (response.data.has_pay_password) {
                        // 已有支付密码，跳转到修改页面
                        window.location.href = '/student/change-pay-password';
                    } else {
                        // 没有支付密码，跳转到设置初始支付密码页面
                        window.location.href = '/student/set-pay-password';
                    }
                } else {
                    alert(response.msg || '检查支付密码状态失败');
                }
            },
            error: function (xhr, status, error) {
                console.error('检查支付密码状态请求失败:', error);
                alert('网络错误，请稍后重试');
            }
        });
    }
</script>

<!-- 编辑信息模态框 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">编辑个人信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="edit-name" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="edit-name" placeholder="请输入姓名">
                    </div>
                    <div class="mb-3">
                        <label for="edit-phone" class="form-label">手机号</label>
                        <input type="tel" class="form-control" id="edit-phone" placeholder="请输入手机号">
                    </div>

                    <div class="mb-3">
                        <label for="edit-gender" class="form-label">性别</label>
                        <select class="form-select" id="edit-gender">
                            <option value="未知">未知</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveInfo()">保存修改</button>
            </div>
        </div>
    </div>
</div>

<!-- 修改密码模态框 -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">修改密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label for="current-password" class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="current-password" placeholder="请输入当前密码">
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="new-password" placeholder="请输入新密码">
                        <div class="form-text text-muted">密码长度至少8位，包含字母和数字</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm-password" class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirm-password" placeholder="请再次输入新密码">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePassword()">确认修改</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑地址模态框 -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressModalLabel">添加收货地址</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <input type="hidden" id="address-id">
                    <div class="mb-3">
                        <label for="address-name" class="form-label">收货人姓名</label>
                        <input type="text" class="form-control" id="address-name" placeholder="请输入收货人姓名">
                    </div>
                    <div class="mb-3">
                        <label for="address-phone" class="form-label">联系电话</label>
                        <input type="tel" class="form-control" id="address-phone" placeholder="请输入联系电话">
                    </div>
                    <div class="mb-3">
                        <label for="address-province" class="form-label">省份</label>
                        <input type="text" class="form-control" id="address-province" placeholder="请输入省份">
                    </div>
                    <div class="mb-3">
                        <label for="address-city" class="form-label">城市</label>
                        <input type="text" class="form-control" id="address-city" placeholder="请输入城市">
                    </div>
                    <div class="mb-3">
                        <label for="address-district" class="form-label">区县</label>
                        <input type="text" class="form-control" id="address-district" placeholder="请输入区县">
                    </div>
                    <div class="mb-3">
                        <label for="address-detail" class="form-label">详细地址</label>
                        <textarea class="form-control" id="address-detail" rows="3" placeholder="请输入详细地址"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="address-default">
                        <label class="form-check-label" for="address-default">设为默认地址</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAddress()">保存地址</button>
            </div>
        </div>
    </div>
</div>

<!-- 充值模态框 -->
<div class="modal fade" id="rechargeModal" tabindex="-1" aria-labelledby="rechargeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rechargeModalLabel">钱包充值</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rechargeAmount" class="form-label">充值金额</label>
                    <input type="number" class="form-control" id="rechargeAmount" placeholder="请输入充值金额" min="0.01"
                        step="0.01">
                    <div class="form-text text-muted">支持0.01元及以上金额充值</div>
                    <div id="rechargeError" class="text-danger mt-1" style="display: none;"></div>
                </div>
                <div class="alert alert-info mt-3">
                    <p class="mb-0"><i class="bi bi-info-circle"></i> 当前余额: <span id="currentBalance"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="doRecharge()">确认充值</button>
            </div>
        </div>
    </div>
</div>

<!-- 头像大图查看模态框 -->
<div class="modal fade" id="largeAvatarModal" tabindex="-1" aria-labelledby="largeAvatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="largeAvatarModalLabel">头像预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="largeAvatarImage" src="/static/uploads/avatar/default_avatar.jpg" alt="大头像"
                    style="max-width: 100%; max-height: 400px; object-fit: contain;">
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary change-avatar-btn">修改头像</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 卡包模态框 -->
<div class="modal fade" id="walletModal" tabindex="-1" aria-labelledby="walletModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="walletModalLabel">我的卡包</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 优惠券列表 -->
                <div class="mb-4">
                    <h6>我的优惠券</h6>
                    <div id="couponList" class="coupon-list">
                        <!-- 优惠券列表将通过 JavaScript 动态加载 -->
                        <div class="text-center py-5 text-muted">
                            <i class="fa fa-gift" style="font-size: 2rem;"></i>
                            <p class="mt-2">暂无优惠券</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 优惠券样式 */
    .coupon-item {
        transition: all 0.3s ease;
    }

    .coupon-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .coupon-amount {
        font-size: 1.8rem;
        font-weight: bold;
        color: #dc3545;
    }

    .coupon-condition {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .coupon-name {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 4px;
    }

    .coupon-type {
        font-size: 0.8rem;
        color: #0d6efd;
        margin-bottom: 2px;
    }

    .coupon-merchant {
        font-size: 0.8rem;
        color: #666;
        margin-top: 3px;
    }

    .coupon-expire {
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}